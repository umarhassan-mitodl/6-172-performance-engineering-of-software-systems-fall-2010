---
about_this_resource_text: '<p><strong>Description:</strong> Theory and background
  of profiling tools. Two interactive walkthroughs: matrix multiply and branchless
  sorting.</p> <p><strong>Speakers:</strong> Reid Kleckner, John Dong, Saman Amarasinghe</p>'
content_type: resource
course_id: 6-172-performance-engineering-of-software-systems-fall-2010
embedded_media:
- id: Video-InternetArchive-MP4
  media_location: http://www.archive.org/download/MIT6.172F10/MIT6_172_F10_lec05_300k.mp4
  parent_uid: 84db1d9f869f26ccf9f25c7528d921d4
  title: Video-Internet Archive-MP4
  type: Video
  uid: 0e1a4529e8e499ef7505d7bd119bb51c
- id: Video-iTunesU-MP4
  media_location: http://itunes.apple.com/us/itunes-u/lecture-5-performance-engineering/id481759887?i=109649107
  parent_uid: 84db1d9f869f26ccf9f25c7528d921d4
  title: Video-iTunes U-MP4
  type: Video
  uid: ff1d671bbd6783e001ace0dfa8ff000d
- id: Video-YouTube-Stream
  media_location: 7a89iFEEpTo
  parent_uid: 84db1d9f869f26ccf9f25c7528d921d4
  title: Video-YouTube-Stream
  type: Video
  uid: 65ec409eccfd48891581ddaf9be26e81
- id: Thumbnail-YouTube-JPG
  media_location: https://img.youtube.com/vi/7a89iFEEpTo/default.jpg
  parent_uid: 84db1d9f869f26ccf9f25c7528d921d4
  title: Thumbnail-YouTube-JPG
  type: Thumbnail
  uid: a69e87337fef527e438c41128c15564c
- id: MIT6_172F10_lec05.pdf
  parent_uid: 84db1d9f869f26ccf9f25c7528d921d4
  technical_location: https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-172-performance-engineering-of-software-systems-fall-2010/video-lectures/lecture-5-performance-engineering-with-profiling-tools/MIT6_172F10_lec05.pdf
  title: MIT6_172F10_lec05.pdf
  type: null
  uid: 1a3be8fa29e3cf18f98f891b9f093522
- id: 3Play-3PlayYouTubeid-MP4
  media_location: 7a89iFEEpTo
  parent_uid: 84db1d9f869f26ccf9f25c7528d921d4
  title: 3Play-3Play YouTube id
  type: 3Play
  uid: 4af4a99721c938ce3f9f521b5ba0ccc7
- id: 7a89iFEEpTo.srt
  parent_uid: 84db1d9f869f26ccf9f25c7528d921d4
  technical_location: https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-172-performance-engineering-of-software-systems-fall-2010/video-lectures/lecture-5-performance-engineering-with-profiling-tools/7a89iFEEpTo.srt
  title: 3play caption file
  type: null
  uid: 05962d7e5c2a59b079f1bf370769cc1a
- id: 7a89iFEEpTo.pdf
  parent_uid: 84db1d9f869f26ccf9f25c7528d921d4
  technical_location: https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-172-performance-engineering-of-software-systems-fall-2010/video-lectures/lecture-5-performance-engineering-with-profiling-tools/7a89iFEEpTo.pdf
  title: 3play pdf file
  type: null
  uid: be86bb552c4282c2714ae46db6bc83fa
- id: Caption-3Play YouTube id-SRT
  parent_uid: 84db1d9f869f26ccf9f25c7528d921d4
  title: Caption-3Play YouTube id-SRT-English - US
  type: Caption
  uid: 379efbb2eb3c7b52a7df2d1034e999f3
- id: Transcript-3Play YouTube id-PDF
  parent_uid: 84db1d9f869f26ccf9f25c7528d921d4
  title: Transcript-3Play YouTube id-PDF-English - US
  type: Transcript
  uid: be44a7fd975ef1aad5e99946a0a0eb57
file: null
file_size: null
hide_download: true
hide_download_original: null
inline_embed_id: 64249842lecture5:performanceengineeringwithprofilingtools39253841
layout: video
license: https://creativecommons.org/licenses/by-nc-sa/4.0/
order_index: 60
parent_uid: 24169d0487e846a39c316276f85b8cb5
related_resources_text: ''
short_url: lecture-5-performance-engineering-with-profiling-tools
technical_location: https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-172-performance-engineering-of-software-systems-fall-2010/video-lectures/lecture-5-performance-engineering-with-profiling-tools
title: 'Lecture 5: Performance Engineering with Profiling Tools'
transcript: '<p><span m=''2070''>The</span> <span m=''2190''>following</span> <span
  m=''2630''>content</span> <span m=''3230''>is</span> <span m=''3340''>provided</span>
  <span m=''3790''>under</span> <span m=''4070''>a</span> <span m=''4090''>Creative</span>
  <span m=''4500''>Commons</span> <span m=''4910''>license.</span> <span m=''5920''>Your</span>
  <span m=''6200''>support</span> <span m=''6700''>will</span> <span m=''6870''>help</span>
  <span m=''7100''>MIT</span> <span m=''7580''>OpenCourseWare</span> <span m=''8360''>continue</span>
  <span m=''8870''>to</span> <span m=''8950''>offer</span> <span m=''9380''>high-quality</span>
  <span m=''10120''>educational</span> <span m=''10740''>resources</span> <span m=''11390''>for</span>
  <span m=''11520''>free.</span> <span m=''12610''>To</span> <span m=''12730''>make</span>
  <span m=''12930''>a</span> <span m=''12980''>donation</span> <span m=''13620''>or</span>
  <span m=''13930''>view</span> <span m=''14340''>additional</span> <span m=''14800''>materials</span>
  <span m=''15340''>from</span> <span m=''15500''>hundreds</span> <span m=''15930''>of</span>
  <span m=''16040''>MIT</span> <span m=''16460''>courses,</span> <span m=''17490''>visit</span>
  <span m=''17790''>MIT</span> <span m=''18220''>OpenCourseWare</span> <span m=''19250''>at</span>
  <span m=''19430''>ocw.mit.edu.</span> </p><p><span m=''25716''>GUEST SPEAKER 1:
  All right.</span> <span m=''26180''>So</span> <span m=''26450''>we''re</span> <span
  m=''26590''>going</span> <span m=''26650''>to</span> <span m=''26710''>talk</span>
  <span m=''26900''>about</span> <span m=''27690''>performance</span> <span m=''28180''>engineering</span>
  <span m=''28690''>and</span> <span m=''28960''>pretty</span> <span m=''29100''>much</span>
  <span m=''29540''>how</span> <span m=''29680''>to</span> <span m=''29770''>do</span>
  <span m=''29920''>that</span> <span m=''30540''>with</span> <span m=''31120''>profiling</span>
  <span m=''31850''>tools.</span> <span m=''34262''>So</span> <span m=''34810''>first,</span>
  <span m=''34940''>we''re going to</span> <span m=''35250''>talk</span> <span m=''35430''>about</span>
  <span m=''36580''>what</span> <span m=''36720''>profiling</span> <span m=''37170''>tools</span>
  <span m=''37470''>are and</span> <span m=''38040''>how</span> <span m=''38190''>you</span>
  <span m=''38310''>use</span> <span m=''38520''>them in</span> <span m=''38810''>general,</span>
  <span m=''39270''>what</span> <span m=''39330''>the</span> <span m=''39420''>theory</span>
  <span m=''39730''>of that</span> <span m=''39970''>is.</span> <span m=''40550''>And</span>
  <span m=''40700''>then,</span> <span m=''41540''>more</span> <span m=''42060''>importantly,</span>
  <span m=''43030''>we''re</span> <span m=''43200''>going</span> <span m=''43280''>to</span>
  <span m=''43370''>do</span> <span m=''43710''>an</span> <span m=''43820''>interactive</span>
  <span m=''44280''>walk-through</span> <span m=''44990''>of</span> <span m=''45910''>two</span>
  <span m=''46100''>examples</span> <span m=''46550''>that</span> <span m=''46630''>we</span>
  <span m=''46740''>picked</span> <span m=''47030''>out.</span> <span m=''47230''>The</span>
  <span m=''47380''>first</span> <span m=''47630''>one</span> <span m=''47800''>is</span>
  <span m=''48070''>the</span> <span m=''48280''>Matrix</span> <span m=''48610''>Multiply</span>
  <span m=''49200''>that</span> <span m=''49340''>you</span> <span m=''49410''>guys</span>
  <span m=''49620''>saw in</span> <span m=''50000''>Project 0,</span> <span m=''51490''>the</span>
  <span m=''52530''>cache</span> <span m=''52830''>ratio</span> <span m=''53140''>measurements</span>
  <span m=''53930''>and</span> <span m=''54220''>how</span> <span m=''54350''>to</span>
  <span m=''54430''>do</span> <span m=''54560''>those</span> <span m=''54760''>measurements</span>
  <span m=''55330''>and</span> <span m=''55390''>how</span> <span m=''55600''>to</span>
  <span m=''55820''>do</span> <span m=''56020''>the</span> <span m=''57400''>cycles</span>
  <span m=''57830''>per</span> <span m=''57970''>instruction</span> <span m=''58400''>measurements,</span>
  <span m=''58810''>these</span> <span m=''58980''>kinds</span> <span m=''59200''>of</span>
  <span m=''59280''>things.</span> <span m=''60060''>And</span> <span m=''60260''>then</span>
  <span m=''61150''>we''re</span> <span m=''61300''>going to</span> <span m=''61360''>look</span>
  <span m=''61530''>at</span> <span m=''61930''>doing</span> <span m=''62330''>some</span>
  <span m=''62530''>of</span> <span m=''62580''>the</span> <span m=''62880''>bit</span>
  <span m=''63180''>hacks</span> <span m=''63450''>that</span> <span m=''63620''>Charles</span>
  <span m=''63900''>talked</span> <span m=''64120''>about</span> <span m=''64300''>in
  the</span> <span m=''64480''>second</span> <span m=''64769''>lecture.</span> <span
  m=''65750''>We''re</span> <span m=''65950''>going</span> <span m=''66040''>to</span>
  <span m=''66080''>work</span> <span m=''66300''>on</span> <span m=''67070''>a</span>
  <span m=''67260''>branchless</span> <span m=''67670''>sorting</span> <span m=''68020''>algorithm,</span>
  <span m=''68520''>which is</span> <span m=''68810''>pretty</span> <span m=''69280''>interesting.</span>
  </p><p><span m=''75360''>So</span> <span m=''78590''>the</span> <span m=''78990''>code</span>
  <span m=''79180''>we</span> <span m=''79240''>gave</span> <span m=''79440''>you
  in</span> <span m=''79570''>project</span> <span m=''79950''>one,</span> <span m=''82025''>it
  was</span> <span m=''82360''>very</span> <span m=''82510''>obvious</span> <span
  m=''82770''>where</span> <span m=''82870''>the</span> <span m=''82900''>hot</span>
  <span m=''83090''>spot</span> <span m=''83340''>was.</span> <span m=''84100''>But</span>
  <span m=''84310''>real</span> <span m=''84580''>life</span> <span m=''84680''>doesn''t</span>
  <span m=''84850''>really</span> <span m=''85000''>work</span> <span m=''85210''>that</span>
  <span m=''85390''>way.</span> <span m=''85750''>And</span> <span m=''87280''>code</span>
  <span m=''87490''>gets</span> <span m=''87650''>really,</span> <span m=''87780''>really</span>
  <span m=''87970''>big.</span> <span m=''91420''>It''s not</span> <span m=''91540''>always</span>
  <span m=''91860''>obvious</span> <span m=''92760''>where</span> <span m=''93100''>the</span>
  <span m=''93190''>part</span> <span m=''93410''>is</span> <span m=''93510''>that
  you</span> <span m=''93660''>want</span> <span m=''93790''>to</span> <span m=''93830''>optimize.</span>
  <span m=''94340''>And</span> <span m=''94400''>you</span> <span m=''94500''>really</span>
  <span m=''94680''>don''t</span> <span m=''94800''>want</span> <span m=''94900''>to</span>
  <span m=''94950''>waste</span> <span m=''95240''>time</span> <span m=''95930''>taking</span>
  <span m=''96540''>what is</span> <span m=''96770''>otherwise</span> <span m=''97330''>understandable,</span>
  <span m=''97960''>good</span> <span m=''98200''>code,</span> <span m=''98940''>and</span>
  <span m=''99450''>beating</span> <span m=''99720''>it</span> <span m=''99840''>over</span>
  <span m=''99950''>the</span> <span m=''100060''>head</span> <span m=''100310''>trying</span>
  <span m=''100460''>to</span> <span m=''100620''>make it go</span> <span m=''100820''>faster.</span>
  <span m=''102050''>So</span> <span m=''102200''>that''s</span> <span m=''102390''>why</span>
  <span m=''103010''>Donald Knuth</span> <span m=''103450''>said,</span> <span m=''103710''>&quot;premature</span>
  <span m=''104090''>optimization</span> <span m=''104640''>is</span> <span m=''104740''>the</span>
  <span m=''104810''>root</span> <span m=''104980''>of</span> <span m=''105060''>all</span>
  <span m=''105230''>evil.&quot;</span> <span m=''107000''>You</span> <span m=''107140''>really</span>
  <span m=''107270''>want</span> <span m=''107420''>to</span> <span m=''107460''>focus</span>
  <span m=''107920''>on</span> <span m=''108460''>the</span> <span m=''108510''>hot</span>
  <span m=''108790''>spots.</span> </p><p><span m=''110590''>So</span> <span m=''111020''>that''s</span>
  <span m=''111180''>what</span> <span m=''111230''>profiling''s</span> <span m=''111710''>for.
  It</span> <span m=''112070''>basically</span> <span m=''113430''>gives</span> <span
  m=''113630''>you</span> <span m=''113760''>visibility</span> <span m=''114390''>into</span>
  <span m=''114560''>the</span> <span m=''114660''>execution</span> <span m=''115130''>of</span>
  <span m=''115200''>your</span> <span m=''115300''>code,</span> <span m=''115510''>because</span>
  <span m=''115690''>it would</span> <span m=''115770''>be</span> <span m=''115850''>too</span>
  <span m=''116010''>complicated</span> <span m=''116540''>to just</span> <span m=''116680''>sit</span>
  <span m=''116920''>down</span> <span m=''117140''>and</span> <span m=''117200''>look</span>
  <span m=''117420''>at</span> <span m=''117600''>it</span> <span m=''118100''>and</span>
  <span m=''118210''>try</span> <span m=''118350''>to</span> <span m=''118400''>understand</span>
  <span m=''119880''>where it''s</span> <span m=''120070''>spending</span> <span m=''120350''>its</span>
  <span m=''120490''>time.</span> <span m=''124110''>And</span> <span m=''125390''>there</span>
  <span m=''125570''>are</span> <span m=''125600''>many</span> <span m=''125800''>possibilities</span>
  <span m=''126720''>for</span> <span m=''126870''>where it</span> <span m=''127110''>could</span>
  <span m=''127150''>be</span> <span m=''127320''>spending</span> <span m=''127440''>its</span>
  <span m=''127560''>time.</span> </p><p><span m=''127900''>In</span> <span m=''128259''>6-172</span>
  <span m=''128940''>we''re</span> <span m=''129009''>mostly</span> <span m=''129370''>going
  to be</span> <span m=''129490''>focusing</span> <span m=''129949''>on</span> <span
  m=''131240''>things</span> <span m=''131560''>that are</span> <span m=''131720''>CPU-bound</span>
  <span m=''132720''>and</span> <span m=''132900''>things</span> <span m=''133130''>that</span>
  <span m=''133230''>are</span> <span m=''133980''>using</span> <span m=''134270''>the</span>
  <span m=''134340''>memory</span> <span m=''134590''>hierarchy</span> <span m=''134890''>ineffectively.</span>
  <span m=''136830''>But</span> <span m=''137520''>in</span> <span m=''138030''>the</span>
  <span m=''138100''>real</span> <span m=''138280''>world,</span> <span m=''139110''>a</span>
  <span m=''139320''>couple</span> <span m=''139590''>of other</span> <span m=''139740''>common</span>
  <span m=''140050''>things</span> <span m=''140410''>are</span> <span m=''141640''>network</span>
  <span m=''142290''>requests.</span> <span m=''142730''>So</span> <span m=''142860''>if</span>
  <span m=''142920''>you''ve</span> <span m=''143060''>got</span> <span m=''143220''>your</span>
  <span m=''143300''>web</span> <span m=''143490''>application,</span> <span m=''143845''>it''s</span>
  <span m=''144200''>making</span> <span m=''144380''>a</span> <span m=''144460''>whole</span>
  <span m=''144590''>bunch</span> <span m=''144780''>of</span> <span m=''144870''>AJAX</span>
  <span m=''145260''>requests.</span> <span m=''146450''>It''s</span> <span m=''146530''>going
  to</span> <span m=''146610''>be</span> <span m=''146690''>wasting</span> <span m=''147000''>a</span>
  <span m=''147060''>lot</span> <span m=''147270''>of</span> <span m=''147390''>your</span>
  <span m=''147620''>users''</span> <span m=''148080''>time.</span> <span m=''149870''>If</span>
  <span m=''150070''>you''ve</span> <span m=''150180''>got</span> <span m=''150310''>your</span>
  <span m=''150380''>desktop</span> <span m=''150790''>application,</span> <span m=''151340''>it''s</span>
  <span m=''151450''>hitting</span> <span m=''151630''>the</span> <span m=''151690''>disk</span>
  <span m=''151940''>all</span> <span m=''152050''>the</span> <span m=''152110''>time.</span>
  <span m=''152390''>That''s</span> <span m=''152560''>also</span> <span m=''152770''>going</span>
  <span m=''152850''>to</span> <span m=''152910''>slow you</span> <span m=''153210''>down.</span>
  <span m=''154320''>I</span> <span m=''154410''>think</span> <span m=''155090''>SQL</span>
  <span m=''155280''>database,</span> <span m=''155480''>if</span> <span m=''155540''>anybody''s</span>
  <span m=''155900''>ever</span> <span m=''156050''>done</span> <span m=''156180''>web</span>
  <span m=''156360''>development,</span> <span m=''157650''>they</span> <span m=''157770''>know</span>
  <span m=''157930''>that</span> <span m=''158120''>can</span> <span m=''158220''>be</span>
  <span m=''158330''>a</span> <span m=''158380''>huge</span> <span m=''158610''>bottleneck.</span>
  </p><p><span m=''162570''>So</span> <span m=''163480''>basically,</span> <span m=''164130''>the</span>
  <span m=''164430''>tool</span> <span m=''164630''>that you''re</span> <span m=''164800''>going</span>
  <span m=''164910''>to</span> <span m=''164950''>use</span> <span m=''165200''>is</span>
  <span m=''165280''>going</span> <span m=''165390''>to</span> <span m=''165620''>depend</span>
  <span m=''166480''>a</span> <span m=''166570''>lot</span> <span m=''166940''>on</span>
  <span m=''167170''>what</span> <span m=''167450''>the</span> <span m=''167540''>problem</span>
  <span m=''167960''>you''re</span> <span m=''168080''>solving</span> <span m=''168440''>is.</span>
  <span m=''169800''>But</span> <span m=''170040''>the</span> <span m=''170440''>basic</span>
  <span m=''170720''>ideas</span> <span m=''171010''>are</span> <span m=''171130''>all</span>
  <span m=''171200''>the</span> <span m=''171270''>same.</span> <span m=''171570''>There</span>
  <span m=''171840''>are</span> <span m=''172030''>all</span> <span m=''172200''>kinds</span>
  <span m=''172400''>of</span> <span m=''172470''>profiling</span> <span m=''172880''>tools</span>
  <span m=''173260''>for</span> <span m=''174160''>measuring</span> <span m=''174550''>these</span>
  <span m=''174710''>things</span> <span m=''175390''>and</span> <span m=''175620''>figuring</span>
  <span m=''175940''>out</span> <span m=''176950''>where</span> <span m=''177090''>it''s</span>
  <span m=''177210''>coming</span> <span m=''177460''>from and</span> <span m=''177710''>where</span>
  <span m=''177890''>the</span> <span m=''177970''>time''s</span> <span m=''178260''>going.</span>
  </p><p><span m=''181690''>So</span> <span m=''182410''>for</span> <span m=''184060''>trying</span>
  <span m=''184200''>to</span> <span m=''184260''>figure</span> <span m=''184480''>out</span>
  <span m=''184890''>CPU</span> <span m=''185010''>and</span> <span m=''185140''>memory,</span>
  <span m=''185400''>there''s</span> <span m=''185520''>a</span> <span m=''185910''>couple</span>
  <span m=''186110''>things</span> <span m=''186260''>you</span> <span m=''186340''>can</span>
  <span m=''186420''>do.</span> <span m=''186570''>The</span> <span m=''186800''>first</span>
  <span m=''187030''>and</span> <span m=''187290''>most</span> <span m=''187500''>basic</span>
  <span m=''188300''>and</span> <span m=''188490''>sort</span> <span m=''188640''>of</span>
  <span m=''188990''>most</span> <span m=''189180''>obvious</span> <span m=''189480''>to</span>
  <span m=''189580''>you</span> <span m=''189700''>guys</span> <span m=''190030''>is</span>
  <span m=''190390''>you</span> <span m=''190490''>can</span> <span m=''191040''>do</span>
  <span m=''191230''>manual</span> <span m=''191550''>instrumentation.</span> <span
  m=''192480''>And</span> <span m=''192910''>what that</span> <span m=''193130''>is
  is</span> <span m=''193330''>basically</span> <span m=''193730''>where</span> <span
  m=''193900''>you</span> <span m=''193990''>go</span> <span m=''194240''>in</span>
  <span m=''194510''>and</span> <span m=''195160''>you</span> <span m=''195390''>put</span>
  <span m=''195590''>in</span> <span m=''195960''>prints</span> <span m=''196370''>and</span>
  <span m=''196470''>try</span> <span m=''196620''>to</span> <span m=''196680''>figure</span>
  <span m=''196950''>out</span> <span m=''197120''>where</span> <span m=''197280''>it''s</span>
  <span m=''197410''>spending</span> <span m=''197540''>its</span> <span m=''197700''>time,</span>
  <span m=''198230''>what</span> <span m=''198370''>codes</span> <span m=''198690''>could</span>
  <span m=''198710''>you have executed</span> <span m=''199120''>more.</span> </p><p><span
  m=''200610''>Or</span> <span m=''201910''>you</span> <span m=''202020''>can</span>
  <span m=''202140''>be a</span> <span m=''202410''>little bit</span> <span m=''202500''>more</span>
  <span m=''202660''>clever.</span> <span m=''202960''>You</span> <span m=''203050''>can</span>
  <span m=''203160''>try</span> <span m=''203310''>to</span> <span m=''203370''>insert</span>
  <span m=''205120''>logging</span> <span m=''205520''>calls</span> <span m=''206630''>that</span>
  <span m=''206700''>fill</span> <span m=''206980''>up a</span> <span m=''207060''>buffer</span>
  <span m=''207480''>with</span> <span m=''208210''>checking</span> <span m=''208570''>the</span>
  <span m=''208660''>time</span> <span m=''209100''>and</span> <span m=''209170''>actually</span>
  <span m=''209840''>doing</span> <span m=''210060''>that</span> <span m=''210250''>yourself.</span>
  <span m=''212180''>And</span> <span m=''212360''>one</span> <span m=''212850''>of
  the</span> <span m=''213340''>big</span> <span m=''213530''>advantages</span> <span
  m=''214010''>of</span> <span m=''214090''>that</span> <span m=''214390''>is</span>
  <span m=''214550''>that,</span> <span m=''215420''>when</span> <span m=''215540''>you</span>
  <span m=''215620''>actually</span> <span m=''215890''>go</span> <span m=''216070''>into</span>
  <span m=''216170''>the</span> <span m=''216270''>code</span> <span m=''216620''>and</span>
  <span m=''216760''>you</span> <span m=''216860''>instrument</span> <span m=''217240''>yourself,</span>
  <span m=''218100''>you</span> <span m=''218590''>can</span> <span m=''219410''>cut</span>
  <span m=''219620''>down</span> <span m=''219880''>the</span> <span m=''219960''>information</span>
  <span m=''220480''>that''s</span> <span m=''220550''>coming</span> <span m=''220700''>back</span>
  <span m=''220910''>out</span> <span m=''221110''>at</span> <span m=''221460''>you.</span>
  <span m=''221830''>If</span> <span m=''221950''>you</span> <span m=''222040''>have</span>
  <span m=''222140''>an</span> <span m=''222200''>intuition</span> <span m=''222700''>for</span>
  <span m=''222830''>how</span> <span m=''222960''>the</span> <span m=''223050''>program</span>
  <span m=''223430''>works,</span> <span m=''224630''>sprinkling</span> <span m=''225010''>little</span>
  <span m=''225290''>calls</span> <span m=''225720''>to</span> <span m=''225840''>timing</span>
  <span m=''226190''>functions</span> <span m=''227040''>around</span> <span m=''227200''>your</span>
  <span m=''227410''>code</span> <span m=''227710''>in</span> <span m=''227960''>the</span>
  <span m=''228270''>places</span> <span m=''228700''>that</span> <span m=''228830''>you</span>
  <span m=''228930''>think</span> <span m=''229220''>matter</span> <span m=''230750''>is</span>
  <span m=''230890''>going</span> <span m=''231090''>to</span> <span m=''231130''>give</span>
  <span m=''231340''>you</span> <span m=''231710''>maybe</span> <span m=''231940''>a</span>
  <span m=''231980''>better</span> <span m=''232200''>picture.</span> <span m=''233580''>But</span>
  <span m=''233780''>it</span> <span m=''233830''>requires</span> <span m=''234120''>more
  work</span> <span m=''234430''>on</span> <span m=''234490''>your</span> <span m=''234600''>part.</span>
  <span m=''235410''>So</span> <span m=''235990''>that''s</span> <span m=''236350''>the</span>
  <span m=''236430''>drawback.</span> </p><p><span m=''238210''>The</span> <span m=''238450''>other
  kind</span> <span m=''238780''>of</span> <span m=''239060''>instrumentation</span>
  <span m=''239340''>is</span> <span m=''240050''>static</span> <span m=''240370''>instrumentation,</span>
  <span m=''241520''>which</span> <span m=''241870''>is</span> <span m=''242630''>basically--</span>
  <span m=''243250''>and I</span> <span m=''243330''>should</span> <span m=''243530''>say</span>
  <span m=''243640''>that</span> <span m=''243770''>instrumentation</span> <span m=''244420''>is</span>
  <span m=''244520''>basically</span> <span m=''244890''>a little</span> <span m=''245260''>snippet</span>
  <span m=''245590''>of</span> <span m=''245670''>code</span> <span m=''246390''>that</span>
  <span m=''246770''>is</span> <span m=''247300''>gathering</span> <span m=''247700''>information,</span>
  <span m=''248190''>gathering</span> <span m=''248560''>data</span> <span m=''249300''>about</span>
  <span m=''249800''>the</span> <span m=''249880''>code</span> <span m=''250070''>execution.</span>
  <span m=''251930''>So</span> <span m=''251980''>static</span> <span m=''252250''>instrumentation</span>
  <span m=''252800''>is</span> <span m=''252880''>basically</span> <span m=''253210''>code</span>
  <span m=''253490''>that''s</span> <span m=''253640''>inserted</span> <span m=''254020''>by</span>
  <span m=''254150''>the</span> <span m=''254240''>compiler</span> <span m=''255320''>when</span>
  <span m=''255590''>you</span> <span m=''255690''>build</span> <span m=''255910''>your</span>
  <span m=''256040''>code.</span> <span m=''257100''>And</span> <span m=''257350''>gprof</span>
  <span m=''257589''>is</span> <span m=''257700''>an</span> <span m=''257779''>example</span>
  <span m=''258170''>of</span> <span m=''258420''>this.</span> <span m=''259230''>Basically,</span>
  <span m=''259610''>what</span> <span m=''259720''>it</span> <span m=''259820''>does</span>
  <span m=''260170''>is</span> <span m=''260579''>it</span> <span m=''260810''>will,</span>
  <span m=''261279''>at</span> <span m=''261500''>the</span> <span m=''261660''>prologue</span>
  <span m=''262100''>and</span> <span m=''262300''>the</span> <span m=''262500''>epilogue</span>
  <span m=''262960''>for</span> <span m=''263090''>every</span> <span m=''263290''>function,</span>
  <span m=''263840''>insert</span> <span m=''264290''>a</span> <span m=''264380''>little</span>
  <span m=''264590''>piece</span> <span m=''264760''>of</span> <span m=''264810''>code</span>
  <span m=''265130''>that</span> <span m=''265260''>increments</span> <span m=''265670''>a</span>
  <span m=''265720''>counter</span> <span m=''266030''>every</span> <span m=''266220''>time</span>
  <span m=''266390''>the</span> <span m=''266470''>function</span> <span m=''266760''>gets</span>
  <span m=''266910''>executed.</span> <span m=''268686''>I</span> <span m=''269150''>think
  it</span> <span m=''269300''>also</span> <span m=''269660''>figures</span> <span
  m=''269930''>out</span> <span m=''270080''>who</span> <span m=''270200''>called</span>
  <span m=''270450''>it,</span> <span m=''270570''>that</span> <span m=''270710''>kind</span>
  <span m=''270830''>of</span> <span m=''270890''>thing.</span> </p><p><span m=''272840''>One</span>
  <span m=''272970''>of</span> <span m=''273010''>the</span> <span m=''273050''>drawbacks</span>
  <span m=''273430''>to</span> <span m=''273530''>static</span> <span m=''273810''>instrumentation</span>
  <span m=''274420''>is</span> <span m=''274520''>that</span> <span m=''274860''>you</span>
  <span m=''275150''>have</span> <span m=''275510''>to</span> <span m=''276440''>have</span>
  <span m=''276530''>the</span> <span m=''276590''>source,</span> <span m=''276960''>and</span>
  <span m=''277040''>you</span> <span m=''277130''>have</span> <span m=''277230''>to
  be able to</span> <span m=''277470''>rebuild</span> <span m=''277810''>your</span>
  <span m=''277900''>project.</span> <span m=''278960''>If</span> <span m=''279160''>you''ve</span>
  <span m=''279480''>ever</span> <span m=''280100''>had</span> <span m=''280280''>a</span>
  <span m=''280470''>DLL</span> <span m=''282580''>binary</span> <span m=''282870''>blob</span>
  <span m=''283140''>of</span> <span m=''283210''>data</span> <span m=''283820''>library</span>
  <span m=''284230''>handed</span> <span m=''284520''>to</span> <span m=''284630''>you,</span>
  <span m=''285210''>and</span> <span m=''285570''>you</span> <span m=''285660''>want</span>
  <span m=''285780''>to</span> <span m=''285840''>know</span> <span m=''286290''>where</span>
  <span m=''286480''>the</span> <span m=''286560''>time''s</span> <span m=''286820''>going</span>
  <span m=''286990''>in</span> <span m=''287080''>that</span> <span m=''287300''>library,</span>
  <span m=''288510''>you''re</span> <span m=''288660''>not</span> <span m=''288880''>going
  to be able to</span> <span m=''289110''>instrument</span> <span m=''289480''>it.</span>
  <span m=''290010''>So</span> <span m=''290140''>you''re</span> <span m=''290220''>not</span>
  <span m=''290340''>going</span> <span m=''290450''>to</span> <span m=''290570''>get
  any</span> <span m=''290690''>data.</span> </p><p><span m=''292550''>So</span> <span
  m=''293030''>that</span> <span m=''293180''>brings</span> <span m=''293360''>us</span>
  <span m=''293440''>to the</span> <span m=''293570''>next</span> <span m=''293750''>thing,</span>
  <span m=''293870''>which</span> <span m=''293980''>is</span> <span m=''294060''>dynamic</span>
  <span m=''294340''>instrumentation,</span> <span m=''294940''>which</span> <span
  m=''295080''>solves</span> <span m=''295340''>that</span> <span m=''295510''>problem.</span>
  <span m=''297430''>Basically, what</span> <span m=''297750''>happens</span> <span
  m=''298060''>there</span> <span m=''298350''>is</span> <span m=''299280''>you</span>
  <span m=''299350''>take</span> <span m=''299540''>the</span> <span m=''299620''>binary</span>
  <span m=''300000''>as</span> <span m=''300210''>it</span> <span m=''300290''>is</span>
  <span m=''301680''>just</span> <span m=''301820''>before you''re</span> <span m=''302070''>about</span>
  <span m=''302230''>to</span> <span m=''302340''>run</span> <span m=''302490''>it.</span>
  <span m=''302990''>And</span> <span m=''303260''>before you</span> <span m=''303480''>start</span>
  <span m=''303690''>executing,</span> <span m=''303965''>you</span> <span m=''304240''>actually</span>
  <span m=''304550''>just</span> <span m=''305150''>take</span> <span m=''305340''>a</span>
  <span m=''305380''>look</span> <span m=''305450''>at</span> <span m=''305520''>the</span>
  <span m=''305600''>code</span> <span m=''305900''>and</span> <span m=''305990''>translate</span>
  <span m=''306450''>it.</span> <span m=''306570''>And</span> <span m=''306720''>you</span>
  <span m=''306870''>go</span> <span m=''307090''>in,</span> <span m=''307200''>and
  you</span> <span m=''307330''>insert</span> <span m=''307670''>the</span> <span
  m=''307730''>instrumentation.</span> <span m=''308440''>And</span> <span m=''308520''>then
  you</span> <span m=''308600''>have</span> <span m=''308770''>this</span> <span m=''308990''>new</span>
  <span m=''309180''>snippet</span> <span m=''309490''>of</span> <span m=''309580''>code</span>
  <span m=''310110''>that</span> <span m=''310250''>you</span> <span m=''310340''>then</span>
  <span m=''310500''>run</span> <span m=''310740''>instead.</span> <span m=''312450''>And</span>
  <span m=''312710''>so</span> <span m=''313140''>that</span> <span m=''313360''>works</span>
  <span m=''313780''>for</span> <span m=''314590''>binary</span> <span m=''314980''>blobs.</span>
  <span m=''316270''>And it</span> <span m=''316550''>doesn''t</span> <span m=''316720''>require</span>
  <span m=''317060''>a recompile,</span> <span m=''317540''>which</span> <span m=''317670''>is</span>
  <span m=''317770''>great.</span> </p><p><span m=''318500''>But</span> <span m=''319880''>it</span>
  <span m=''320450''>introduces</span> <span m=''321000''>a</span> <span m=''321110''>lot</span>
  <span m=''321720''>of</span> <span m=''321840''>overhead,</span> <span m=''323090''>because</span>
  <span m=''323510''>you''re</span> <span m=''323610''>not</span> <span m=''323750''>actually</span>
  <span m=''324010''>running</span> <span m=''324250''>the</span> <span m=''324370''>original</span>
  <span m=''324650''>code,</span> <span m=''324910''>right?</span> <span m=''327560''>You''re</span>
  <span m=''327850''>running</span> <span m=''328640''>this</span> <span m=''329010''>translated</span>
  <span m=''329335''>thing,</span> <span m=''329660''>which</span> <span m=''329790''>might</span>
  <span m=''329960''>be</span> <span m=''330070''>much</span> <span m=''330270''>more</span>
  <span m=''330450''>inefficient.</span> <span m=''333802''>And</span> <span m=''334290''>I</span>
  <span m=''334420''>guess</span> <span m=''334850''>Valgrind</span> <span m=''335570''>has</span>
  <span m=''335820''>a</span> <span m=''335990''>couple</span> <span m=''336250''>of</span>
  <span m=''336330''>tools</span> <span m=''336690''>that</span> <span m=''336780''>are</span>
  <span m=''337210''>sort</span> <span m=''337410''>of</span> <span m=''337530''>classic</span>
  <span m=''337830''>examples</span> <span m=''338240''>of</span> <span m=''338320''>that,</span>
  <span m=''338610''>Callgrind</span> <span m=''339340''>and</span> <span m=''339420''>Cachegrind.</span>
  <span m=''340270''>I think</span> <span m=''340400''>Callgrind</span> <span m=''340850''>gives</span>
  <span m=''340990''>you</span> <span m=''341140''>a</span> <span m=''341190''>call</span>
  <span m=''341420''>graph.</span> <span m=''341870''>And</span> <span m=''342640''>Cachegrind</span>
  <span m=''343980''>tries</span> <span m=''344190''>to</span> <span m=''344280''>measure</span>
  <span m=''344650''>the</span> <span m=''344860''>cache</span> <span m=''345120''>effects,</span>
  <span m=''346840''>tries</span> <span m=''347080''>to</span> <span m=''347450''>make</span>
  <span m=''347660''>a</span> <span m=''347710''>prediction</span> <span m=''348150''>of</span>
  <span m=''348910''>when</span> <span m=''349080''>you</span> <span m=''349150''>do</span>
  <span m=''349280''>memory</span> <span m=''349530''>accesses,</span> <span m=''350010''>are</span>
  <span m=''350140''>these</span> <span m=''350310''>things</span> <span m=''350520''>in</span>
  <span m=''350610''>cache</span> <span m=''350940''>or</span> <span m=''351010''>not.</span>
  </p><p><span m=''353780''>Another</span> <span m=''353870''>thing</span> <span m=''353970''>you</span>
  <span m=''354040''>might</span> <span m=''354190''>want</span> <span m=''354270''>to</span>
  <span m=''354310''>look</span> <span m=''354510''>at,</span> <span m=''354950''>or</span>
  <span m=''356050''>the</span> <span m=''356070''>thing that</span> <span m=''356250''>we''re</span>
  <span m=''356400''>going</span> <span m=''356480''>to</span> <span m=''356520''>focus</span>
  <span m=''356830''>on in</span> <span m=''356980''>this</span> <span m=''357110''>course</span>
  <span m=''357410''>are</span> <span m=''357770''>performance</span> <span m=''358100''>counters.</span>
  <span m=''359880''>And</span> <span m=''360670''>two</span> <span m=''360760''>tools
  to get</span> <span m=''361210''>these</span> <span m=''361420''>are</span> <span
  m=''361880''>OProfile</span> <span m=''362370''>and perf.</span> <span m=''363120''>And</span>
  <span m=''363550''>basically,</span> <span m=''364140''>the</span> <span m=''364530''>CPU</span>
  <span m=''364940''>has</span> <span m=''366900''>a</span> <span m=''366960''>bunch</span>
  <span m=''367140''>of</span> <span m=''367190''>counters--</span> <span m=''367490''>we''ve</span>
  <span m=''367590''>talked</span> <span m=''367820''>about</span> <span m=''368030''>them--</span>
  <span m=''368140''>for</span> <span m=''368260''>branch</span> <span m=''368580''>misses,</span>
  <span m=''368900''>cache</span> <span m=''369140''>misses,</span> <span m=''369400''>these</span>
  <span m=''369530''>kinds</span> <span m=''369640''>of</span> <span m=''369730''>things.</span>
  <span m=''370140''>And</span> <span m=''370490''>this</span> <span m=''370910''>will</span>
  <span m=''370990''>give</span> <span m=''371530''>access</span> <span m=''371810''>to</span>
  <span m=''371920''>those.</span> </p><p><span m=''373222''>The</span> <span m=''373690''>last</span>
  <span m=''374000''>tool that</span> <span m=''374430''>I</span> <span m=''374490''>guess</span>
  <span m=''374660''>I''m</span> <span m=''374860''>going to talk about for</span>
  <span m=''375350''>profiling</span> <span m=''375820''>is</span> <span m=''377020''>heap</span>
  <span m=''377330''>profiling.</span> <span m=''377650''>A</span> <span m=''377710''>lot</span>
  <span m=''377880''>of</span> <span m=''377930''>times,</span> <span m=''379260''>if</span>
  <span m=''379520''>memory''s</span> <span m=''379860''>your</span> <span m=''379930''>problem,</span>
  <span m=''380910''>you</span> <span m=''381070''>really</span> <span m=''381210''>want</span>
  <span m=''381330''>to</span> <span m=''381370''>figure</span> <span m=''381660''>out</span>
  <span m=''382070''>who''s</span> <span m=''382440''>doing all the</span> <span m=''382780''>allocation.</span>
  <span m=''383670''>And</span> <span m=''383790''>so</span> <span m=''385390''>these</span>
  <span m=''385540''>tools</span> <span m=''385760''>will</span> <span m=''385830''>give</span>
  <span m=''385970''>you</span> <span m=''386080''>a nice</span> <span m=''386480''>breakdown</span>
  <span m=''386720''>of</span> <span m=''388340''>who''s</span> <span m=''388520''>allocating</span>
  <span m=''388930''>what,</span> <span m=''389280''>who''s</span> <span m=''389490''>calling</span>
  <span m=''389800''>them,</span> <span m=''390840''>and</span> <span m=''391160''>who</span>
  <span m=''391300''>can</span> <span m=''391450''>I</span> <span m=''391530''>stop</span>
  <span m=''391800''>calling</span> <span m=''392360''>so</span> <span m=''392540''>that</span>
  <span m=''392820''>I''m allocating</span> <span m=''393080''>less</span> <span m=''393290''>memory.</span>
  <span m=''395110''>And</span> <span m=''396015''>like</span> <span m=''396280''>I</span>
  <span m=''396550''>said,</span> <span m=''396650''>you can</span> <span m=''396820''>find</span>
  <span m=''397020''>more</span> <span m=''397180''>tools</span> <span m=''397560''>for</span>
  <span m=''400030''>profiling</span> <span m=''400500''>different</span> <span m=''400700''>kinds</span>
  <span m=''400900''>of</span> <span m=''400960''>problems</span> <span m=''401350''>and</span>
  <span m=''401510''>resources.</span> </p><p><span m=''402630''>But</span> <span
  m=''402860''>today</span> <span m=''403030''>we''re</span> <span m=''403140''>mostly</span>
  <span m=''403440''>going to</span> <span m=''403500''>focus</span> <span m=''403830''>on</span>
  <span m=''404020''>perf,</span> <span m=''404850''>which</span> <span m=''405080''>is</span>
  <span m=''405650''>a</span> <span m=''405730''>new</span> <span m=''405860''>tool</span>
  <span m=''406180''>for</span> <span m=''408160''>getting</span> <span m=''408320''>access</span>
  <span m=''408650''>to</span> <span m=''409090''>performance</span> <span m=''409450''>counters
  on</span> <span m=''409920''>Linux.</span> <span m=''412030''>I</span> <span m=''412100''>guess</span>
  <span m=''412370''>I</span> <span m=''412480''>should</span> <span m=''412640''>also</span>
  <span m=''412960''>mention</span> <span m=''413360''>that,</span> <span m=''415000''>as</span>
  <span m=''415170''>someone</span> <span m=''415440''>talked</span> <span m=''415650''>about</span>
  <span m=''415870''>in the</span> <span m=''415960''>last</span> <span m=''416250''>lecture,</span>
  <span m=''416640''>the</span> <span m=''416780''>way</span> <span m=''417000''>that</span>
  <span m=''417300''>you</span> <span m=''417450''>want</span> <span m=''417720''>to</span>
  <span m=''417860''>gather</span> <span m=''418210''>data</span> <span m=''418410''>from</span>
  <span m=''418550''>performance</span> <span m=''418950''>counters is</span> <span
  m=''419350''>you</span> <span m=''419470''>want</span> <span m=''419570''>to</span>
  <span m=''419610''>do</span> <span m=''419760''>event</span> <span m=''419980''>sampling.</span>
  <span m=''422570''>There''s</span> <span m=''422760''>too</span> <span m=''422870''>much</span>
  <span m=''423060''>data.</span> <span m=''424670''>As</span> <span m=''424800''>you</span>
  <span m=''424930''>execute</span> <span m=''425240''>along,</span> <span m=''425530''>you</span>
  <span m=''425630''>don''t</span> <span m=''425810''>want</span> <span m=''425980''>to</span>
  <span m=''426040''>record,</span> <span m=''426850''>OK,</span> <span m=''427280''>I</span>
  <span m=''427570''>executed</span> <span m=''427910''>this</span> <span m=''428090''>instruction,</span>
  <span m=''428580''>then</span> <span m=''428660''>I executed</span> <span m=''428980''>that</span>
  <span m=''429190''>instruction,</span> <span m=''429770''>and</span> <span m=''430640''>I''m</span>
  <span m=''430740''>going</span> <span m=''430820''>to</span> <span m=''430870''>count</span>
  <span m=''431150''>all</span> <span m=''431400''>the</span> <span m=''431670''>instruction</span>
  <span m=''432080''>executions</span> <span m=''432650''>and</span> <span m=''432730''>then</span>
  <span m=''433110''>store</span> <span m=''433350''>that</span> <span m=''433510''>data</span>
  <span m=''433710''>somewhere.</span> <span m=''434410''>That would</span> <span
  m=''434470''>be</span> <span m=''434560''>way</span> <span m=''434680''>too</span>
  <span m=''434810''>much</span> <span m=''434970''>data.</span> </p><p><span m=''436040''>So</span>
  <span m=''436270''>what</span> <span m=''436360''>you</span> <span m=''436450''>want</span>
  <span m=''436620''>to</span> <span m=''436670''>do</span> <span m=''437020''>is</span>
  <span m=''437550''>you</span> <span m=''437660''>want</span> <span m=''437920''>to</span>
  <span m=''438900''>sample</span> <span m=''439480''>every</span> <span m=''439710''>so</span>
  <span m=''439870''>often,</span> <span m=''440830''>every</span> <span m=''441500''>1,000th</span>
  <span m=''441970''>event,</span> <span m=''442340''>or</span> <span m=''442530''>some</span>
  <span m=''442680''>other</span> <span m=''442840''>frequency</span> <span m=''446160''>for</span>
  <span m=''446330''>whatever</span> <span m=''446630''>your</span> <span m=''446810''>interesting</span>
  <span m=''447180''>event</span> <span m=''447460''>is.</span> <span m=''451630''>And</span>
  <span m=''452020''>basically,</span> <span m=''452450''>what</span> <span m=''452590''>happens</span>
  <span m=''452910''>is</span> <span m=''453040''>that</span> <span m=''456560''>when</span>
  <span m=''456670''>that</span> <span m=''456820''>counter</span> <span m=''457110''>has</span>
  <span m=''457520''>hit</span> <span m=''457680''>the</span> <span m=''457760''>threshold,</span>
  <span m=''458840''>an</span> <span m=''458990''>interrupt</span> <span m=''459310''>will</span>
  <span m=''459390''>fire,</span> <span m=''459690''>and</span> <span m=''459760''>the</span>
  <span m=''459830''>kernel will</span> <span m=''460170''>catch</span> <span m=''460430''>it.</span>
  <span m=''460950''>And</span> <span m=''461120''>then</span> <span m=''461250''>it</span>
  <span m=''461340''>will</span> <span m=''461470''>record</span> <span m=''462630''>the</span>
  <span m=''463290''>data</span> <span m=''463530''>that</span> <span m=''463660''>you</span>
  <span m=''463750''>want,</span> <span m=''464000''>the</span> <span m=''464080''>context,</span>
  <span m=''464630''>like</span> <span m=''464780''>where in the</span> <span m=''465040''>execution</span>
  <span m=''465330''>it</span> <span m=''465620''>was,</span> <span m=''466360''>what</span>
  <span m=''466500''>the</span> <span m=''466560''>call</span> <span m=''466770''>stack</span>
  <span m=''467060''>looked</span> <span m=''467230''>like,</span> <span m=''467920''>these</span>
  <span m=''468070''>kinds</span> <span m=''468250''>of</span> <span m=''468330''>things.</span>
  </p><p><span m=''474000''>I</span> <span m=''474110''>think</span> <span m=''474870''>we''ve</span>
  <span m=''475180''>covered</span> <span m=''476290''>most</span> <span m=''476430''>of</span>
  <span m=''476580''>the</span> <span m=''476650''>performance</span> <span m=''477030''>counters</span>
  <span m=''477315''>that</span> <span m=''477930''>we</span> <span m=''478170''>mostly</span>
  <span m=''478490''>care</span> <span m=''478670''>about.</span> <span m=''478970''>But</span>
  <span m=''479080''>I</span> <span m=''479140''>think</span> <span m=''479290''>it''s</span>
  <span m=''479400''>worth</span> <span m=''479570''>mentioning</span> <span m=''480000''>that</span>
  <span m=''482120''>there</span> <span m=''482400''>are</span> <span m=''482420''>a</span>
  <span m=''482470''>lot</span> <span m=''482690''>of</span> <span m=''482760''>performance</span>
  <span m=''483070''>counters.</span> <span m=''483410''>And</span> <span m=''483850''>you</span>
  <span m=''483960''>can</span> <span m=''484080''>go</span> <span m=''484190''>look</span>
  <span m=''484340''>them</span> <span m=''484460''>up</span> <span m=''484570''>in</span>
  <span m=''484700''>this</span> <span m=''485200''>part</span> <span m=''485400''>of</span>
  <span m=''485470''>the</span> <span m=''486010''>manual.</span> <span m=''487900''>They</span>
  <span m=''488020''>cover</span> <span m=''488240''>a</span> <span m=''488290''>lot</span>
  <span m=''488470''>of</span> <span m=''488530''>interesting</span> <span m=''488830''>things,</span>
  <span m=''489090''>not</span> <span m=''489230''>just</span> <span m=''489420''>the</span>
  <span m=''489500''>ones</span> <span m=''489660''>we''ve</span> <span m=''489730''>talked</span>
  <span m=''489950''>about,</span> <span m=''491130''>including</span> <span m=''491810''>sleep</span>
  <span m=''492130''>states,</span> <span m=''492930''>power</span> <span m=''493150''>consumption.</span>
  </p><p><span m=''493700''>And</span> <span m=''494760''>if</span> <span m=''494910''>you</span>
  <span m=''495020''>want</span> <span m=''495120''>to</span> <span m=''495170''>look</span>
  <span m=''495350''>at</span> <span m=''495540''>contention,</span> <span m=''496510''>say</span>
  <span m=''496700''>you</span> <span m=''496880''>have</span> <span m=''498940''>a</span>
  <span m=''499030''>parallel</span> <span m=''499340''>program,</span> <span m=''499810''>and</span>
  <span m=''499880''>you have</span> <span m=''500020''>two</span> <span m=''500200''>cores</span>
  <span m=''500510''>accessing</span> <span m=''500830''>the</span> <span m=''500890''>same</span>
  <span m=''501110''>data.</span> <span m=''502470''>If</span> <span m=''502670''>they''re</span>
  <span m=''502840''>writing</span> <span m=''503090''>back</span> <span m=''503310''>to</span>
  <span m=''503470''>it,</span> <span m=''503570''>they''re going to be</span> <span
  m=''503830''>fighting</span> <span m=''504110''>over</span> <span m=''504210''>the</span>
  <span m=''504300''>same</span> <span m=''504500''>cache</span> <span m=''504790''>lines.</span>
  <span m=''505460''>And</span> <span m=''505580''>so there are</span> <span m=''505910''>counters</span>
  <span m=''506240''>for</span> <span m=''506370''>things</span> <span m=''506710''>like,</span>
  <span m=''507340''>how</span> <span m=''507460''>many</span> <span m=''507590''>times</span>
  <span m=''507930''>did</span> <span m=''508060''>this</span> <span m=''508160''>core</span>
  <span m=''508530''>have</span> <span m=''508710''>to</span> <span m=''510360''>go</span>
  <span m=''510540''>off</span> <span m=''510840''>core</span> <span m=''511170''>to</span>
  <span m=''511280''>get</span> <span m=''511520''>cache</span> <span m=''511830''>line,</span>
  <span m=''513180''>and</span> <span m=''513630''>all</span> <span m=''513760''>kinds</span>
  <span m=''513990''>of</span> <span m=''514039''>interesting</span> <span m=''514330''>things</span>
  <span m=''514539''>like</span> <span m=''514690''>that.</span> <span m=''515840''>But</span>
  <span m=''515950''>mostly,</span> <span m=''516230''>we''re</span> <span m=''516370''>going</span>
  <span m=''516419''>to</span> <span m=''516470''>focus</span> <span m=''516809''>on</span>
  <span m=''516980''>the</span> <span m=''517880''>cache</span> <span m=''518120''>misses,</span>
  <span m=''518929''>branch</span> <span m=''519360''>misses.</span> </p><p><span
  m=''524520''>I</span> <span m=''524590''>also</span> <span m=''524750''>wanted</span>
  <span m=''524940''>to</span> <span m=''525100''>mention</span> <span m=''525500''>that</span>
  <span m=''526320''>the</span> <span m=''526440''>tool</span> <span m=''526600''>we''re</span>
  <span m=''526750''>using,</span> <span m=''527080''>perf,</span> <span m=''528110''>it</span>
  <span m=''528200''>kind of</span> <span m=''528390''>replaces</span> <span m=''528800''>OProfile</span>
  <span m=''529370''>and</span> <span m=''529510''>PerfMon,</span> <span m=''529790''>which</span>
  <span m=''530060''>are</span> <span m=''530200''>tools</span> <span m=''530430''>that</span>
  <span m=''530520''>do</span> <span m=''530640''>similar</span> <span m=''530940''>things.</span>
  <span m=''532940''>I</span> <span m=''533020''>guess</span> <span m=''533160''>it''s</span>
  <span m=''533260''>different</span> <span m=''533540''>in</span> <span m=''533620''>that</span>
  <span m=''533800''>it''s</span> <span m=''534000''>a</span> <span m=''534390''>unified</span>
  <span m=''535200''>interface</span> <span m=''535770''>to</span> <span m=''535870''>monitoring</span>
  <span m=''536350''>two</span> <span m=''536520''>kinds</span> <span m=''536790''>of</span>
  <span m=''536850''>events.</span> <span m=''538020''>The</span> <span m=''538300''>first</span>
  <span m=''538680''>are</span> <span m=''539620''>software</span> <span m=''540490''>kernel</span>
  <span m=''541010''>events,</span> <span m=''541290''>so</span> <span m=''541660''>things</span>
  <span m=''542080''>like</span> <span m=''542290''>contact</span> <span m=''542680''>switches.</span>
  <span m=''543320''>So</span> <span m=''543490''>how</span> <span m=''543580''>many</span>
  <span m=''543680''>times</span> <span m=''544030''>did</span> <span m=''544230''>your</span>
  <span m=''544420''>application</span> <span m=''545060''>make</span> <span m=''545340''>a</span>
  <span m=''545440''>system</span> <span m=''545750''>call</span> <span m=''546090''>and</span>
  <span m=''546190''>then</span> <span m=''546340''>get</span> <span m=''546730''>contact</span>
  <span m=''546880''>switched</span> <span m=''547130''>out?</span> <span m=''548290''>And</span>
  <span m=''550080''>how</span> <span m=''550200''>many</span> <span m=''550320''>page</span>
  <span m=''550610''>faults</span> <span m=''550920''>did</span> <span m=''551020''>your</span>
  <span m=''551390''>application</span> <span m=''552110''>generate?</span> <span
  m=''555510''>These</span> <span m=''555670''>kinds</span> <span m=''555870''>of</span>
  <span m=''555940''>things</span> <span m=''556120''>that</span> <span m=''556190''>the</span>
  <span m=''556270''>kernel</span> <span m=''556530''>knows</span> <span m=''556720''>about,</span>
  <span m=''557010''>but</span> <span m=''557130''>aren''t</span> <span m=''557270''>necessarily</span>
  <span m=''557690''>hardware</span> <span m=''558030''>events.</span> </p><p><span
  m=''558720''>And</span> <span m=''558810''>the other</span> <span m=''558910''>kind</span>
  <span m=''559040''>is</span> <span m=''559170''>hardware</span> <span m=''559490''>events.</span>
  <span m=''560480''>And</span> <span m=''560580''>those</span> <span m=''560770''>are</span>
  <span m=''560830''>sort of the</span> <span m=''561010''>ones</span> <span m=''561180''>we''re</span>
  <span m=''561320''>going</span> <span m=''561400''>to</span> <span m=''561440''>focus</span>
  <span m=''561760''>on.</span> <span m=''563450''>We''ve</span> <span m=''563600''>already</span>
  <span m=''563790''>talked</span> <span m=''564050''>about</span> <span m=''564190''>those.</span>
  <span m=''565310''>If</span> <span m=''565420''>you</span> <span m=''565520''>want</span>
  <span m=''565630''>to</span> <span m=''565670''>get</span> <span m=''565810''>this</span>
  <span m=''565920''>tool</span> <span m=''566220''>and try it out</span> <span m=''566580''>yourself,</span>
  <span m=''567390''>if</span> <span m=''567530''>you</span> <span m=''567630''>have</span>
  <span m=''567970''>any</span> <span m=''568180''>recent</span> <span m=''568690''>Linux</span>
  <span m=''569120''>distribution,</span> <span m=''569740''>anything</span> <span
  m=''570000''>with</span> <span m=''570080''>a</span> <span m=''570160''>kernel</span>
  <span m=''570490''>that''s</span> <span m=''570780''>less</span> <span m=''570990''>than</span>
  <span m=''571070''>a</span> <span m=''571130''>year</span> <span m=''571410''>old,</span>
  <span m=''573020''>you</span> <span m=''573170''>can</span> <span m=''573320''>install</span>
  <span m=''573730''>Linux</span> <span m=''573970''>tools.</span> <span m=''574720''>And</span>
  <span m=''575220''>the</span> <span m=''575420''>command is</span> <span m=''575820''>perf.</span>
  <span m=''578470''>So</span> <span m=''578620''>now</span> <span m=''578730''>we''re</span>
  <span m=''578820''>going</span> <span m=''578900''>to</span> <span m=''578960''>do</span>
  <span m=''579230''>a</span> <span m=''579310''>demo</span> <span m=''579710''>of</span>
  <span m=''580160''>the</span> <span m=''580400''>matrix</span> <span m=''580670''>multiply</span>
  <span m=''581010''>from</span> <span m=''581140''>Project 0.</span> </p><p><span
  m=''582650''>GUEST SPEAKER 2: All</span> <span m=''582820''>right.</span> <span
  m=''583160''>So</span> <span m=''583390''>for</span> <span m=''583550''>the</span>
  <span m=''583680''>demos,</span> <span m=''584150''>I</span> <span m=''584210''>guess</span>
  <span m=''584510''>I''ll</span> <span m=''584730''>narrate</span> <span m=''585170''>what</span>
  <span m=''585320''>the code''s</span> <span m=''585750''>doing,</span> <span m=''586070''>so</span>
  <span m=''586370''>Reid</span> <span m=''586600''>can</span> <span m=''586870''>focus</span>
  <span m=''587240''>on</span> <span m=''587370''>typing.</span> <span m=''589090''>This</span>
  <span m=''589410''>code</span> <span m=''589680''>should</span> <span m=''589830''>look</span>
  <span m=''590050''>familiar.</span> <span m=''604116''>All right.</span> <span m=''605070''>Can</span>
  <span m=''605210''>everybody</span> <span m=''605500''>hear</span> <span m=''605670''>me?</span>
  <span m=''606940''>All</span> <span m=''607080''>right,</span> <span m=''607220''>cool.</span>
  <span m=''607790''>So</span> <span m=''608060''>this</span> <span m=''608280''>code</span>
  <span m=''608480''>should</span> <span m=''608630''>look</span> <span m=''608820''>very</span>
  <span m=''609070''>familiar.</span> <span m=''609860''>It''s</span> <span m=''610120''>Project
  0''s</span> <span m=''610920''>matrix</span> <span m=''611310''>multiply</span>
  <span m=''611710''>code,</span> <span m=''612030''>the</span> <span m=''612490''>original</span>
  <span m=''612910''>version.</span> <span m=''613890''>And</span> <span m=''614590''>it''s</span>
  <span m=''614890''>a</span> <span m=''615110''>triply-nested</span> <span m=''616010''>four</span>
  <span m=''616230''>loop</span> <span m=''616490''>for</span> <span m=''616830''>multiplying</span>
  <span m=''617360''>matrices.</span> <span m=''618380''>So</span> <span m=''618710''>what</span>
  <span m=''618920''>we''re</span> <span m=''619080''>going</span> <span m=''619190''>to</span>
  <span m=''619300''>do</span> <span m=''620020''>is</span> <span m=''621210''>I''m</span>
  <span m=''621470''>going</span> <span m=''621610''>to</span> <span m=''621760''>switch</span>
  <span m=''622170''>to</span> <span m=''622410''>a</span> <span m=''622580''>terminal</span>
  <span m=''623750''>that</span> <span m=''624210''>Reid is</span> <span m=''624620''>typing</span>
  <span m=''625030''>on.</span> <span m=''625640''>And</span> <span m=''626160''>we''re</span>
  <span m=''626380''>going</span> <span m=''626490''>to</span> <span m=''626610''>run</span>
  <span m=''626940''>matrix</span> <span m=''627320''>multiply.</span> <span m=''628330''>And</span>
  <span m=''629000''>it</span> <span m=''629170''>takes</span> <span m=''629390''>about</span>
  <span m=''629640''>eight</span> <span m=''629850''>seconds</span> <span m=''630270''>to</span>
  <span m=''630400''>run.</span> </p><p><span m=''631160''>And</span> <span m=''631520''>now</span>
  <span m=''631720''>we''re</span> <span m=''631860''>going</span> <span m=''631990''>to</span>
  <span m=''632070''>run</span> <span m=''632320''>it,</span> <span m=''632580''>but</span>
  <span m=''632840''>have</span> <span m=''633210''>perf</span> <span m=''634780''>output</span>
  <span m=''635190''>some</span> <span m=''635410''>performance</span> <span m=''636310''>statistics</span>
  <span m=''636960''>for</span> <span m=''637170''>it,</span> <span m=''637590''>basically,</span>
  <span m=''637960''>CPU</span> <span m=''638360''>counters.</span> <span m=''639270''>So</span>
  <span m=''639900''>you</span> <span m=''640020''>use</span> <span m=''640330''>-e</span>
  <span m=''640910''>to</span> <span m=''641040''>request</span> <span m=''641460''>specific</span>
  <span m=''641920''>counters.</span> <span m=''642660''>You</span> <span m=''642770''>can</span>
  <span m=''642880''>use</span> <span m=''644240''>perf</span> <span m=''644640''>list</span>
  <span m=''645390''>to</span> <span m=''645790''>take</span> <span m=''646050''>a</span>
  <span m=''646130''>look</span> <span m=''646400''>at</span> <span m=''646560''>all</span>
  <span m=''646740''>the</span> <span m=''646820''>counters</span> <span m=''647180''>that</span>
  <span m=''647330''>perf</span> <span m=''647500''>supports.</span> <span m=''648360''>In</span>
  <span m=''648490''>this</span> <span m=''648680''>case,</span> <span m=''648960''>we''re</span>
  <span m=''649180''>asking</span> <span m=''649630''>for</span> <span m=''649850''>the</span>
  <span m=''650000''>number</span> <span m=''650340''>of</span> <span m=''650400''>CPU</span>
  <span m=''650780''>cycles,</span> <span m=''651350''>the</span> <span m=''651450''>number</span>
  <span m=''651750''>of</span> <span m=''651830''>instructions,</span> <span m=''653320''>the</span>
  <span m=''653430''>number</span> <span m=''653720''>of</span> <span m=''653830''>L1</span>
  <span m=''654220''>cache</span> <span m=''654580''>loads,</span> <span m=''654940''>and</span>
  <span m=''655090''>then</span> <span m=''655230''>the</span> <span m=''655330''>number</span>
  <span m=''655630''>of</span> <span m=''656000''>L1</span> <span m=''656320''>cache</span>
  <span m=''656660''>misses.</span> <span m=''660250''>Perf</span> <span m=''660530''>stat.</span>
  <span m=''664240''>That''s</span> <span m=''664500''>better.</span> </p><p><span
  m=''667710''>So</span> <span m=''668890''>it</span> <span m=''669080''>takes</span>
  <span m=''669300''>a</span> <span m=''669370''>little</span> <span m=''669600''>bit</span>
  <span m=''669760''>longer</span> <span m=''670090''>to</span> <span m=''670210''>execute,</span>
  <span m=''670620''>I</span> <span m=''670780''>think,</span> <span m=''670940''>with</span>
  <span m=''671100''>perf.</span> <span m=''671500''>But</span> <span m=''671800''>it''s</span>
  <span m=''672050''>not</span> <span m=''672280''>supposed</span> <span m=''672410''>to</span>
  <span m=''672540''>be</span> <span m=''672630''>a</span> <span m=''672670''>big</span>
  <span m=''672860''>difference.</span> <span m=''673145''>You</span> <span m=''673430''>can</span>
  <span m=''673850''>see,</span> <span m=''674140''>8.31</span> <span m=''674990''>versus</span>
  <span m=''675310''>8.34.</span> <span m=''676460''>So</span> <span m=''676720''>it''s</span>
  <span m=''677040''>relatively</span> <span m=''677600''>low</span> <span m=''677870''>overhead</span>
  <span m=''678310''>sampling,</span> <span m=''678750''>which</span> <span m=''678920''>is</span>
  <span m=''679050''>good,</span> <span m=''679350''>because</span> <span m=''679640''>you</span>
  <span m=''679710''>don''t</span> <span m=''679850''>want</span> <span m=''679990''>to</span>
  <span m=''680060''>change</span> <span m=''680340''>the</span> <span m=''680430''>behavior</span>
  <span m=''680725''>of your</span> <span m=''681020''>program</span> <span m=''681380''>when
  you</span> <span m=''681560''>sample</span> <span m=''681940''>it.</span> </p><p><span
  m=''683010''>Important</span> <span m=''683460''>things</span> <span m=''683750''>to</span>
  <span m=''684370''>see.</span> <span m=''685830''>So</span> <span m=''687810''>we''re</span>
  <span m=''687980''>looking</span> <span m=''688250''>at</span> <span m=''688380''>this</span>
  <span m=''688990''>cache</span> <span m=''689350''>miss</span> <span m=''689680''>rate,</span>
  <span m=''690460''>which</span> <span m=''690710''>is</span> <span m=''692390''>18%,</span>
  <span m=''692750''>almost</span> <span m=''693090''>19%,</span> <span m=''694430''>L1</span>
  <span m=''694590''>cache</span> <span m=''694890''>miss</span> <span m=''695120''>rate,</span>
  <span m=''695610''>which</span> <span m=''695830''>is</span> <span m=''696080''>pretty</span>
  <span m=''696390''>bad.</span> <span m=''697080''>So</span> <span m=''697370''>as</span>
  <span m=''697490''>a</span> <span m=''697610''>result</span> <span m=''697940''>of</span>
  <span m=''698020''>that,</span> <span m=''698240''>if</span> <span m=''698340''>you</span>
  <span m=''698460''>look</span> <span m=''698620''>at</span> <span m=''698790''>the</span>
  <span m=''698880''>number</span> <span m=''699180''>of</span> <span m=''699240''>instructions,</span>
  <span m=''699730''>the</span> <span m=''699860''>number</span> <span m=''700110''>of</span>
  <span m=''700160''>cycles,</span> <span m=''701620''>perf</span> <span m=''702960''>calculates</span>
  <span m=''703510''>the</span> <span m=''703680''>IPC</span> <span m=''704230''>for</span>
  <span m=''704420''>you.</span> <span m=''704870''>We</span> <span m=''705060''>previously</span>
  <span m=''705520''>talked</span> <span m=''705790''>about</span> <span m=''705960''>CPI.</span>
  <span m=''706400''>But</span> <span m=''706790''>perf</span> <span m=''707200''>uses</span>
  <span m=''707340''>IPC,</span> <span m=''707850''>which</span> <span m=''708050''>is</span>
  <span m=''708320''>instructions</span> <span m=''709140''>per</span> <span m=''709530''>cycle.</span>
  <span m=''710450''>So</span> <span m=''711050''>basically,</span> <span m=''712370''>every</span>
  <span m=''712650''>cycle,</span> <span m=''713070''>you</span> <span m=''713370''>only</span>
  <span m=''713610''>executed</span> <span m=''714050''>half an</span> <span m=''714430''>instruction</span>
  <span m=''714940''>on</span> <span m=''715070''>average,</span> <span m=''715530''>because</span>
  <span m=''715800''>you''re</span> <span m=''715890''>waiting</span> <span m=''716170''>for</span>
  <span m=''716260''>the</span> <span m=''716360''>cache.</span> <span m=''717060''>So</span>
  <span m=''717700''>that''s</span> <span m=''717970''>no</span> <span m=''718120''>good.</span>
  <span m=''719100''>So</span> <span m=''719860''>can</span> <span m=''720030''>anybody</span>
  <span m=''720310''>remember</span> <span m=''720680''>from</span> <span m=''720850''>Project
  0</span> <span m=''722580''>what</span> <span m=''722870''>you</span> <span m=''723160''>did</span>
  <span m=''723380''>to</span> <span m=''723640''>work</span> <span m=''723890''>around</span>
  <span m=''724180''>that?</span> <span m=''725610''>Yes.</span> </p><p><span m=''726000''>AUDIENCE:
  You</span> <span m=''726390''>reordered</span> <span m=''726836''>the loops.</span>
  </p><p><span m=''727730''>GUEST SPEAKER 2: Yes.</span> <span m=''729340''>So</span>
  <span m=''731110''>the</span> <span m=''731400''>before</span> <span m=''731790''>and</span>
  <span m=''731880''>after.</span> <span m=''732440''>You</span> <span m=''732770''>just</span>
  <span m=''732990''>swap</span> <span m=''733290''>out</span> <span m=''733490''>the</span>
  <span m=''733640''>inner</span> <span m=''733850''>two</span> <span m=''734060''>loops.</span>
  <span m=''735200''>And</span> <span m=''737030''>we</span> <span m=''737170''>will</span>
  <span m=''737360''>run</span> <span m=''737560''>it</span> <span m=''737660''>again.</span>
  <span m=''740370''>OK,</span> <span m=''740590''>so</span> <span m=''740780''>remember,</span>
  <span m=''741090''>the</span> <span m=''741190''>previous</span> <span m=''741560''>runtime</span>
  <span m=''741920''>was</span> <span m=''742080''>8 seconds.</span> <span m=''742770''>Now</span>
  <span m=''743000''>it''s</span> <span m=''743150''>down</span> <span m=''743370''>to</span>
  <span m=''743530''>2.5</span> <span m=''744170''>seconds,</span> <span m=''744550''>which</span>
  <span m=''744700''>is</span> <span m=''744810''>a</span> <span m=''744870''>lot</span>
  <span m=''745100''>better.</span> <span m=''745940''>Let''s</span> <span m=''747180''>run</span>
  <span m=''747460''>the</span> <span m=''747940''>perf</span> <span m=''748230''>stat</span>
  <span m=''748450''>command</span> <span m=''748780''>again</span> <span m=''749050''>and</span>
  <span m=''749150''>look</span> <span m=''749280''>at</span> <span m=''749420''>the</span>
  <span m=''749500''>performance</span> <span m=''749940''>counters.</span> <span
  m=''750830''>And</span> <span m=''751100''>as</span> <span m=''751190''>you</span>
  <span m=''751300''>can</span> <span m=''751440''>see,</span> <span m=''751660''>the</span>
  <span m=''751810''>IPC</span> <span m=''752370''>jumped</span> <span m=''752720''>from</span>
  <span m=''752980''>0.49</span> <span m=''753840''>to</span> <span m=''753990''>1.4.</span>
  <span m=''754840''>So</span> <span m=''755170''>it</span> <span m=''755310''>tripled.</span>
  <span m=''756300''>And</span> <span m=''756620''>if</span> <span m=''756720''>you</span>
  <span m=''756820''>look</span> <span m=''757010''>at</span> <span m=''757150''>the</span>
  <span m=''757450''>new</span> <span m=''758220''>L1</span> <span m=''758680''>cache</span>
  <span m=''759120''>miss</span> <span m=''759300''>rate,</span> <span m=''759930''>it''s</span>
  <span m=''760740''>1%</span> <span m=''761530''>rather</span> <span m=''761840''>than</span>
  <span m=''762540''>20%,</span> <span m=''763590''>which</span> <span m=''763800''>is</span>
  <span m=''763940''>a</span> <span m=''764020''>lot</span> <span m=''764230''>better.</span>
  <span m=''766670''>Yes?</span> </p><p><span m=''766995''>AUDIENCE: Can</span> <span
  m=''767320''>you</span> <span m=''767808''>point to</span> <span m=''768296''>where
  the</span> <span m=''768784''>cache</span> <span m=''769272''>miss rate</span> <span
  m=''769760''>percent is?</span> <span m=''770248''>Because I</span> <span m=''770736''>just</span>
  <span m=''771224''>see</span> <span m=''771712''>zero per</span> <span m=''772200''>second.</span>
  </p><p><span m=''772690''>GUEST SPEAKER 2: Oh,</span> <span m=''772940''>sorry</span>
  <span m=''773280''>about</span> <span m=''773480''>that.</span> <span m=''773770''>So</span>
  <span m=''774810''>L1</span> <span m=''775280''>D-cache</span> <span m=''775800''>loads</span>
  <span m=''776210''>is</span> <span m=''776410''>all</span> <span m=''776750''>of
  the</span> <span m=''776870''>times</span> <span m=''777210''>that</span> <span
  m=''777310''>the</span> <span m=''777410''>CPU</span> <span m=''777860''>asked</span>
  <span m=''778110''>the</span> <span m=''778390''>L1</span> <span m=''778470''>cache</span>
  <span m=''778770''>for</span> <span m=''778910''>something.</span> <span m=''779850''>And</span>
  <span m=''780030''>then</span> <span m=''780420''>L1</span> <span m=''780710''>D-cache</span>
  <span m=''781200''>load</span> <span m=''781520''>misses</span> <span m=''782300''>is</span>
  <span m=''782730''>the</span> <span m=''782860''>number</span> <span m=''783140''>of</span>
  <span m=''783210''>cache</span> <span m=''783520''>misses.</span> <span m=''784730''>So</span>
  <span m=''785100''>you</span> <span m=''785250''>divide</span> <span m=''785990''>this</span>
  <span m=''786430''>over</span> <span m=''787060''>this</span> <span m=''788190''>to</span>
  <span m=''788330''>get</span> <span m=''788580''>the</span> <span m=''788780''>ratio,</span>
  <span m=''792190''>which</span> <span m=''792450''>is</span> <span m=''792630''>basically</span>
  <span m=''793020''>what</span> <span m=''793320''>Reid</span> <span m=''793500''>did</span>
  <span m=''793720''>over</span> <span m=''793900''>here.</span> <span m=''795640''>Does</span>
  <span m=''795740''>that</span> <span m=''795850''>make</span> <span m=''795980''>sense?</span>
  </p><p><span m=''796794''>AUDIENCE: Yes.</span> </p><p><span m=''797830''>GUEST
  SPEAKER 2: OK.</span> <span m=''800760''>So</span> <span m=''801010''>this</span>
  <span m=''801200''>is</span> <span m=''801410''>a</span> <span m=''802960''>ridiculously</span>
  <span m=''803610''>simple</span> <span m=''804010''>example</span> <span m=''804440''>of</span>
  <span m=''804560''>how</span> <span m=''804710''>to</span> <span m=''804800''>use</span>
  <span m=''805520''>perf,</span> <span m=''805820''>just</span> <span m=''806000''>so</span>
  <span m=''806100''>that</span> <span m=''806270''>you</span> <span m=''806550''>can</span>
  <span m=''807190''>see</span> <span m=''807370''>the</span> <span m=''807480''>command</span>
  <span m=''807850''>set.</span> <span m=''808150''>But</span> <span m=''808860''>that''s</span>
  <span m=''809490''>not</span> <span m=''809680''>really</span> <span m=''809980''>a</span>
  <span m=''810020''>very</span> <span m=''810370''>interesting</span> <span m=''810920''>example.</span>
  <span m=''811780''>So</span> <span m=''812000''>the</span> <span m=''812100''>next</span>
  <span m=''812330''>one</span> <span m=''812430''>that</span> <span m=''814240''>we''ll</span>
  <span m=''814530''>look</span> <span m=''814720''>at</span> <span m=''814960''>is</span>
  <span m=''815270''>actually</span> <span m=''815620''>something</span> <span m=''816020''>that</span>
  <span m=''816460''>Charles,</span> <span m=''816920''>Reid,</span> <span m=''817170''>and</span>
  <span m=''817300''>I</span> <span m=''817430''>did</span> <span m=''817700''>yesterday</span>
  <span m=''818240''>afternoon</span> <span m=''818830''>for</span> <span m=''819090''>fun.</span>
  <span m=''821650''>It</span> <span m=''821850''>started,</span> <span m=''822450''>we</span>
  <span m=''822920''>were</span> <span m=''823450''>testing</span> <span m=''824030''>your</span>
  <span m=''824260''>Project</span> <span m=''824700''>2.1,</span> <span m=''824890''>one</span>
  <span m=''825200''>which</span> <span m=''825400''>is--</span> <span m=''826670''>I</span>
  <span m=''826820''>don''t</span> <span m=''826990''>know</span> <span m=''827160''>how</span>
  <span m=''827290''>many</span> <span m=''827450''>people</span> <span m=''827630''>have</span>
  <span m=''827760''>looked</span> <span m=''827980''>at</span> <span m=''828070''>the</span>
  <span m=''828410''>handout</span> <span m=''828550''>yet.</span> <span m=''828750''>But</span>
  <span m=''828900''>it</span> <span m=''829000''>deals</span> <span m=''829280''>with</span>
  <span m=''829460''>a</span> <span m=''829530''>bunch</span> <span m=''829810''>of</span>
  <span m=''829970''>mystery</span> <span m=''830410''>sorting</span> <span m=''830770''>algorithms</span>
  <span m=''831280''>that</span> <span m=''831390''>you</span> <span m=''831480''>have</span>
  <span m=''831580''>to</span> <span m=''831670''>figure</span> <span m=''831930''>out</span>
  <span m=''831980''>what</span> <span m=''832150''>they''re</span> <span m=''832370''>doing.</span>
  </p><p><span m=''833150''>And</span> <span m=''833470''>so</span> <span m=''833670''>we</span>
  <span m=''833810''>took</span> <span m=''834030''>one</span> <span m=''834240''>of</span>
  <span m=''834320''>them.</span> <span m=''835510''>And</span> <span m=''835890''>we</span>
  <span m=''836000''>were</span> <span m=''836120''>running</span> <span m=''836730''>sorting.</span>
  <span m=''837300''>And</span> <span m=''837700''>Charles</span> <span m=''838030''>asked,</span>
  <span m=''838280''>what</span> <span m=''838410''>happens</span> <span m=''838800''>if</span>
  <span m=''838880''>you</span> <span m=''839010''>have</span> <span m=''839150''>a</span>
  <span m=''839200''>branchless</span> <span m=''839630''>sorting</span> <span m=''839980''>algorithm?</span>
  <span m=''840850''>And</span> <span m=''841000''>we</span> <span m=''841250''>said,</span>
  <span m=''841660''>we</span> <span m=''841810''>don''t</span> <span m=''841990''>know.</span>
  <span m=''842510''>So</span> <span m=''843070''>we</span> <span m=''843300''>played</span>
  <span m=''843590''>around</span> <span m=''843890''>with</span> <span m=''844060''>it.</span>
  <span m=''844530''>And</span> <span m=''844710''>in</span> <span m=''844780''>the</span>
  <span m=''844860''>process,</span> <span m=''845580''>we</span> <span m=''845950''>optimized</span>
  <span m=''846600''>our</span> <span m=''846780''>branchless</span> <span m=''847150''>sorting</span>
  <span m=''847540''>algorithm</span> <span m=''848370''>by</span> <span m=''848510''>using</span>
  <span m=''848880''>perf</span> <span m=''849190''>to</span> <span m=''849450''>generate</span>
  <span m=''849940''>insight</span> <span m=''850430''>into</span> <span m=''850760''>what</span>
  <span m=''850960''>the</span> <span m=''851030''>CPU</span> <span m=''851420''>is</span>
  <span m=''851550''>doing.</span> <span m=''852200''>And</span> <span m=''852590''>as</span>
  <span m=''852780''>you''ll</span> <span m=''852900''>see,</span> <span m=''853110''>we</span>
  <span m=''853240''>generated</span> <span m=''853680''>quite</span> <span m=''853880''>a</span>
  <span m=''853900''>good</span> <span m=''854080''>speed-up.</span> </p><p><span
  m=''854860''>So</span> <span m=''855050''>the</span> <span m=''855140''>first</span>
  <span m=''855380''>thing</span> <span m=''855500''>we''ll</span> <span m=''855630''>do</span>
  <span m=''855880''>is,</span> <span m=''856020''>let''s</span> <span m=''856200''>start</span>
  <span m=''856420''>with</span> <span m=''856530''>the</span> <span m=''856610''>baseline,</span>
  <span m=''857160''>quicksort,</span> <span m=''857720''>everybody''s</span> <span
  m=''858210''>favorite</span> <span m=''858490''>sorting</span> <span m=''858790''>algorithm.</span>
  <span m=''859750''>So</span> <span m=''860030''>I''ll</span> <span m=''860200''>switch</span>
  <span m=''860470''>over</span> <span m=''860670''>to</span> <span m=''860930''>the</span>
  <span m=''861060''>terminal.</span> <span m=''861980''>And</span> <span m=''862330''>Reid</span>
  <span m=''862670''>is</span> <span m=''862930''>going</span> <span m=''863190''>to</span>
  <span m=''863330''>run</span> <span m=''863680''>quicksort</span> <span m=''864350''>on</span>
  <span m=''865080''>30 million</span> <span m=''865770''>integers</span> <span m=''866760''>one</span>
  <span m=''867160''>time,</span> <span m=''867760''>which</span> <span m=''868520''>it</span>
  <span m=''868680''>says</span> <span m=''869000''>takes</span> <span m=''869370''>4.14</span>
  <span m=''870180''>seconds.</span> <span m=''871570''>Now,</span> <span m=''873070''>let''s</span>
  <span m=''873970''>use</span> <span m=''874190''>perf stat</span> <span m=''874740''>to</span>
  <span m=''874870''>see</span> <span m=''875080''>what</span> <span m=''875270''>it''s</span>
  <span m=''875460''>doing.</span> <span m=''877710''>So</span> <span m=''878040''>this</span>
  <span m=''878270''>time,</span> <span m=''878540''>we</span> <span m=''878650''>will</span>
  <span m=''878860''>ask</span> <span m=''879110''>for</span> <span m=''879270''>slightly</span>
  <span m=''879620''>different</span> <span m=''879930''>events.</span> <span m=''880260''>We''ll</span>
  <span m=''880410''>still</span> <span m=''880560''>ask</span> <span m=''880860''>for</span>
  <span m=''880970''>the</span> <span m=''881290''>cycles</span> <span m=''881760''>and</span>
  <span m=''882220''>instructions</span> <span m=''882830''>to</span> <span m=''882930''>get</span>
  <span m=''883100''>our</span> <span m=''883280''>IPC.</span> <span m=''884090''>But</span>
  <span m=''884310''>we''ll</span> <span m=''884410''>also</span> <span m=''884760''>ask</span>
  <span m=''884970''>for</span> <span m=''885080''>branches</span> <span m=''885480''>and</span>
  <span m=''885590''>branch</span> <span m=''885920''>misses,</span> <span m=''886380''>because</span>
  <span m=''886690''>we</span> <span m=''886810''>kind</span> <span m=''886990''>of</span>
  <span m=''887180''>intuitively</span> <span m=''887700''>know</span> <span m=''887990''>that</span>
  <span m=''888470''>quicksort</span> <span m=''888920''>is</span> <span m=''889140''>doing</span>
  <span m=''889350''>branching.</span> </p><p><span m=''892130''>So</span> <span m=''892530''>OK.</span>
  <span m=''893350''>It''s</span> <span m=''894100''>doing</span> <span m=''894680''>0.8</span>
  <span m=''895470''>IPC,</span> <span m=''896080''>so</span> <span m=''896430''>0.8</span>
  <span m=''897070''>instructions</span> <span m=''897620''>per</span> <span m=''897760''>cycle.</span>
  <span m=''898960''>And</span> <span m=''899630''>the</span> <span m=''901350''>branch</span>
  <span m=''901680''>miss</span> <span m=''901980''>rate,</span> <span m=''903070''>so</span>
  <span m=''903330''>branch</span> <span m=''903670''>misses</span> <span m=''904050''>over</span>
  <span m=''904310''>total</span> <span m=''904580''>number</span> <span m=''904870''>branches,</span>
  <span m=''905410''>is</span> <span m=''905660''>11.5%.</span> <span m=''908000''>That''s</span>
  <span m=''908290''>pretty</span> <span m=''908570''>bad</span> <span m=''908890''>in</span>
  <span m=''908990''>terms</span> <span m=''909230''>of</span> <span m=''909300''>branch</span>
  <span m=''909620''>missing.</span> </p><p><span m=''910780''>So</span> <span m=''911240''>let''s</span>
  <span m=''911480''>take</span> <span m=''911650''>a</span> <span m=''911710''>look</span>
  <span m=''911880''>at</span> <span m=''911960''>the</span> <span m=''912050''>code</span>
  <span m=''912390''>and</span> <span m=''912710''>see</span> <span m=''912930''>why</span>
  <span m=''913130''>that''s</span> <span m=''913380''>the</span> <span m=''913460''>case.</span>
  <span m=''914630''>So</span> <span m=''915570''>here''s</span> <span m=''916060''>the</span>
  <span m=''916300''>part</span> <span m=''916560''>of</span> <span m=''916600''>the</span>
  <span m=''916710''>code in</span> <span m=''917080''>quicksort</span> <span m=''917570''>where</span>
  <span m=''917820''>you</span> <span m=''918120''>select</span> <span m=''918480''>a</span>
  <span m=''918840''>pivot</span> <span m=''920110''>recursively,</span> <span m=''920700''>and</span>
  <span m=''920800''>then</span> <span m=''921020''>you</span> <span m=''921410''>loop,</span>
  <span m=''921670''>and</span> <span m=''921830''>then</span> <span m=''922020''>you</span>
  <span m=''922410''>do</span> <span m=''922650''>your</span> <span m=''922880''>swapping.</span>
  <span m=''923680''>So</span> <span m=''926950''>these</span> <span m=''927170''>branches</span>
  <span m=''927570''>are</span> <span m=''927800''>more</span> <span m=''928060''>or</span>
  <span m=''928100''>less</span> <span m=''928410''>unpredictable.</span> <span m=''929550''>And</span>
  <span m=''930410''>looking</span> <span m=''930660''>at</span> <span m=''930800''>them,</span>
  <span m=''930910''>there''s</span> <span m=''931180''>no</span> <span m=''931340''>way</span>
  <span m=''931450''>that</span> <span m=''931570''>we</span> <span m=''931690''>could</span>
  <span m=''931860''>think</span> <span m=''932090''>of</span> <span m=''932240''>to</span>
  <span m=''932790''>get</span> <span m=''933080''>rid</span> <span m=''933220''>of</span>
  <span m=''933290''>the</span> <span m=''933780''>unpredictable</span> <span m=''934085''>branches.</span>
  <span m=''934390''>They''re</span> <span m=''935080''>unpredictable</span> <span
  m=''935740''>by</span> <span m=''935910''>nature.</span> <span m=''936800''>So</span>
  <span m=''937490''>this</span> <span m=''937670''>would</span> <span m=''937790''>not</span>
  <span m=''938000''>be</span> <span m=''938130''>an</span> <span m=''938230''>interesting</span>
  <span m=''938690''>example</span> <span m=''939170''>of</span> <span m=''939260''>which</span>
  <span m=''939490''>to</span> <span m=''939580''>do</span> <span m=''939950''>branchless</span>
  <span m=''940380''>sorting.</span> </p><p><span m=''940980''>So</span> <span m=''941140''>let''s</span>
  <span m=''941330''>switch</span> <span m=''941590''>to</span> <span m=''941690''>a</span>
  <span m=''941790''>different</span> <span m=''942100''>algorithm,</span> <span m=''943510''>mergesort.</span>
  <span m=''944570''>So</span> <span m=''946170''>here''s</span> <span m=''946450''>the</span>
  <span m=''946540''>relevant</span> <span m=''946970''>code</span> <span m=''947230''>in</span>
  <span m=''947280''>mergesort</span> <span m=''947780''>that</span> <span m=''948620''>takes</span>
  <span m=''948960''>a</span> <span m=''949690''>list,</span> <span m=''950150''>C,</span>
  <span m=''951000''>and</span> <span m=''951330''>two</span> <span m=''951560''>input</span>
  <span m=''951850''>lists,</span> <span m=''952220''>A</span> <span m=''952410''>and</span>
  <span m=''952590''>B.</span> <span m=''953170''>And</span> <span m=''953450''>you</span>
  <span m=''953570''>merge</span> <span m=''953960''>the</span> <span m=''954220''>contents</span>
  <span m=''954760''>of</span> <span m=''955080''>A</span> <span m=''955230''>and</span>
  <span m=''955400''>B</span> <span m=''955660''>into</span> <span m=''955860''>C</span>
  <span m=''956130''>by</span> <span m=''956350''>taking</span> <span m=''956710''>the</span>
  <span m=''956820''>smallest</span> <span m=''957290''>element</span> <span m=''957650''>from</span>
  <span m=''957810''>either</span> <span m=''958030''>A</span> <span m=''958150''>or</span>
  <span m=''958290''>B,</span> <span m=''958640''>putting</span> <span m=''958970''>it
  in</span> <span m=''959150''>C,</span> <span m=''959510''>and then</span> <span
  m=''959870''>repeating</span> <span m=''960210''>that</span> <span m=''960360''>process</span>
  <span m=''960900''>until</span> <span m=''961210''>the</span> <span m=''961280''>lists
  are</span> <span m=''961660''>empty.</span> <span m=''962340''>So</span> <span m=''962680''>the</span>
  <span m=''963000''>&quot;if</span> <span m=''963250''>else&quot;</span> <span m=''963520''>branches,</span>
  <span m=''964000''>as</span> <span m=''964140''>the</span> <span m=''964220''>comment</span>
  <span m=''964480''>says,</span> <span m=''965460''>tries</span> <span m=''965960''>to</span>
  <span m=''966060''>place</span> <span m=''966390''>the</span> <span m=''966490''>min</span>
  <span m=''966930''>of</span> <span m=''967270''>the</span> <span m=''967360''>value</span>
  <span m=''967710''>either</span> <span m=''968030''>at</span> <span m=''968150''>A</span>
  <span m=''968400''>or</span> <span m=''968570''>B</span> <span m=''968980''>into</span>
  <span m=''969260''>C,</span> <span m=''969880''>and</span> <span m=''970050''>then</span>
  <span m=''970400''>properly</span> <span m=''971490''>increment</span> <span m=''971890''>the</span>
  <span m=''971970''>pointer</span> <span m=''972320''>and</span> <span m=''972430''>do</span>
  <span m=''972590''>those</span> <span m=''972950''>housekeeping</span> <span m=''973460''>tasks</span>
  <span m=''973790''>so</span> <span m=''973860''>you</span> <span m=''973930''>don''t</span>
  <span m=''974170''>crash.</span> </p><p><span m=''975610''>So</span> <span m=''977940''>we''re</span>
  <span m=''978100''>going</span> <span m=''978200''>to</span> <span m=''978310''>try</span>
  <span m=''978520''>running</span> <span m=''978870''>this</span> <span m=''979150''>and</span>
  <span m=''979380''>profiling</span> <span m=''979930''>it.</span> <span m=''984570''>So</span>
  <span m=''985260''>Reid</span> <span m=''985450''>is</span> <span m=''985590''>running</span>
  <span m=''985840''>mergesort.</span> <span m=''987390''>Took</span> <span m=''987700''>5.04</span>
  <span m=''988580''>seconds.</span> <span m=''989200''>Well,</span> <span m=''989420''>the</span>
  <span m=''989490''>last</span> <span m=''989780''>one</span> <span m=''989910''>took</span>
  <span m=''990120''>4.8</span> <span m=''990820''>seconds.</span> <span m=''991160''>So</span>
  <span m=''991400''>already,</span> <span m=''991730''>it</span> <span m=''991820''>doesn''t</span>
  <span m=''992080''>look</span> <span m=''992230''>too</span> <span m=''992360''>good.</span>
  <span m=''993460''>But</span> <span m=''994180''>let''s</span> <span m=''994390''>try</span>
  <span m=''994560''>to</span> <span m=''994680''>see</span> <span m=''994850''>what</span>
  <span m=''994960''>happened.</span> <span m=''996410''>So</span> <span m=''996710''>we''ll</span>
  <span m=''997030''>issue</span> <span m=''997280''>the</span> <span m=''997400''>same</span>
  <span m=''998030''>perf stat</span> <span m=''998600''>command,</span> <span m=''999530''>asking</span>
  <span m=''999880''>for</span> <span m=''1000080''>branches,</span> <span m=''1000620''>branch</span>
  <span m=''1000890''>misses,</span> <span m=''1001910''>cycles.</span> <span m=''1002790''>Reid</span>
  <span m=''1003020''>is</span> <span m=''1003200''>being</span> <span m=''1003360''>lazy.</span>
  </p><p><span m=''1010670''>OK,</span> <span m=''1010980''>so</span> <span m=''1011190''>the</span>
  <span m=''1011320''>IPC</span> <span m=''1011890''>is</span> <span m=''1012110''>1.1,</span>
  <span m=''1012880''>which</span> <span m=''1013050''>is</span> <span m=''1013160''>a</span>
  <span m=''1013230''>little</span> <span m=''1013460''>bit</span> <span m=''1013610''>better.</span>
  <span m=''1014370''>But</span> <span m=''1014620''>if</span> <span m=''1014740''>you</span>
  <span m=''1014850''>look</span> <span m=''1015020''>at</span> <span m=''1015190''>the</span>
  <span m=''1016370''>branch</span> <span m=''1016710''>misses</span> <span m=''1017070''>over</span>
  <span m=''1017310''>branches,</span> <span m=''1018790''>they''re</span> <span m=''1019120''>off
  by</span> <span m=''1019220''>roughly</span> <span m=''1019860''>an</span> <span
  m=''1019980''>order</span> <span m=''1020230''>of</span> <span m=''1020280''>magnitude</span>
  <span m=''1020690''>just</span> <span m=''1020870''>like</span> <span m=''1020970''>before,</span>
  <span m=''1021290''>so</span> <span m=''1021490''>10%.</span> <span m=''1023780''>So</span>
  <span m=''1024240''>OK.</span> <span m=''1029060''>Mergesort</span> <span m=''1029609''>is</span>
  <span m=''1029859''>currently</span> <span m=''1030329''>slower</span> <span m=''1030700''>than</span>
  <span m=''1030829''>quicksort.</span> <span m=''1031770''>And</span> <span m=''1032079''>the</span>
  <span m=''1032170''>reason</span> <span m=''1032589''>is</span> <span m=''1032680''>still,</span>
  <span m=''1032930''>roughly,</span> <span m=''1033790''>you</span> <span m=''1033930''>still</span>
  <span m=''1034170''>have</span> <span m=''1034770''>all</span> <span m=''1035020''>of</span>
  <span m=''1035079''>these</span> <span m=''1035650''>branches</span> <span m=''1036170''>that</span>
  <span m=''1036280''>you''re</span> <span m=''1036380''>not</span> <span m=''1036569''>predicting</span>
  <span m=''1036950''>correctly.</span> </p><p><span m=''1038780''>OK,</span> <span
  m=''1039099''>so</span> <span m=''1039810''>why</span> <span m=''1040400''>branching,</span>
  <span m=''1040790''>and</span> <span m=''1040960''>why</span> <span m=''1041150''>not</span>
  <span m=''1041359''>caching?</span> <span m=''1042130''>Well,</span> <span m=''1042390''>we</span>
  <span m=''1042480''>did</span> <span m=''1042670''>some</span> <span m=''1042900''>quick</span>
  <span m=''1043140''>back-of-the-envelope</span> <span m=''1043930''>calculations,</span>
  <span m=''1044680''>or</span> <span m=''1044930''>research,</span> <span m=''1045339''>rather.</span>
  <span m=''1046130''>And</span> <span m=''1046780''>it</span> <span m=''1046910''>turns</span>
  <span m=''1047180''>out</span> <span m=''1047349''>that</span> <span m=''1047490''>in</span>
  <span m=''1047619''>the</span> <span m=''1047710''>Nehalem,</span> <span m=''1048240''>the</span>
  <span m=''1048349''>processes</span> <span m=''1048940''>that</span> <span m=''1049180''>you''re</span>
  <span m=''1049340''>using</span> <span m=''1049760''>on the</span> <span m=''1049840''>clouds,</span>
  <span m=''1050920''>one</span> <span m=''1051080''>of</span> <span m=''1051440''>the</span>
  <span m=''1051940''>design</span> <span m=''1052330''>changes</span> <span m=''1052640''>that</span>
  <span m=''1052780''>Intel</span> <span m=''1053120''>made</span> <span m=''1053400''>is</span>
  <span m=''1053570''>that</span> <span m=''1053780''>they</span> <span m=''1053880''>made</span>
  <span m=''1054220''>the</span> <span m=''1054790''>L1</span> <span m=''1055210''>cache</span>
  <span m=''1055570''>and,</span> <span m=''1055980''>actually,</span> <span m=''1056300''>also</span>
  <span m=''1056580''>the</span> <span m=''1056690''>L2</span> <span m=''1057020''>cache</span>
  <span m=''1058140''>faster,</span> <span m=''1058620''>so</span> <span m=''1059380''>fewer</span>
  <span m=''1059650''>number</span> <span m=''1059910''>of</span> <span m=''1059950''>clock</span>
  <span m=''1060240''>cycles</span> <span m=''1060560''>to</span> <span m=''1060650''>go</span>
  <span m=''1060790''>out</span> <span m=''1060980''>to</span> <span m=''1061030''>the</span>
  <span m=''1061120''>cache.</span> <span m=''1061870''>But</span> <span m=''1062070''>at</span>
  <span m=''1062240''>the</span> <span m=''1062330''>same</span> <span m=''1062560''>time,</span>
  <span m=''1062850''>they</span> <span m=''1063030''>also</span> <span m=''1063350''>made</span>
  <span m=''1063560''>the</span> <span m=''1063630''>pipeline</span> <span m=''1064180''>deeper.</span>
  </p><p><span m=''1065040''>So</span> <span m=''1065520''>an</span> <span m=''1065620''>L1</span>
  <span m=''1065950''>cache</span> <span m=''1066250''>miss is</span> <span m=''1066690''>maybe</span>
  <span m=''1066930''>three</span> <span m=''1067150''>or</span> <span m=''1067220''>four</span>
  <span m=''1067410''>cycles.</span> <span m=''1067970''>An</span> <span m=''1068090''>L2</span>
  <span m=''1068400''>cache</span> <span m=''1068720''>miss is</span> <span m=''1069130''>15</span>
  <span m=''1069500''>cycles.</span> <span m=''1070320''>By</span> <span m=''1070440''>the</span>
  <span m=''1070570''>time</span> <span m=''1070750''>you</span> <span m=''1070870''>miss</span>
  <span m=''1071140''>the</span> <span m=''1071530''>L2</span> <span m=''1071670''>cache,
  you''re</span> <span m=''1072020''>going</span> <span m=''1072220''>out</span> <span
  m=''1072350''>into</span> <span m=''1072430''>L3</span> <span m=''1072880''>cache,</span>
  <span m=''1073130''>which</span> <span m=''1073280''>is</span> <span m=''1073390''>12</span>
  <span m=''1073690''>megabytes.</span> <span m=''1074250''>And</span> <span m=''1074360''>if</span>
  <span m=''1074430''>you''re</span> <span m=''1074560''>sorting</span> <span m=''1074900''>integers,</span>
  <span m=''1075680''>most</span> <span m=''1075840''>of</span> <span m=''1076000''>them</span>
  <span m=''1076090''>are</span> <span m=''1076180''>probably</span> <span m=''1076410''>going</span>
  <span m=''1076520''>to</span> <span m=''1076560''>be</span> <span m=''1076720''>in</span>
  <span m=''1076830''>there</span> <span m=''1077020''>anyway.</span> </p><p><span
  m=''1077400''>AUDIENCE: John,</span> <span m=''1077880''>those are</span> <span
  m=''1078360''>actually</span> <span m=''1078820''>hits</span> <span m=''1079240''>[INAUDIBLE].</span>
  </p><p><span m=''1080080''>GUEST SPEAKER 2: Oh,</span> <span m=''1080500''>they</span>
  <span m=''1080820''>are.</span> <span m=''1082630''>OK,</span> <span m=''1082910''>so</span>
  <span m=''1083270''>misses</span> <span m=''1083710''>might be</span> <span m=''1084000''>a</span>
  <span m=''1084080''>little</span> <span m=''1084210''>bit</span> <span m=''1084360''>bigger</span>
  <span m=''1084610''>than</span> <span m=''1084750''>that.</span> <span m=''1085250''>But</span>
  <span m=''1085580''>OK.</span> </p><p><span m=''1086525''>AUDIENCE: L1</span> <span
  m=''1086960''>miss</span> <span m=''1087395''>is a</span> <span m=''1087830''>L2--</span>
  </p><p><span m=''1089140''>GUEST SPEAKER 2: Right,</span> <span m=''1089420''>is
  an</span> <span m=''1089730''>L2.</span> </p><p><span m=''1091020''>AUDIENCE: L1</span>
  <span m=''1091370''>misses.</span> </p><p><span m=''1091760''>AUDIENCE:</span> <span
  m=''1092150''>It was just</span> <span m=''1092290''>a typo.</span> </p><p><span
  m=''1093620''>GUEST SPEAKER 2: OK,</span> <span m=''1093750''>so</span> <span m=''1094570''>the</span>
  <span m=''1094950''>next</span> <span m=''1095240''>number</span> <span m=''1095460''>is</span>
  <span m=''1095540''>probably,</span> <span m=''1095810''>like,</span> <span m=''1096050''>30</span>
  <span m=''1096390''>to</span> <span m=''1096560''>50,</span> <span m=''1096970''>somewhere</span>
  <span m=''1097320''>on</span> <span m=''1097680''>that</span> <span m=''1097890''>order.</span>
  <span m=''1099870''>50-something.</span> <span m=''1100600''>OK.</span> <span m=''1101710''>But</span>
  <span m=''1102120''>a branch</span> <span m=''1102410''>mispredict</span> <span
  m=''1102970''>will</span> <span m=''1103280''>also</span> <span m=''1103620''>cost</span>
  <span m=''1103910''>you</span> <span m=''1104120''>somewhere</span> <span m=''1104410''>between</span>
  <span m=''1104680''>16</span> <span m=''1105130''>and 24</span> <span m=''1105580''>cycles,</span>
  <span m=''1106180''>depending</span> <span m=''1106520''>on</span> <span m=''1106610''>how</span>
  <span m=''1106750''>many</span> <span m=''1107520''>pipeline</span> <span m=''1107890''>stages</span>
  <span m=''1108270''>are</span> <span m=''1108380''>actually</span> <span m=''1108780''>in</span>
  <span m=''1108890''>the</span> <span m=''1108980''>Nehalem,</span> <span m=''1109560''>which</span>
  <span m=''1110080''>we</span> <span m=''1110200''>don''t</span> <span m=''1110370''>know.</span>
  <span m=''1112080''>So</span> <span m=''1112450''>bad</span> <span m=''1112760''>branch</span>
  <span m=''1113000''>predictions</span> <span m=''1113580''>might</span> <span m=''1113870''>just</span>
  <span m=''1114080''>be</span> <span m=''1114270''>as</span> <span m=''1114420''>costly</span>
  <span m=''1114960''>as</span> <span m=''1115570''>bad</span> <span m=''1115810''>memory</span>
  <span m=''1116120''>access</span> <span m=''1116570''>patterns.</span> <span m=''1117000''>And</span>
  <span m=''1117210''>plus,</span> <span m=''1117790''>Charles</span> <span m=''1118120''>is</span>
  <span m=''1118230''>going</span> <span m=''1118380''>to</span> <span m=''1118420''>go</span>
  <span m=''1118620''>into</span> <span m=''1118770''>detail</span> <span m=''1119150''>about</span>
  <span m=''1119410''>memory</span> <span m=''1119780''>access</span> <span m=''1120140''>patterns</span>
  <span m=''1120470''>and</span> <span m=''1120570''>how</span> <span m=''1120670''>to</span>
  <span m=''1120780''>optimize</span> <span m=''1121270''>sorting</span> <span m=''1121630''>for</span>
  <span m=''1121840''>good</span> <span m=''1122050''>memory</span> <span m=''1122360''>access.</span>
  <span m=''1122860''>So</span> <span m=''1123320''>it</span> <span m=''1123390''>wouldn''t</span>
  <span m=''1123550''>be</span> <span m=''1123700''>interesting</span> <span m=''1124120''>if</span>
  <span m=''1124240''>I</span> <span m=''1124340''>talked</span> <span m=''1124600''>about</span>
  <span m=''1124810''>that</span> <span m=''1124980''>right</span> <span m=''1125160''>now.</span>
  </p><p><span m=''1125650''>So</span> <span m=''1125820''>let''s</span> <span m=''1126030''>optimize</span>
  <span m=''1126950''>branching.</span> <span m=''1130230''>So</span> <span m=''1130500''>to</span>
  <span m=''1130620''>do</span> <span m=''1130800''>that,</span> <span m=''1131370''>we''ll</span>
  <span m=''1131500''>use</span> <span m=''1131750''>a</span> <span m=''1131820''>bit</span>
  <span m=''1132060''>hack</span> <span m=''1132420''>that</span> <span m=''1132780''>Charles</span>
  <span m=''1133160''>introduced</span> <span m=''1133670''>in</span> <span m=''1133770''>an</span>
  <span m=''1133900''>earlier</span> <span m=''1134260''>lecture.</span> <span m=''1135140''>So</span>
  <span m=''1135380''>remember,</span> <span m=''1135850''>all</span> <span m=''1136070''>we</span>
  <span m=''1136200''>want</span> <span m=''1136450''>to</span> <span m=''1136540''>do</span>
  <span m=''1137160''>is</span> <span m=''1140970''>we</span> <span m=''1141100''>want</span>
  <span m=''1141290''>to</span> <span m=''1141380''>put</span> <span m=''1141590''>the</span>
  <span m=''1141670''>minimum</span> <span m=''1142150''>of</span> <span m=''1142270''>either</span>
  <span m=''1142550''>A</span> <span m=''1142650''>or</span> <span m=''1142790''>B</span>
  <span m=''1143200''>into</span> <span m=''1143460''>C.</span> <span m=''1144460''>So</span>
  <span m=''1144880''>right</span> <span m=''1145070''>now,</span> <span m=''1145230''>we''re</span>
  <span m=''1145340''>using</span> <span m=''1145630''>branches</span> <span m=''1146120''>to</span>
  <span m=''1146180''>do</span> <span m=''1146390''>it.</span> <span m=''1146520''>But</span>
  <span m=''1146720''>there''s</span> <span m=''1146900''>no</span> <span m=''1147060''>reason</span>
  <span m=''1147390''>why</span> <span m=''1147500''>we</span> <span m=''1147630''>have</span>
  <span m=''1147890''>to.</span> <span m=''1148400''>So</span> <span m=''1148600''>the</span>
  <span m=''1148720''>trick</span> <span m=''1148960''>that</span> <span m=''1149090''>will</span>
  <span m=''1149250''>apply</span> <span m=''1149650''>is</span> <span m=''1150280''>the</span>
  <span m=''1150430''>XOR</span> <span m=''1150870''>trick</span> <span m=''1151180''>for</span>
  <span m=''1151400''>calculating</span> <span m=''1152050''>min</span> <span m=''1152310''>without</span>
  <span m=''1152630''>a</span> <span m=''1152670''>branch.</span> <span m=''1154040''>Does</span>
  <span m=''1154230''>everybody</span> <span m=''1154710''>kind</span> <span m=''1154980''>of</span>
  <span m=''1155050''>follow</span> <span m=''1155700''>what</span> <span m=''1155910''>that</span>
  <span m=''1156440''>code</span> <span m=''1156690''>is</span> <span m=''1156820''>doing?</span>
  <span m=''1157650''>You</span> <span m=''1157770''>can</span> <span m=''1157900''>refer</span>
  <span m=''1158170''>to</span> <span m=''1158270''>the</span> <span m=''1158380''>bit</span>
  <span m=''1158560''>hacks</span> <span m=''1158970''>lecture</span> <span m=''1159670''>later</span>
  <span m=''1160490''>to</span> <span m=''1161310''>check.</span> <span m=''1161620''>But</span>
  <span m=''1161920''>trust</span> <span m=''1162220''>us</span> <span m=''1162330''>that</span>
  <span m=''1162460''>it''s</span> <span m=''1162630''>correct.</span> </p><p><span
  m=''1164116''>GUEST SPEAKER 1: [INAUDIBLE]</span> </p><p><span m=''1165820''>GUEST
  SPEAKER 2: All</span> <span m=''1165920''>right.</span> <span m=''1166130''>I</span>
  <span m=''1166190''>guess</span> <span m=''1166380''>we</span> <span m=''1166590''>can
  go</span> <span m=''1166810''>over</span> <span m=''1166960''>it.</span> <span m=''1169261''>Do</span>
  <span m=''1169680''>I</span> <span m=''1169800''>have</span> <span m=''1169910''>a</span>
  <span m=''1169990''>mouse</span> <span m=''1170250''>pointer?</span> <span m=''1171360''>Cool.</span>
  <span m=''1172290''>OK,</span> <span m=''1172580''>so</span> <span m=''1172760''>inside,</span>
  <span m=''1174190''>you''re</span> <span m=''1174360''>doing</span> <span m=''1174730''>a</span>
  <span m=''1175000''>comparing</span> <span m=''1175780''>A</span> <span m=''1176060''>is</span>
  <span m=''1176280''>less</span> <span m=''1176500''>than</span> <span m=''1176720''>B,</span>
  <span m=''1177045''>the</span> <span m=''1177370''>value</span> <span m=''1177840''>of
  A is</span> <span m=''1178110''>less</span> <span m=''1178290''>than</span> <span
  m=''1178390''>the</span> <span m=''1178420''>value</span> <span m=''1178670''>of</span>
  <span m=''1178730''>B.</span> <span m=''1179210''>And</span> <span m=''1179350''>you
  store</span> <span m=''1179700''>either</span> <span m=''1179850''>a</span> <span
  m=''1179950''>0 or</span> <span m=''1180330''>1</span> <span m=''1180610''>into</span>
  <span m=''1180920''>a</span> <span m=''1180970''>flag</span> <span m=''1181330''>called</span>
  <span m=''1181570''>CMP.</span> <span m=''1182940''>And</span> <span m=''1183100''>then</span>
  <span m=''1183390''>you</span> <span m=''1183510''>take</span> <span m=''1184420''>CMP,</span>
  <span m=''1185060''>and you</span> <span m=''1185250''>negate</span> <span m=''1185710''>it.</span>
  <span m=''1185880''>So</span> <span m=''1186070''>then</span> <span m=''1186260''>you</span>
  <span m=''1186400''>end</span> <span m=''1186610''>up</span> <span m=''1186730''>with</span>
  <span m=''1186870''>a</span> <span m=''1186920''>bit</span> <span m=''1187160''>mask</span>
  <span m=''1187410''>of</span> <span m=''1187530''>either</span> <span m=''1187860''>all</span>
  <span m=''1188070''>0''s</span> <span m=''1188520''>or</span> <span m=''1188710''>all</span>
  <span m=''1188960''>1''s,</span> <span m=''1190060''>depending</span> <span m=''1190450''>on</span>
  <span m=''1190800''>which</span> <span m=''1191000''>one</span> <span m=''1191160''>was</span>
  <span m=''1191270''>smaller.</span> <span m=''1192130''>And</span> <span m=''1192310''>then</span>
  <span m=''1192590''>you</span> <span m=''1192890''>mask</span> <span m=''1193580''>A</span>
  <span m=''1193830''>XOR</span> <span m=''1194180''>B</span> <span m=''1194390''>with</span>
  <span m=''1194560''>that.</span> <span m=''1195130''>So</span> <span m=''1195980''>this</span>
  <span m=''1196260''>inner</span> <span m=''1196530''>expression,</span> <span m=''1197080''>you</span>
  <span m=''1197240''>either</span> <span m=''1197470''>get</span> <span m=''1197770''>A</span>
  <span m=''1197970''>XOR</span> <span m=''1198310''>B</span> <span m=''1198550''>out</span>
  <span m=''1198690''>of</span> <span m=''1198820''>it,</span> <span m=''1199170''>or</span>
  <span m=''1199310''>you</span> <span m=''1199390''>get</span> <span m=''1199800''>all</span>
  <span m=''1200020''>0''s.</span> <span m=''1201090''>And</span> <span m=''1201250''>then</span>
  <span m=''1201520''>you</span> <span m=''1201710''>XOR</span> <span m=''1202170''>B</span>
  <span m=''1202510''>into</span> <span m=''1202860''>it.</span> </p><p><span m=''1203390''>So</span>
  <span m=''1203750''>in</span> <span m=''1203890''>one</span> <span m=''1204130''>case,</span>
  <span m=''1204700''>B</span> <span m=''1205340''>XOR</span> <span m=''1205920''>this</span>
  <span m=''1206130''>expression</span> <span m=''1207040''>cancels</span> <span m=''1207450''>out</span>
  <span m=''1207610''>the</span> <span m=''1207680''>B.</span> <span m=''1207990''>You''ll</span>
  <span m=''1208130''>just</span> <span m=''1208360''>get</span> <span m=''1208540''>A</span>
  <span m=''1208740''>out.</span> <span m=''1209450''>And</span> <span m=''1209610''>the</span>
  <span m=''1209750''>other</span> <span m=''1209930''>way,</span> <span m=''1210580''>B</span>
  <span m=''1210900''>XOR</span> <span m=''1211680''>0</span> <span m=''1211980''>is</span>
  <span m=''1212280''>going</span> <span m=''1212400''>to</span> <span m=''1212500''>give</span>
  <span m=''1212670''>you</span> <span m=''1212750''>B.</span> <span m=''1213420''>So</span>
  <span m=''1214390''>that</span> <span m=''1214670''>should</span> <span m=''1214800''>be</span>
  <span m=''1214950''>convincing</span> <span m=''1215620''>motivation</span> <span
  m=''1216260''>that</span> <span m=''1216480''>this</span> <span m=''1216640''>is</span>
  <span m=''1216790''>actually</span> <span m=''1217150''>a</span> <span m=''1217290''>min</span>
  <span m=''1217430''>function.</span> <span m=''1218530''>And</span> <span m=''1218710''>then,</span>
  <span m=''1219510''>once</span> <span m=''1219730''>you</span> <span m=''1219890''>have</span>
  <span m=''1220050''>that,</span> <span m=''1220240''>you</span> <span m=''1220510''>can</span>
  <span m=''1220790''>do</span> <span m=''1220940''>cute</span> <span m=''1221160''>tricks</span>
  <span m=''1221470''>to</span> <span m=''1221580''>recycle</span> <span m=''1222040''>the</span>
  <span m=''1222130''>flags,</span> <span m=''1222540''>to</span> <span m=''1222800''>do</span>
  <span m=''1222970''>the</span> <span m=''1223140''>A++</span> <span m=''1223630''>and</span>
  <span m=''1224680''>B++</span> <span m=''1225370''>and</span> <span m=''1225470''>so</span>
  <span m=''1225670''>on,</span> <span m=''1225870''>using</span> <span m=''1226230''>CMP.</span>
  </p><p><span m=''1228530''>So</span> <span m=''1230340''>next,</span> <span m=''1230910''>let''s</span>
  <span m=''1231270''>run</span> <span m=''1231510''>this</span> <span m=''1231710''>code</span>
  <span m=''1231950''>and</span> <span m=''1232060''>see</span> <span m=''1232200''>what</span>
  <span m=''1232320''>happens.</span> <span m=''1240780''>OK,</span> <span m=''1241050''>so</span>
  <span m=''1241380''>we</span> <span m=''1241560''>went</span> <span m=''1241850''>from</span>
  <span m=''1244820''>5.04</span> <span m=''1245370''>seconds</span> <span m=''1245980''>to</span>
  <span m=''1246190''>4.59</span> <span m=''1247090''>seconds.</span> <span m=''1249820''>And</span>
  <span m=''1250220''>we''ll</span> <span m=''1250450''>do</span> <span m=''1250620''>a</span>
  <span m=''1250680''>profiling</span> <span m=''1251200''>run</span> <span m=''1251420''>just</span>
  <span m=''1251600''>to</span> <span m=''1251690''>get</span> <span m=''1251840''>some</span>
  <span m=''1251970''>stats</span> <span m=''1252330''>on</span> <span m=''1252510''>it.</span>
  <span m=''1255260''>OK,</span> <span m=''1255520''>so</span> <span m=''1255900''>now</span>
  <span m=''1256300''>look</span> <span m=''1256570''>at</span> <span m=''1256710''>the</span>
  <span m=''1256970''>IPC.</span> <span m=''1258390''>We</span> <span m=''1258560''>went</span>
  <span m=''1258840''>from</span> <span m=''1259900''>1.1</span> <span m=''1260770''>to</span>
  <span m=''1260930''>1.7--</span> <span m=''1264020''>1.7.</span> <span m=''1265210''>And</span>
  <span m=''1265780''>branch</span> <span m=''1266120''>misses</span> <span m=''1266710''>went</span>
  <span m=''1267020''>down</span> <span m=''1267280''>by</span> <span m=''1267470''>a</span>
  <span m=''1267520''>factor</span> <span m=''1267870''>of</span> <span m=''1267930''>10,</span>
  <span m=''1268730''>which</span> <span m=''1268920''>is</span> <span m=''1269180''>really</span>
  <span m=''1269500''>awesome.</span> <span m=''1270760''>But</span> <span m=''1271870''>overall,</span>
  <span m=''1272380''>the</span> <span m=''1272550''>performance</span> <span m=''1273170''>didn''t</span>
  <span m=''1273440''>seem</span> <span m=''1273630''>to</span> <span m=''1273770''>improve</span>
  <span m=''1274110''>by</span> <span m=''1274270''>much.</span> </p><p><span m=''1275600''>Well,</span>
  <span m=''1275910''>if</span> <span m=''1276020''>you</span> <span m=''1276120''>want</span>
  <span m=''1276320''>to</span> <span m=''1276400''>look</span> <span m=''1276610''>at</span>
  <span m=''1276740''>why,</span> <span m=''1277380''>look</span> <span m=''1277570''>at</span>
  <span m=''1277640''>the</span> <span m=''1277750''>total</span> <span m=''1277990''>number</span>
  <span m=''1278240''>of</span> <span m=''1278330''>instructions</span> <span m=''1278880''>executed.</span>
  <span m=''1280610''>That''s</span> <span m=''1281640''>that</span> <span m=''1281860''>number</span>
  <span m=''1282220''>versus</span> <span m=''1282930''>that</span> <span m=''1283350''>number.</span>
  <span m=''1284130''>We</span> <span m=''1284590''>seem</span> <span m=''1284800''>to</span>
  <span m=''1284880''>be</span> <span m=''1285000''>executing</span> <span m=''1285440''>considerably</span>
  <span m=''1285980''>more</span> <span m=''1286200''>instructions.</span> <span m=''1287460''>So</span>
  <span m=''1288430''>to</span> <span m=''1288600''>see</span> <span m=''1288840''>why</span>
  <span m=''1289230''>that''s</span> <span m=''1289550''>the</span> <span m=''1289640''>case,</span>
  <span m=''1290180''>we</span> <span m=''1290390''>decided</span> <span m=''1290770''>to</span>
  <span m=''1290850''>use</span> <span m=''1291110''>another</span> <span m=''1291520''>mode</span>
  <span m=''1291870''>of</span> <span m=''1292080''>perf</span> <span m=''1292450''>called</span>
  <span m=''1292740''>report,</span> <span m=''1293820''>or</span> <span m=''1294130''>record</span>
  <span m=''1294610''>and</span> <span m=''1294740''>then</span> <span m=''1294950''>report.</span>
  <span m=''1296040''>So</span> <span m=''1296310''>what</span> <span m=''1296590''>this</span>
  <span m=''1296810''>does</span> <span m=''1297120''>is</span> <span m=''1297260''>that</span>
  <span m=''1297550''>it</span> <span m=''1297680''>logs</span> <span m=''1298960''>where</span>
  <span m=''1299460''>all</span> <span m=''1299700''>of</span> <span m=''1299800''>those</span>
  <span m=''1300500''>interrupts</span> <span m=''1300980''>actually</span> <span
  m=''1301300''>happen.</span> <span m=''1301720''>So</span> <span m=''1301860''>it</span>
  <span m=''1301940''>logs</span> <span m=''1302390''>which</span> <span m=''1302620''>point</span>
  <span m=''1302900''>in</span> <span m=''1302990''>your</span> <span m=''1303130''>code</span>
  <span m=''1304040''>the</span> <span m=''1304160''>CPU</span> <span m=''1304600''>was</span>
  <span m=''1304770''>executing</span> <span m=''1305580''>when</span> <span m=''1305900''>these</span>
  <span m=''1306130''>performance</span> <span m=''1306580''>counters</span> <span
  m=''1306930''>tripped.</span> </p><p><span m=''1307730''>And</span> <span m=''1307910''>then</span>
  <span m=''1308210''>it</span> <span m=''1308410''>generates</span> <span m=''1308840''>a</span>
  <span m=''1308900''>nice</span> <span m=''1309220''>report</span> <span m=''1309890''>that</span>
  <span m=''1310030''>we</span> <span m=''1310160''>can</span> <span m=''1310350''>call</span>
  <span m=''1310690''>using</span> <span m=''1311040''>perf</span> <span m=''1311890''>annotate.</span>
  <span m=''1312880''>And</span> <span m=''1314310''>the</span> <span m=''1314420''>top</span>
  <span m=''1314680''>section</span> <span m=''1315140''>gives</span> <span m=''1315330''>you</span>
  <span m=''1315480''>a</span> <span m=''1315530''>sorted</span> <span m=''1315880''>summary,</span>
  <span m=''1316250''>where</span> <span m=''1317630''>it</span> <span m=''1317790''>shows</span>
  <span m=''1318110''>you</span> <span m=''1318240''>the</span> <span m=''1318360''>percent</span>
  <span m=''1318600''>of</span> <span m=''1318830''>times</span> <span m=''1319100''>that</span>
  <span m=''1319300''>perf</span> <span m=''1319580''>caught</span> <span m=''1319830''>your</span>
  <span m=''1319910''>program</span> <span m=''1320340''>executing</span> <span m=''1320950''>that</span>
  <span m=''1321140''>line</span> <span m=''1321350''>of</span> <span m=''1321410''>code.</span>
  <span m=''1321720''>So</span> <span m=''1322410''>11%</span> <span m=''1323100''>of</span>
  <span m=''1323200''>the</span> <span m=''1323290''>times</span> <span m=''1323660''>that</span>
  <span m=''1323930''>perf</span> <span m=''1324590''>triggered</span> <span m=''1325020''>its</span>
  <span m=''1325170''>interrupt,</span> <span m=''1326360''>your</span> <span m=''1326530''>code</span>
  <span m=''1326820''>was</span> <span m=''1327190''>executing</span> <span m=''1327610''>mergesort.c</span>
  <span m=''1328250''>line</span> <span m=''1328460''>32.</span> </p><p><span m=''1329650''>So</span>
  <span m=''1330140''>let''s</span> <span m=''1330350''>go</span> <span m=''1330480''>to</span>
  <span m=''1330550''>mergesort.c</span> <span m=''1331400''>line</span> <span m=''1331600''>32</span>
  <span m=''1332670''>and</span> <span m=''1332900''>see</span> <span m=''1333060''>what</span>
  <span m=''1333200''>it''s</span> <span m=''1333350''>doing.</span> <span m=''1335720''>So</span>
  <span m=''1336470''>this</span> <span m=''1336730''>annotated</span> <span m=''1337190''>view</span>
  <span m=''1337520''>shows</span> <span m=''1337840''>you</span> <span m=''1338080''>the</span>
  <span m=''1338450''>lines</span> <span m=''1338890''>of</span> <span m=''1339010''>C-code,</span>
  <span m=''1339780''>which</span> <span m=''1340000''>are</span> <span m=''1340160''>in</span>
  <span m=''1340300''>black.</span> <span m=''1341900''>C-code</span> <span m=''1342440''>is</span>
  <span m=''1342570''>in</span> <span m=''1342670''>black.</span> <span m=''1343490''>And</span>
  <span m=''1343670''>then</span> <span m=''1344050''>line</span> <span m=''1344560''>numbers</span>
  <span m=''1344940''>are</span> <span m=''1345060''>annotated</span> <span m=''1345510''>here.</span>
  <span m=''1346030''>And</span> <span m=''1346170''>then</span> <span m=''1346350''>it</span>
  <span m=''1346510''>actually</span> <span m=''1346880''>goes</span> <span m=''1347150''>ahead</span>
  <span m=''1347470''>and</span> <span m=''1347630''>shows</span> <span m=''1347970''>you</span>
  <span m=''1348540''>the</span> <span m=''1348660''>assembly</span> <span m=''1349170''>instructions</span>
  <span m=''1349850''>that</span> <span m=''1350010''>it''s</span> <span m=''1350220''>executing.</span>
  <span m=''1351680''>And</span> <span m=''1351860''>it</span> <span m=''1351950''>puts</span>
  <span m=''1352220''>the</span> <span m=''1352320''>timing</span> <span m=''1352710''>actually</span>
  <span m=''1353050''>on</span> <span m=''1353200''>the</span> <span m=''1353300''>assembly</span>
  <span m=''1353900''>instructions</span> <span m=''1354530''>corresponding</span>
  <span m=''1355100''>to</span> <span m=''1355200''>every</span> <span m=''1355450''>C</span>
  <span m=''1355930''>expression.</span> <span m=''1356680''>Yes?</span> </p><p><span
  m=''1357546''>AUDIENCE:</span> <span m=''1358032''>Why is</span> <span m=''1358518''>this</span>
  <span m=''1359004''>[INAUDIBLE]</span> <span m=''1359490''>is</span> <span m=''1359976''>the</span>
  <span m=''1360462''>annotated</span> <span m=''1360948''>version--</span> </p><p><span
  m=''1361440''>GUEST SPEAKER 2: Yeah,</span> <span m=''1362380''>you</span> <span
  m=''1362500''>call</span> <span m=''1362810''>perf</span> <span m=''1363170''>annotate</span>
  <span m=''1363680''>and</span> <span m=''1363830''>then</span> <span m=''1364020''>a</span>
  <span m=''1364070''>function</span> <span m=''1364510''>name.</span> <span m=''1365770''>The</span>
  <span m=''1365890''>Project</span> <span m=''1366290''>2.1</span> <span m=''1366840''>will</span>
  <span m=''1367090''>walk</span> <span m=''1367330''>you</span> <span m=''1367440''>through</span>
  <span m=''1367650''>doing</span> <span m=''1367900''>this</span> <span m=''1368070''>a</span>
  <span m=''1368130''>couple</span> <span m=''1368360''>of</span> <span m=''1368440''>times.</span>
  <span m=''1368730''>So</span> <span m=''1369070''>you''ll</span> <span m=''1369220''>be</span>
  <span m=''1369360''>able</span> <span m=''1369540''>to</span> <span m=''1369670''>see</span>
  <span m=''1370260''>what</span> <span m=''1370420''>it''s</span> <span m=''1370560''>doing.</span>
  </p><p><span m=''1372170''>OK,</span> <span m=''1372530''>so</span> <span m=''1373610''>the</span>
  <span m=''1373740''>assembly</span> <span m=''1374160''>here</span> <span m=''1374400''>is</span>
  <span m=''1374530''>actually</span> <span m=''1376010''>pretty</span> <span m=''1376280''>important.</span>
  <span m=''1378270''>I</span> <span m=''1378350''>guess</span> <span m=''1379690''>everybody''s</span>
  <span m=''1380120''>taken</span> <span m=''1380350''>6004,</span> <span m=''1380870''>or</span>
  <span m=''1381290''>some</span> <span m=''1381540''>variant,</span> <span m=''1381890''>where</span>
  <span m=''1382030''>you</span> <span m=''1382140''>had</span> <span m=''1382240''>to</span>
  <span m=''1382380''>code</span> <span m=''1382730''>some</span> <span m=''1382960''>form</span>
  <span m=''1383220''>of</span> <span m=''1383330''>assembly?</span> <span m=''1384110''>OK,</span>
  <span m=''1384350''>it''s</span> <span m=''1384470''>a</span> <span m=''1384520''>prereq.</span>
  <span m=''1386370''>Cool.</span> <span m=''1386940''>So</span> <span m=''1387615''>Saman</span>
  <span m=''1388270''>will</span> <span m=''1388390''>talk</span> <span m=''1388610''>more</span>
  <span m=''1388800''>about</span> <span m=''1389010''>assembly.</span> <span m=''1389470''>But</span>
  <span m=''1389660''>in</span> <span m=''1389750''>this</span> <span m=''1389960''>case--</span>
  <span m=''1390300''>or</span> <span m=''1390620''>Charles,</span> <span m=''1391070''>actually,</span>
  <span m=''1391390''>now will</span> <span m=''1391780''>talk</span> <span m=''1392050''>more</span>
  <span m=''1392190''>about</span> <span m=''1392390''>assembly.</span> <span m=''1393590''>But</span>
  <span m=''1393780''>anyway,</span> <span m=''1394300''>in</span> <span m=''1394420''>this</span>
  <span m=''1394610''>case,</span> <span m=''1394890''>it</span> <span m=''1394950''>was</span>
  <span m=''1395160''>actually</span> <span m=''1395510''>kind</span> <span m=''1395700''>of</span>
  <span m=''1395770''>useful</span> <span m=''1396110''>to</span> <span m=''1396190''>look</span>
  <span m=''1396350''>at</span> <span m=''1396500''>the</span> <span m=''1396600''>assembly.</span>
  <span m=''1397660''>We</span> <span m=''1397810''>won''t</span> <span m=''1398700''>expect</span>
  <span m=''1398965''>you</span> <span m=''1399230''>to</span> <span m=''1399330''>know</span>
  <span m=''1400210''>how</span> <span m=''1400370''>to</span> <span m=''1400520''>write</span>
  <span m=''1400830''>assembly</span> <span m=''1401640''>for</span> <span m=''1401790''>this</span>
  <span m=''1402020''>class</span> <span m=''1402350''>or</span> <span m=''1402620''>expect</span>
  <span m=''1402950''>you</span> <span m=''1403040''>to</span> <span m=''1403150''>write</span>
  <span m=''1403340''>high-performing</span> <span m=''1403940''>assembly.</span>
  <span m=''1404760''>But</span> <span m=''1405060''>sometimes</span> <span m=''1405490''>taking</span>
  <span m=''1405740''>a</span> <span m=''1405800''>look</span> <span m=''1405990''>at</span>
  <span m=''1406070''>what</span> <span m=''1406210''>the</span> <span m=''1406290''>compiler</span>
  <span m=''1406790''>outputs</span> <span m=''1407190''>can</span> <span m=''1407310''>really</span>
  <span m=''1407560''>help</span> <span m=''1407790''>you.</span> </p><p><span m=''1408250''>Well,</span>
  <span m=''1408580''>in</span> <span m=''1408720''>this</span> <span m=''1408860''>case,</span>
  <span m=''1409670''>what</span> <span m=''1409970''>caught</span> <span m=''1410190''>our</span>
  <span m=''1410360''>eye</span> <span m=''1410490''>was</span> <span m=''1410690''>this</span>
  <span m=''1410840''>cltq</span> <span m=''1411730''>thing,</span> <span m=''1412400''>because</span>
  <span m=''1413410''>none</span> <span m=''1413660''>of</span> <span m=''1413790''>us</span>
  <span m=''1413970''>in</span> <span m=''1414220''>the</span> <span m=''1414350''>room</span>
  <span m=''1414560''>knew</span> <span m=''1414740''>what</span> <span m=''1415000''>the</span>
  <span m=''1415070''>heck</span> <span m=''1415600''>cltq</span> <span m=''1416480''>was</span>
  <span m=''1416860''>It</span> <span m=''1417090''>wasn''t</span> <span m=''1417230''>an</span>
  <span m=''1417690''>assembly</span> <span m=''1418070''>instruction</span> <span
  m=''1418430''>that you</span> <span m=''1418550''>usually</span> <span m=''1418930''>see.</span>
  <span m=''1419440''>So</span> <span m=''1419630''>that</span> <span m=''1419820''>caught
  our</span> <span m=''1420170''>eye.</span> <span m=''1420340''>And we</span> <span
  m=''1420490''>wondered</span> <span m=''1420830''>what</span> <span m=''1421030''>was</span>
  <span m=''1421210''>this</span> <span m=''1421370''>assembly</span> <span m=''1421770''>doing.</span>
  <span m=''1422390''>So</span> <span m=''1422560''>we</span> <span m=''1422680''>spent</span>
  <span m=''1423000''>a</span> <span m=''1423050''>little</span> <span m=''1423240''>bit</span>
  <span m=''1423390''>of</span> <span m=''1423490''>time</span> <span m=''1423770''>tracing</span>
  <span m=''1424180''>through</span> <span m=''1424370''>this,</span> <span m=''1424990''>working</span>
  <span m=''1425450''>out</span> <span m=''1425600''>what</span> <span m=''1425740''>the</span>
  <span m=''1425830''>compiler was</span> <span m=''1426320''>doing.</span> </p><p><span
  m=''1426960''>So</span> <span m=''1427610''>in</span> <span m=''1428260''>PowerPoint,</span>
  <span m=''1430660''>I</span> <span m=''1431030''>pulled</span> <span m=''1431280''>out</span>
  <span m=''1431430''>this</span> <span m=''1431620''>code.</span> <span m=''1432240''>And</span>
  <span m=''1432690''>OK,</span> <span m=''1432980''>so</span> <span m=''1433160''>I</span>
  <span m=''1433290''>looked</span> <span m=''1433580''>up</span> <span m=''1433710''>cltq</span>
  <span m=''1434480''>in</span> <span m=''1434750''>my</span> <span m=''1435270''>600-page</span>
  <span m=''1436150''>Intel</span> <span m=''1436480''>manual.</span> <span m=''1438120''>Yes,</span>
  <span m=''1438330''>your</span> <span m=''1438440''>processor</span> <span m=''1438900''>does</span>
  <span m=''1439130''>come</span> <span m=''1439290''>with</span> <span m=''1439390''>a</span>
  <span m=''1439490''>manual.</span> <span m=''1441250''>So</span> <span m=''1441460''>cltq,</span>
  <span m=''1442220''>it</span> <span m=''1442310''>says,</span> <span m=''1442840''>sign</span>
  <span m=''1443320''>extends</span> <span m=''1443940''>the</span> <span m=''1444100''>EAX</span>
  <span m=''1444620''>register</span> <span m=''1445100''>to</span> <span m=''1445210''>64</span>
  <span m=''1445690''>bits</span> <span m=''1446170''>and</span> <span m=''1446320''>then</span>
  <span m=''1446460''>places</span> <span m=''1446920''>that</span> <span m=''1447160''>into</span>
  <span m=''1447420''>RAX.</span> </p><p><span m=''1448830''>Why</span> <span m=''1449150''>is</span>
  <span m=''1449290''>it sign</span> <span m=''1449660''>extending?</span> <span m=''1450900''>OK,</span>
  <span m=''1451210''>so</span> <span m=''1452720''>let''s</span> <span m=''1453060''>try</span>
  <span m=''1453250''>to</span> <span m=''1453550''>trace</span> <span m=''1453860''>through</span>
  <span m=''1454110''>what</span> <span m=''1454180''>the</span> <span m=''1454280''>assembly''s</span>
  <span m=''1454730''>doing.</span> <span m=''1455250''>So</span> <span m=''1455550''>here,</span>
  <span m=''1456300''>we</span> <span m=''1456410''>wanted</span> <span m=''1456730''>to</span>
  <span m=''1456830''>do</span> <span m=''1457470''>comp</span> <span m=''1457930''>equals</span>
  <span m=''1458340''>star</span> <span m=''1458770''>A</span> <span m=''1459320''>less</span>
  <span m=''1459560''>than</span> <span m=''1459700''>star</span> <span m=''1459990''>B.</span>
  <span m=''1460600''>So</span> <span m=''1461680''>it</span> <span m=''1461970''>moves</span>
  <span m=''1462300''>the</span> <span m=''1462500''>value</span> <span m=''1463750''>at</span>
  <span m=''1463930''>the</span> <span m=''1464080''>address</span> <span m=''1464540''>in</span>
  <span m=''1464620''>register</span> <span m=''1465010''>14</span> <span m=''1465420''>into</span>
  <span m=''1465670''>RCX</span> <span m=''1466560''>and</span> <span m=''1466750''>does</span>
  <span m=''1466920''>the</span> <span m=''1467000''>same</span> <span m=''1467230''>thing</span>
  <span m=''1467420''>for</span> <span m=''1467520''>register</span> <span m=''1467970''>13.</span>
  <span m=''1468700''>So</span> <span m=''1468880''>assume</span> <span m=''1469320''>that</span>
  <span m=''1469910''>R14</span> <span m=''1470530''>and R13</span> <span m=''1470970''>are</span>
  <span m=''1471090''>A</span> <span m=''1471240''>and</span> <span m=''1471420''>B.</span>
  <span m=''1471950''>And</span> <span m=''1472190''>so</span> <span m=''1472360''>RCX</span>
  <span m=''1472900''>and</span> <span m=''1473000''>RDX</span> <span m=''1473520''>are</span>
  <span m=''1473670''>star</span> <span m=''1474060''>A and</span> <span m=''1474240''>star</span>
  <span m=''1474500''>B,</span> <span m=''1475390''>right?</span> </p><p><span m=''1476310''>And</span>
  <span m=''1476470''>then</span> <span m=''1476680''>it</span> <span m=''1476870''>XORs</span>
  <span m=''1477800''>ESI</span> <span m=''1478400''>with</span> <span m=''1478630''>ESI,</span>
  <span m=''1478990''>which</span> <span m=''1479210''>is</span> <span m=''1479320''>0.</span>
  <span m=''1479730''>So</span> <span m=''1479910''>it</span> <span m=''1480020''>zeroes</span>
  <span m=''1480350''>out</span> <span m=''1480500''>the</span> <span m=''1480580''>register</span>
  <span m=''1481160''>ESI.</span> <span m=''1482050''>And</span> <span m=''1482220''>then</span>
  <span m=''1482490''>it</span> <span m=''1482670''>does</span> <span m=''1482980''>a</span>
  <span m=''1483390''>compare</span> <span m=''1484380''>between</span> <span m=''1484900''>RCX</span>
  <span m=''1485460''>and</span> <span m=''1485620''>RDX,</span> <span m=''1486010''>which</span>
  <span m=''1486220''>is</span> <span m=''1486410''>the</span> <span m=''1486480''>value</span>
  <span m=''1486850''>at A</span> <span m=''1487140''>and the</span> <span m=''1487430''>value</span>
  <span m=''1487730''>at</span> <span m=''1487860''>B.</span> <span m=''1488380''>So</span>
  <span m=''1488630''>it</span> <span m=''1488730''>does</span> <span m=''1488910''>that</span>
  <span m=''1489070''>comparison.</span> <span m=''1490190''>And</span> <span m=''1490350''>then,</span>
  <span m=''1490520''>depending</span> <span m=''1490920''>on</span> <span m=''1491000''>the</span>
  <span m=''1491100''>result</span> <span m=''1491520''>of that</span> <span m=''1491690''>comparison,</span>
  <span m=''1492150''>it</span> <span m=''1492250''>writes</span> <span m=''1492520''>that</span>
  <span m=''1492670''>result</span> <span m=''1493090''>out</span> <span m=''1493350''>into</span>
  <span m=''1493580''>register</span> <span m=''1494050''>SIL--</span> </p><p><span
  m=''1496230''>GUEST SPEAKER 1: Which</span> <span m=''1496695''>is</span> <span
  m=''1497160''>the</span> <span m=''1497625''>low-byte--</span> </p><p><span m=''1498090''>GUEST
  SPEAKER 2: SIL,</span> <span m=''1498990''>as</span> <span m=''1499440''>Reid</span>
  <span m=''1499760''>said,</span> <span m=''1500200''>is</span> <span m=''1500470''>the</span>
  <span m=''1500660''>low-byte</span> <span m=''1501310''>of</span> <span m=''1501710''>the</span>
  <span m=''1501820''>register</span> <span m=''1502390''>ESI,</span> <span m=''1502870''>which</span>
  <span m=''1503090''>is</span> <span m=''1503180''>used</span> <span m=''1503430''>here.</span>
  <span m=''1504010''>But</span> <span m=''1504380''>before</span> <span m=''1504720''>that,</span>
  <span m=''1505090''>the</span> <span m=''1505260''>compiler</span> <span m=''1506020''>then</span>
  <span m=''1506650''>executes</span> <span m=''1507490''>this</span> <span m=''1507760''>expression</span>
  <span m=''1508280''>here,</span> <span m=''1509110''>B</span> <span m=''1509480''>XOR</span>
  <span m=''1509640''>a,</span> <span m=''1510620''>which</span> <span m=''1510880''>it</span>
  <span m=''1511030''>puts</span> <span m=''1511320''>into</span> <span m=''1511590''>register</span>
  <span m=''1512540''>RDX.</span> <span m=''1514210''>And</span> <span m=''1514380''>then,</span>
  <span m=''1514640''>finally,</span> <span m=''1515030''>it</span> <span m=''1515140''>takes</span>
  <span m=''1515390''>ESI,</span> <span m=''1515850''>which</span> <span m=''1516120''>contains</span>
  <span m=''1516760''>the</span> <span m=''1516850''>same</span> <span m=''1517080''>value</span>
  <span m=''1517420''>as</span> <span m=''1517710''>SIL,</span> <span m=''1518820''>and</span>
  <span m=''1518970''>then</span> <span m=''1519130''>it</span> <span m=''1519220''>moves</span>
  <span m=''1519540''>that</span> <span m=''1519850''>into</span> <span m=''1520290''>EAX.</span>
  <span m=''1521830''>And</span> <span m=''1522000''>then</span> <span m=''1522220''>it</span>
  <span m=''1522360''>negates</span> <span m=''1522850''>EAX.</span> <span m=''1523960''>OK,</span>
  <span m=''1524300''>so</span> <span m=''1524460''>that</span> <span m=''1524600''>kind</span>
  <span m=''1524780''>of</span> <span m=''1524830''>looks</span> <span m=''1525030''>like</span>
  <span m=''1525150''>negative</span> <span m=''1525480''>CMP,</span> <span m=''1526300''>right?</span>
  <span m=''1527025''>And then,</span> <span m=''1527480''>after</span> <span m=''1527810''>negating</span>
  <span m=''1528320''>it,</span> <span m=''1528880''>it</span> <span m=''1529010''>then</span>
  <span m=''1529180''>sign</span> <span m=''1529580''>extends</span> <span m=''1530060''>it</span>
  <span m=''1530270''>to a</span> <span m=''1530660''>64-bit</span> <span m=''1531420''>register.</span>
  <span m=''1532900''>And</span> <span m=''1533110''>then</span> <span m=''1533330''>it</span>
  <span m=''1533440''>does</span> <span m=''1533690''>the</span> <span m=''1534060''>en</span>
  <span m=''1534300''>masse</span> <span m=''1534600''>that</span> <span m=''1534720''>we</span>
  <span m=''1534870''>asked</span> <span m=''1535120''>it</span> <span m=''1535230''>to.</span>
  </p><p><span m=''1536410''>Well,</span> <span m=''1536660''>why</span> <span m=''1536860''>is</span>
  <span m=''1537000''>it</span> <span m=''1537120''>jumping</span> <span m=''1537440''>through</span>
  <span m=''1537600''>so</span> <span m=''1537780''>many</span> <span m=''1537990''>hoops</span>
  <span m=''1538240''>to</span> <span m=''1538340''>do</span> <span m=''1538490''>this?</span>
  <span m=''1539010''>Well,</span> <span m=''1539300''>it</span> <span m=''1539380''>turns</span>
  <span m=''1539630''>out,</span> <span m=''1539850''>when</span> <span m=''1540020''>you</span>
  <span m=''1540130''>declare</span> <span m=''1540710''>a</span> <span m=''1540820''>value</span>
  <span m=''1541300''>of</span> <span m=''1541460''>type</span> <span m=''1541790''>int,</span>
  <span m=''1542960''>you</span> <span m=''1543100''>say</span> <span m=''1543290''>that</span>
  <span m=''1543560''>it''s a</span> <span m=''1543620''>32-bit</span> <span m=''1544230''>value.</span>
  <span m=''1545040''>And</span> <span m=''1545350''>the</span> <span m=''1545430''>compiler</span>
  <span m=''1545900''>took</span> <span m=''1546030''>you</span> <span m=''1546210''>very</span>
  <span m=''1546530''>literally</span> <span m=''1547140''>in</span> <span m=''1547460''>saying</span>
  <span m=''1547790''>that</span> <span m=''1547950''>you</span> <span m=''1548070''>requested</span>
  <span m=''1548620''>a</span> <span m=''1548700''>32-bit</span> <span m=''1549330''>value.</span>
  <span m=''1549930''>So</span> <span m=''1550120''>it</span> <span m=''1550220''>did</span>
  <span m=''1550400''>a</span> <span m=''1550470''>32-bit</span> <span m=''1551200''>negation.</span>
  <span m=''1552060''>And</span> <span m=''1552230''>then</span> <span m=''1552410''>it</span>
  <span m=''1552530''>extended</span> <span m=''1553040''>that</span> <span m=''1553220''>to</span>
  <span m=''1553300''>64-bits.</span> <span m=''1554060''>So it</span> <span m=''1554300''>wasted</span>
  <span m=''1554720''>a</span> <span m=''1554770''>couple</span> <span m=''1555040''>of</span>
  <span m=''1555150''>instructions</span> <span m=''1556930''>doing</span> <span m=''1557230''>this,</span>
  <span m=''1557620''>instead</span> <span m=''1557960''>of</span> <span m=''1558060''>just</span>
  <span m=''1558360''>flat-out</span> <span m=''1558760''>doing</span> <span m=''1558980''>a</span>
  <span m=''1559030''>64-bit</span> <span m=''1559660''>negation</span> <span m=''1560100''>to</span>
  <span m=''1560180''>begin</span> <span m=''1560500''>with.</span> </p><p><span m=''1561590''>Now,</span>
  <span m=''1561790''>the</span> <span m=''1561900''>problem</span> <span m=''1563150''>with</span>
  <span m=''1563330''>this</span> <span m=''1563560''>is</span> <span m=''1563720''>usually</span>
  <span m=''1564320''>you</span> <span m=''1564420''>don''t</span> <span m=''1564590''>care</span>
  <span m=''1564810''>if</span> <span m=''1564880''>it</span> <span m=''1565000''>generates</span>
  <span m=''1565340''>one</span> <span m=''1565590''>XOR</span> <span m=''1565860''>assembly</span>
  <span m=''1566110''>instruction.</span> <span m=''1566550''>But</span> <span m=''1566730''>this</span>
  <span m=''1566910''>is</span> <span m=''1567030''>a</span> <span m=''1567130''>tight</span>
  <span m=''1567430''>loop</span> <span m=''1567690''>that''s</span> <span m=''1567920''>called</span>
  <span m=''1569680''>in</span> <span m=''1569800''>the</span> <span m=''1569910''>recursion</span>
  <span m=''1570380''>process</span> <span m=''1570950''>for</span> <span m=''1571160''>every</span>
  <span m=''1571430''>single</span> <span m=''1571700''>merge</span> <span m=''1571960''>that
  it''s</span> <span m=''1572220''>doing.</span> <span m=''1572520''>So</span> <span
  m=''1572780''>the</span> <span m=''1572910''>time</span> <span m=''1573150''>that</span>
  <span m=''1573300''>it</span> <span m=''1573460''>wastes</span> <span m=''1573800''>here</span>
  <span m=''1574120''>actually</span> <span m=''1574470''>really</span> <span m=''1574820''>adds</span>
  <span m=''1575060''>up.</span> </p><p><span m=''1576330''>So</span> <span m=''1576730''>how</span>
  <span m=''1576900''>do</span> <span m=''1576990''>we</span> <span m=''1577110''>fix</span>
  <span m=''1577380''>that?</span> <span m=''1578030''>Well,</span> <span m=''1579190''>instead</span>
  <span m=''1579510''>of</span> <span m=''1579600''>declaring</span> <span m=''1580050''>it</span>
  <span m=''1580170''>as</span> <span m=''1580340''>int,</span> <span m=''1580670''>let''s</span>
  <span m=''1581030''>just</span> <span m=''1581210''>try</span> <span m=''1581390''>replacing</span>
  <span m=''1581645''>it</span> <span m=''1581900''>with</span> <span m=''1582060''>long,</span>
  <span m=''1582750''>and</span> <span m=''1582900''>then</span> <span m=''1583030''>recompiler</span>
  <span m=''1583660''>the</span> <span m=''1583770''>code</span> <span m=''1584130''>and</span>
  <span m=''1584430''>see</span> <span m=''1584710''>if</span> <span m=''1584820''>things</span>
  <span m=''1585050''>are</span> <span m=''1585150''>any</span> <span m=''1585290''>different.</span>
  <span m=''1586200''>So</span> <span m=''1586910''>here</span> <span m=''1587140''>we</span>
  <span m=''1587250''>start</span> <span m=''1587500''>our</span> <span m=''1587670''>process</span>
  <span m=''1588100''>of</span> <span m=''1588330''>trial</span> <span m=''1588630''>and</span>
  <span m=''1588750''>error.</span> <span m=''1590800''>So</span> <span m=''1591980''>we</span>
  <span m=''1592270''>compiled</span> <span m=''1592740''>mergesort</span> <span m=''1593240''>long.</span>
  <span m=''1595170''>And</span> <span m=''1595830''>the</span> <span m=''1595960''>runtime</span>
  <span m=''1596610''>is</span> <span m=''1596950''>4.05</span> <span m=''1597680''>seconds.</span>
  <span m=''1598010''>Before,</span> <span m=''1598330''>it was,</span> <span m=''1598510''>like,</span>
  <span m=''1598660''>4.5</span> <span m=''1599410''>or</span> <span m=''1599540''>so.</span>
  <span m=''1600050''>So</span> <span m=''1600760''>the</span> <span m=''1600850''>runtime</span>
  <span m=''1601250''>definitely</span> <span m=''1601610''>improved.</span> <span
  m=''1603830''>Let''s</span> <span m=''1604020''>compare</span> <span m=''1604390''>it.</span>
  </p><p><span m=''1604665''>GUEST SPEAKER 1: Yeah, just</span> <span m=''1604940''>to
  verify.</span> </p><p><span m=''1606040''>GUEST SPEAKER 2: So</span> <span m=''1606310''>it</span>
  <span m=''1606400''>went</span> <span m=''1606590''>from</span> <span m=''1606740''>4.59</span>
  <span m=''1607620''>to</span> <span m=''1607750''>4.05,</span> <span m=''1609300''>which</span>
  <span m=''1609860''>definitely</span> <span m=''1610160''>is</span> <span m=''1610290''>an</span>
  <span m=''1610370''>improvement.</span> <span m=''1611580''>So</span> <span m=''1612310''>let''s</span>
  <span m=''1612780''>figure</span> <span m=''1613120''>out,</span> <span m=''1613690''>well,</span>
  <span m=''1614000''>let''s</span> <span m=''1614220''>see</span> <span m=''1614450''>if</span>
  <span m=''1614580''>it</span> <span m=''1614900''>generated</span> <span m=''1615380''>better</span>
  <span m=''1615670''>assembly.</span> <span m=''1617170''>So</span> <span m=''1617480''>we''ll</span>
  <span m=''1617670''>run</span> <span m=''1617890''>perf</span> <span m=''1618130''>record</span>
  <span m=''1619690''>in</span> <span m=''1619890''>order</span> <span m=''1620140''>to</span>
  <span m=''1620490''>look</span> <span m=''1620690''>at</span> <span m=''1620880''>perf</span>
  <span m=''1621250''>annotate</span> <span m=''1621730''>again.</span> <span m=''1624750''>And</span>
  <span m=''1625090''>OK,</span> <span m=''1625400''>once</span> <span m=''1625680''>again,</span>
  <span m=''1625960''>it''s</span> <span m=''1626100''>spending</span> <span m=''1626760''>14%</span>
  <span m=''1627400''>of</span> <span m=''1627480''>the</span> <span m=''1627560''>time</span>
  <span m=''1627870''>somewhere</span> <span m=''1628250''>in</span> <span m=''1628540''>mergesort.c,</span>
  <span m=''1629180''>which</span> <span m=''1629360''>is</span> <span m=''1629490''>hardly</span>
  <span m=''1629790''>surprising.</span> <span m=''1632490''>We''ll</span> <span m=''1632680''>go</span>
  <span m=''1632840''>to</span> <span m=''1633080''>line</span> <span m=''1635430''>27</span>
  <span m=''1636940''>and,</span> <span m=''1639280''>yeah,</span> <span m=''1640080''>use</span>
  <span m=''1640370''>long.</span> <span m=''1640620''>OK,</span> <span m=''1640880''>so</span>
  <span m=''1641020''>that''s</span> <span m=''1641240''>roughly</span> <span m=''1641550''>the</span>
  <span m=''1641650''>assembly.</span> </p><p><span m=''1642510''>And</span> <span
  m=''1644290''>Reid,</span> <span m=''1645300''>although</span> <span m=''1645560''>he</span>
  <span m=''1645710''>wasted</span> <span m=''1646170''>time</span> <span m=''1646360''>to</span>
  <span m=''1646460''>find</span> <span m=''1646770''>it,</span> <span m=''1648320''>I</span>
  <span m=''1648430''>have</span> <span m=''1648640''>a</span> <span m=''1648910''>nicely</span>
  <span m=''1649260''>prepared</span> <span m=''1649620''>screen</span> <span m=''1649930''>shot</span>
  <span m=''1650240''>of</span> <span m=''1650340''>the</span> <span m=''1650430''>same</span>
  <span m=''1650670''>section</span> <span m=''1651010''>of</span> <span m=''1651080''>code.</span>
  <span m=''1651750''>So</span> <span m=''1653190''>it</span> <span m=''1653410''>looks</span>
  <span m=''1653730''>cleaner.</span> <span m=''1657490''>It</span> <span m=''1657650''>loads</span>
  <span m=''1658300''>A</span> <span m=''1658430''>and</span> <span m=''1658580''>B</span>
  <span m=''1658730''>into</span> <span m=''1659270''>different</span> <span m=''1659550''>registers</span>
  <span m=''1660040''>this</span> <span m=''1660170''>time,</span> <span m=''1660390''>actually,</span>
  <span m=''1660810''>RSI</span> <span m=''1661400''>and</span> <span m=''1661690''>RCX.</span>
  <span m=''1662700''>And</span> <span m=''1662880''>then</span> <span m=''1663130''>it</span>
  <span m=''1663240''>clears</span> <span m=''1663600''>out</span> <span m=''1664160''>EDX.</span>
  <span m=''1665100''>And</span> <span m=''1665360''>then</span> <span m=''1665640''>it</span>
  <span m=''1665870''>does</span> <span m=''1666080''>the</span> <span m=''1666180''>compare</span>
  <span m=''1666650''>between</span> <span m=''1667000''>RSI</span> <span m=''1667345''>and</span>
  <span m=''1667690''>RCX,</span> <span m=''1668310''>which</span> <span m=''1668480''>is</span>
  <span m=''1668640''>A</span> <span m=''1668780''>and</span> <span m=''1668940''>B.</span>
  <span m=''1669660''>And</span> <span m=''1669840''>then</span> <span m=''1670110''>it</span>
  <span m=''1670290''>sets</span> <span m=''1671490''>percent</span> <span m=''1671960''>DL.</span>
  <span m=''1672410''>Now,</span> <span m=''1672600''>percent</span> <span m=''1673070''>DL</span>
  <span m=''1673520''>is</span> <span m=''1673640''>the</span> <span m=''1673740''>lower</span>
  <span m=''1674050''>byte</span> <span m=''1674500''>of</span> <span m=''1674710''>EDX.</span>
  <span m=''1676070''>So</span> <span m=''1676310''>it</span> <span m=''1676400''>used</span>
  <span m=''1676790''>a</span> <span m=''1676910''>different</span> <span m=''1677220''>choice</span>
  <span m=''1677450''>of</span> <span m=''1677520''>registers.</span> <span m=''1678400''>And</span>
  <span m=''1678540''>then it</span> <span m=''1678750''>did</span> <span m=''1678930''>the</span>
  <span m=''1679220''>A</span> <span m=''1679420''>XOR</span> <span m=''1679860''>B.</span>
  <span m=''1680710''>And</span> <span m=''1680890''>then</span> <span m=''1681220''>it</span>
  <span m=''1684000''>moved</span> <span m=''1684280''>that</span> <span m=''1684660''>compare</span>
  <span m=''1685210''>into</span> <span m=''1685550''>RAX.</span> </p><p><span m=''1685880''>GUEST
  SPEAKER 1: [INAUDIBLE]</span> </p><p><span m=''1688320''>GUEST SPEAKER 2: OK,</span>
  <span m=''1688810''>and</span> <span m=''1689150''>Reid</span> <span m=''1689480''>actually</span>
  <span m=''1689810''>has</span> <span m=''1690320''>a</span> <span m=''1690370''>longer</span>
  <span m=''1690740''>snippet</span> <span m=''1691080''>of the</span> <span m=''1691260''>code.</span>
  <span m=''1691990''>And</span> <span m=''1692810''>the</span> <span m=''1692910''>compiler,</span>
  <span m=''1693340''>actually,</span> <span m=''1694020''>now</span> <span m=''1694290''>that</span>
  <span m=''1694860''>we</span> <span m=''1695750''>told</span> <span m=''1696030''>it</span>
  <span m=''1696280''>that it</span> <span m=''1696400''>was a</span> <span m=''1696460''>64-bit</span>
  <span m=''1697260''>flag,</span> <span m=''1697730''>the</span> <span m=''1697830''>compiler</span>
  <span m=''1698240''>realized</span> <span m=''1698680''>that</span> <span m=''1698790''>there''s</span>
  <span m=''1698980''>a</span> <span m=''1699020''>couple</span> <span m=''1699270''>optimizations</span>
  <span m=''1700110''>that</span> <span m=''1700290''>it</span> <span m=''1700370''>could</span>
  <span m=''1700500''>do.</span> <span m=''1700980''>So</span> <span m=''1701220''>it</span>
  <span m=''1701370''>switched</span> <span m=''1701630''>around</span> <span m=''1701840''>the</span>
  <span m=''1701940''>order</span> <span m=''1702160''>of</span> <span m=''1702220''>things</span>
  <span m=''1702450''>a</span> <span m=''1702510''>little</span> <span m=''1702770''>bit.</span>
  <span m=''1703340''>And</span> <span m=''1703600''>it''s</span> <span m=''1703780''>recycling</span>
  <span m=''1704360''>the</span> <span m=''1704450''>value</span> <span m=''1704880''>of</span>
  <span m=''1705040''>RDX</span> <span m=''1706530''>for</span> <span m=''1706810''>loading,</span>
  <span m=''1708250''>I</span> <span m=''1708350''>think</span> <span m=''1708570''>it''s</span>
  <span m=''1708760''>A+</span> <span m=''1708900''>equals</span> <span m=''1709560''>comp.</span>
  <span m=''1710060''>It''s</span> <span m=''1710315''>recycling</span> <span m=''1710570''>the</span>
  <span m=''1710640''>value</span> <span m=''1710920''>RDX</span> <span m=''1711470''>that</span>
  <span m=''1711620''>it</span> <span m=''1712270''>generated</span> <span m=''1712820''>out
  of</span> <span m=''1712920''>a</span> <span m=''1713010''>compare.</span> </p><p><span
  m=''1713980''>And</span> <span m=''1714150''>now,</span> <span m=''1714670''>down</span>
  <span m=''1715160''>there,</span> <span m=''1715440''>it''s</span> <span m=''1715620''>negating</span>
  <span m=''1716170''>RAX</span> <span m=''1716760''>as</span> <span m=''1716900''>a</span>
  <span m=''1716950''>64-bit</span> <span m=''1718190''>number</span> <span m=''1719020''>and</span>
  <span m=''1719240''>directly</span> <span m=''1719590''>using</span> <span m=''1719900''>it</span>
  <span m=''1720000''>without</span> <span m=''1720310''>that</span> <span m=''1720480''>cltq</span>
  <span m=''1721140''>instruction.</span> <span m=''1722240''>So</span> <span m=''1723000''>that</span>
  <span m=''1723150''>was</span> <span m=''1723280''>kind</span> <span m=''1723450''>of</span>
  <span m=''1723520''>nice.</span> <span m=''1724800''>So</span> <span m=''1725110''>in</span>
  <span m=''1725250''>just</span> <span m=''1725490''>nudging</span> <span m=''1725830''>the</span>
  <span m=''1725920''>compiler</span> <span m=''1726390''>a</span> <span m=''1726440''>little</span>
  <span m=''1726700''>bit,</span> <span m=''1726920''>we</span> <span m=''1727060''>got</span>
  <span m=''1727270''>it</span> <span m=''1727370''>to</span> <span m=''1727560''>produce</span>
  <span m=''1728000''>code</span> <span m=''1728740''>that</span> <span m=''1729620''>ran</span>
  <span m=''1731080''>roughly</span> <span m=''1731460''>about</span> <span m=''1731750''>10%</span>
  <span m=''1732240''>faster,</span> <span m=''1734160''>which</span> <span m=''1734430''>was</span>
  <span m=''1734600''>surprising</span> <span m=''1735020''>to</span> <span m=''1735160''>us,</span>
  <span m=''1735300''>actually,</span> <span m=''1735640''>that</span> <span m=''1735840''>changing</span>
  <span m=''1736390''>a</span> <span m=''1736490''>single</span> <span m=''1736860''>int</span>
  <span m=''1737190''>to a</span> <span m=''1737300''>long</span> <span m=''1737680''>could</span>
  <span m=''1738060''>reduce</span> <span m=''1738910''>the</span> <span m=''1739010''>runtime</span>
  <span m=''1739410''>by</span> <span m=''1739530''>that</span> <span m=''1739740''>amount.</span>
  </p><p><span m=''1741380''>So</span> <span m=''1742390''>next</span> <span m=''1742640''>thing</span>
  <span m=''1742760''>that</span> <span m=''1742910''>we</span> <span m=''1743020''>did</span>
  <span m=''1743280''>was</span> <span m=''1743570''>we</span> <span m=''1743740''>scrolled</span>
  <span m=''1744090''>down</span> <span m=''1744350''>a</span> <span m=''1744390''>little</span>
  <span m=''1744590''>bit</span> <span m=''1744750''>more</span> <span m=''1745010''>on</span>
  <span m=''1745100''>this</span> <span m=''1745280''>window.</span> <span m=''1745650''>And</span>
  <span m=''1745720''>we</span> <span m=''1745850''>looked</span> <span m=''1746080''>at</span>
  <span m=''1746170''>the</span> <span m=''1746260''>next</span> <span m=''1746560''>thing</span>
  <span m=''1746700''>that</span> <span m=''1746830''>the</span> <span m=''1746920''>compiler</span>
  <span m=''1747390''>was</span> <span m=''1747580''>doing.</span> <span m=''1748290''>And</span>
  <span m=''1749010''>we</span> <span m=''1749340''>kind</span> <span m=''1749490''>of</span>
  <span m=''1749640''>caught</span> <span m=''1749860''>the</span> <span m=''1749930''>compiler</span>
  <span m=''1750340''>again</span> <span m=''1750600''>doing</span> <span m=''1750790''>something</span>
  <span m=''1751110''>silly.</span> <span m=''1752870''>So</span> <span m=''1754450''>here''s</span>
  <span m=''1754930''>the</span> <span m=''1755030''>code</span> <span m=''1755270''>that</span>
  <span m=''1755400''>we</span> <span m=''1755540''>were</span> <span m=''1755710''>at</span>
  <span m=''1756220''>before,</span> <span m=''1756970''>the</span> <span m=''1757130''>compare</span>
  <span m=''1757530''>code.</span> <span m=''1758240''>And</span> <span m=''1758420''>now</span>
  <span m=''1758630''>let''s</span> <span m=''1758870''>look</span> <span m=''1759090''>at</span>
  <span m=''1759330''>how</span> <span m=''1760250''>the</span> <span m=''1760440''>compiler</span>
  <span m=''1760880''>did</span> <span m=''1761220''>B+</span> <span m=''1761460''>equals</span>
  <span m=''1762530''>CMP.</span> </p><p><span m=''1764510''>Once</span> <span m=''1764870''>again,</span>
  <span m=''1765540''>the</span> <span m=''1765880''>reason</span> <span m=''1766160''>that</span>
  <span m=''1766330''>we</span> <span m=''1766430''>stopped</span> <span m=''1766710''>and</span>
  <span m=''1766850''>looked</span> <span m=''1767040''>at</span> <span m=''1767130''>this</span>
  <span m=''1767320''>code</span> <span m=''1767730''>was</span> <span m=''1768080''>we</span>
  <span m=''1768200''>saw</span> <span m=''1768450''>an</span> <span m=''1768560''>instruction</span>
  <span m=''1768980''>that</span> <span m=''1769100''>we</span> <span m=''1769190''>didn''t</span>
  <span m=''1769400''>recognize,</span> <span m=''1770260''>SBB.</span> <span m=''1771760''>Well,</span>
  <span m=''1772040''>we</span> <span m=''1772160''>looked</span> <span m=''1772390''>at</span>
  <span m=''1772480''>the</span> <span m=''1772550''>manual</span> <span m=''1772960''>again.</span>
  <span m=''1773600''>And</span> <span m=''1773910''>SBB</span> <span m=''1774600''>of</span>
  <span m=''1774820''>R1</span> <span m=''1775010''>and</span> <span m=''1775480''>R2</span>
  <span m=''1775760''>is</span> <span m=''1775990''>a</span> <span m=''1776720''>subtract</span>
  <span m=''1777360''>with</span> <span m=''1777540''>a</span> <span m=''1777780''>borrow</span>
  <span m=''1778140''>bit.</span> <span m=''1779080''>So</span> <span m=''1779340''>it</span>
  <span m=''1779530''>does</span> <span m=''1780250''>subtracting</span> <span m=''1782430''>the</span>
  <span m=''1782590''>two</span> <span m=''1782770''>arguments</span> <span m=''1783260''>and</span>
  <span m=''1783390''>then</span> <span m=''1783560''>subtracting</span> <span m=''1783875''>a</span>
  <span m=''1784190''>carry</span> <span m=''1784760''>flag</span> <span m=''1785080''>from</span>
  <span m=''1785310''>that.</span> </p><p><span m=''1786270''>So</span> <span m=''1786680''>OK,</span>
  <span m=''1786920''>why''s</span> <span m=''1787160''>it</span> <span m=''1787270''>doing</span>
  <span m=''1787550''>that?</span> <span m=''1788180''>Well,</span> <span m=''1788470''>let''s</span>
  <span m=''1788670''>walk</span> <span m=''1788920''>through</span> <span m=''1789110''>what</span>
  <span m=''1789260''>the</span> <span m=''1789350''>compiler</span> <span m=''1789770''>tried</span>
  <span m=''1790040''>to</span> <span m=''1790090''>do.</span> <span m=''1793130''>Let''s</span>
  <span m=''1793480''>see,</span> <span m=''1793690''>where''s</span> <span m=''1794020''>a</span>
  <span m=''1794070''>good</span> <span m=''1794220''>place</span> <span m=''1794490''>to</span>
  <span m=''1794580''>start?</span> <span m=''1795660''>So</span> <span m=''1796040''>it''s</span>
  <span m=''1797130''>RDX</span> <span m=''1798040''>in</span> <span m=''1798400''>this</span>
  <span m=''1798750''>compare.</span> <span m=''1799370''>So it</span> <span m=''1799600''>compares</span>
  <span m=''1800050''>RDX</span> <span m=''1800700''>to</span> <span m=''1801500''>1.</span>
  <span m=''1802220''>RDX</span> <span m=''1802740''>is</span> <span m=''1802860''>where</span>
  <span m=''1803310''>CMP</span> <span m=''1803790''>was</span> <span m=''1803930''>stored.</span>
  <span m=''1804670''>So</span> <span m=''1804860''>it</span> <span m=''1804960''>checks</span>
  <span m=''1805250''>whether</span> <span m=''1805490''>or</span> <span m=''1805530''>not
  it</span> <span m=''1805760''>equals</span> <span m=''1806180''>to</span> <span
  m=''1806280''>1.</span> <span m=''1807960''>And</span> <span m=''1808170''>then</span>
  <span m=''1808610''>the</span> <span m=''1808830''>result</span> <span m=''1809095''>of</span>
  <span m=''1809360''>that</span> <span m=''1809580''>check</span> <span m=''1809860''>is</span>
  <span m=''1810030''>actually</span> <span m=''1810320''>stored</span> <span m=''1810790''>in</span>
  <span m=''1811460''>the</span> <span m=''1811590''>carry</span> <span m=''1811970''>flag,</span>
  <span m=''1812300''>CF.</span> </p><p><span m=''1813490''>And</span> <span m=''1813870''>subtract</span>
  <span m=''1814320''>with</span> <span m=''1814430''>borrow,</span> <span m=''1814980''>RAX,</span>
  <span m=''1815310''>RAX.</span> <span m=''1816960''>Before,</span> <span m=''1817510''>RAX</span>
  <span m=''1818070''>held</span> <span m=''1818410''>the</span> <span m=''1818860''>value</span>
  <span m=''1819350''>of B.</span> <span m=''1819770''>But</span> <span m=''1820060''>now,</span>
  <span m=''1820350''>since</span> <span m=''1820580''>it</span> <span m=''1820690''>did</span>
  <span m=''1820870''>this,</span> <span m=''1821160''>RAX</span> <span m=''1821670''>minus</span>
  <span m=''1821970''>RAX</span> <span m=''1822490''>is</span> <span m=''1822620''>0,</span>
  <span m=''1823040''>right?</span> <span m=''1823820''>And</span> <span m=''1823960''>then</span>
  <span m=''1824120''>minus</span> <span m=''1824440''>the</span> <span m=''1824530''>carry</span>
  <span m=''1824830''>flag</span> <span m=''1825180''>is</span> <span m=''1825300''>either</span>
  <span m=''1825590''>0</span> <span m=''1826300''>or</span> <span m=''1826550''>negative</span>
  <span m=''1826930''>1,</span> <span m=''1827390''>depending</span> <span m=''1827750''>on</span>
  <span m=''1827830''>the</span> <span m=''1827910''>value</span> <span m=''1828760''>of</span>
  <span m=''1828930''>the</span> <span m=''1829180''>compare.</span> <span m=''1830270''>So</span>
  <span m=''1830940''>once</span> <span m=''1831170''>again,</span> <span m=''1831430''>it</span>
  <span m=''1831520''>generates</span> <span m=''1831960''>a</span> <span m=''1832000''>register</span>
  <span m=''1832920''>that''s</span> <span m=''1833220''>either</span> <span m=''1833900''>all</span>
  <span m=''1834110''>0''s</span> <span m=''1834960''>or</span> <span m=''1835830''>all</span>
  <span m=''1836140''>1''s,</span> <span m=''1837000''>64</span> <span m=''1837510''>bits.</span>
  </p><p><span m=''1838380''>Now,</span> <span m=''1838590''>what</span> <span m=''1838750''>did</span>
  <span m=''1838870''>it</span> <span m=''1838960''>go</span> <span m=''1839220''>and</span>
  <span m=''1839340''>do</span> <span m=''1839510''>with</span> <span m=''1839620''>that?</span>
  <span m=''1840270''>Well,</span> <span m=''1840650''>jump</span> <span m=''1840860''>down</span>
  <span m=''1841060''>a</span> <span m=''1841100''>little</span> <span m=''1841310''>bit</span>
  <span m=''1841480''>later</span> <span m=''1841790''>on</span> <span m=''1841980''>in
  the</span> <span m=''1842080''>code.</span> <span m=''1842700''>And</span> <span
  m=''1843030''>it</span> <span m=''1843210''>ends</span> <span m=''1844280''>EAX,</span>
  <span m=''1844830''>which</span> <span m=''1845000''>is</span> <span m=''1845100''>the</span>
  <span m=''1845200''>32-bit</span> <span m=''1845890''>version</span> <span m=''1846240''>of</span>
  <span m=''1846370''>RAX,</span> <span m=''1847280''>with</span> <span m=''1847860''>the</span>
  <span m=''1847960''>value</span> <span m=''1848370''>of</span> <span m=''1848450''>8</span>
  <span m=''1848920''>in</span> <span m=''1849060''>hexadecimal.</span> <span m=''1851390''>So</span>
  <span m=''1851660''>now</span> <span m=''1851940''>it''s</span> <span m=''1852080''>either</span>
  <span m=''1852600''>all</span> <span m=''1852820''>0''s,</span> <span m=''1853370''>or</span>
  <span m=''1853620''>it''s</span> <span m=''1853860''>8.</span> <span m=''1854690''>And</span>
  <span m=''1854960''>then</span> <span m=''1857300''>it</span> <span m=''1857660''>adds</span>
  <span m=''1859130''>that</span> <span m=''1859330''>value,</span> <span m=''1859650''>EAX,</span>
  <span m=''1860380''>which</span> <span m=''1860570''>is</span> <span m=''1860830''>the
  same as</span> <span m=''1861300''>RAX--</span> <span m=''1861920''>RAX</span> <span
  m=''1862320''>is</span> <span m=''1862390''>a</span> <span m=''1862460''>64-bit</span>
  <span m=''1863100''>version--</span> <span m=''1863780''>it</span> <span m=''1864040''>adds</span>
  <span m=''1864310''>that</span> <span m=''1864480''>value</span> <span m=''1864760''>to</span>
  <span m=''1864900''>RBP,</span> <span m=''1865510''>which</span> <span m=''1865750''>stored</span>
  <span m=''1867160''>the</span> <span m=''1867290''>address</span> <span m=''1867650''>of</span>
  <span m=''1867810''>B.</span> </p><p><span m=''1869050''>So</span> <span m=''1869420''>it</span>
  <span m=''1869500''>jumped</span> <span m=''1869840''>through</span> <span m=''1870050''>that</span>
  <span m=''1870360''>many</span> <span m=''1870940''>hoops</span> <span m=''1871590''>just</span>
  <span m=''1871860''>to</span> <span m=''1871970''>increment</span> <span m=''1872790''>B</span>
  <span m=''1873030''>by</span> <span m=''1873270''>either</span> <span m=''1873610''>8</span>
  <span m=''1873850''>or</span> <span m=''1873970''>0.</span> <span m=''1875420''>Now,</span>
  <span m=''1875640''>this</span> <span m=''1875890''>seems</span> <span m=''1876100''>a</span>
  <span m=''1876160''>little</span> <span m=''1876360''>bit</span> <span m=''1876520''>unnecessary.</span>
  <span m=''1877640''>So</span> <span m=''1877950''>we</span> <span m=''1878100''>thought,</span>
  <span m=''1878430''>how</span> <span m=''1878690''>else</span> <span m=''1878920''>could</span>
  <span m=''1879030''>we</span> <span m=''1879230''>express</span> <span m=''1880430''>B+</span>
  <span m=''1880600''>equals</span> <span m=''1881440''>not</span> <span m=''1881740''>CMP,</span>
  <span m=''1882540''>and</span> <span m=''1883510''>try</span> <span m=''1883700''>to</span>
  <span m=''1884440''>change</span> <span m=''1884700''>the</span> <span m=''1884780''>code</span>
  <span m=''1885000''>around</span> <span m=''1885250''>a</span> <span m=''1885290''>little</span>
  <span m=''1885480''>bit</span> <span m=''1885660''>so</span> <span m=''1885780''>that
  it</span> <span m=''1886050''>does</span> <span m=''1886250''>the</span> <span m=''1886340''>same</span>
  <span m=''1886560''>thing,</span> <span m=''1886790''>but</span> <span m=''1886920''>hope</span>
  <span m=''1887130''>that</span> <span m=''1887250''>the</span> <span m=''1887330''>compiler</span>
  <span m=''1887870''>treats it</span> <span m=''1888260''>differently.</span> <span
  m=''1889950''>Well,</span> <span m=''1890150''>in</span> <span m=''1890220''>this</span>
  <span m=''1890450''>case,</span> <span m=''1891410''>not</span> <span m=''1891850''>CMP,</span>
  <span m=''1892340''>when</span> <span m=''1892490''>CMP</span> <span m=''1892840''>is</span>
  <span m=''1892950''>either</span> <span m=''1893130''>1</span> <span m=''1893330''>or</span>
  <span m=''1893390''>0,</span> <span m=''1893850''>is</span> <span m=''1893980''>the</span>
  <span m=''1894060''>same</span> <span m=''1894280''>thing</span> <span m=''1894450''>as</span>
  <span m=''1894580''>1</span> <span m=''1894830''>minus</span> <span m=''1895140''>CMP.</span>
  <span m=''1899770''>Well,</span> <span m=''1900130''>we</span> <span m=''1900540''>compiled</span>
  <span m=''1901020''>a version of</span> <span m=''1901450''>this</span> <span m=''1901660''>code,</span>
  <span m=''1902040''>and</span> <span m=''1902210''>then</span> <span m=''1902420''>we</span>
  <span m=''1902640''>tried</span> <span m=''1902860''>to</span> <span m=''1902980''>run</span>
  <span m=''1903180''>it.</span> </p><p><span m=''1912800''>Refreshing</span> <span
  m=''1913190''>our</span> <span m=''1913360''>memory,</span> <span m=''1913880''>mergesort</span>
  <span m=''1914420''>minus,</span> <span m=''1914870''>where</span> <span m=''1915110''>we</span>
  <span m=''1915250''>just</span> <span m=''1917262''>did</span> <span m=''1917690''>the</span>
  <span m=''1918310''>minus</span> <span m=''1919200''>sign.</span> <span m=''1921360''>So</span>
  <span m=''1921610''>we</span> <span m=''1921840''>took</span> <span m=''1922050''>the</span>
  <span m=''1922140''>runtime</span> <span m=''1922560''>down</span> <span m=''1922870''>from</span>
  <span m=''1923120''>4.04</span> <span m=''1923900''>seconds</span> <span m=''1924400''>to</span>
  <span m=''1924670''>3.77</span> <span m=''1925830''>seconds.</span> <span m=''1927450''>And</span>
  <span m=''1927780''>once</span> <span m=''1928100''>again,</span> <span m=''1928770''>this</span>
  <span m=''1928990''>is</span> <span m=''1929470''>just</span> <span m=''1929760''>from</span>
  <span m=''1930260''>replacing</span> <span m=''1931340''>a</span> <span m=''1933870''>not</span>
  <span m=''1934240''>CMP</span> <span m=''1934710''>to</span> <span m=''1934880''>a</span>
  <span m=''1934940''>1</span> <span m=''1935200''>minus</span> <span m=''1935530''>CMP.</span>
  <span m=''1936160''>That''s</span> <span m=''1936350''>all</span> <span m=''1936510''>the</span>
  <span m=''1936590''>code</span> <span m=''1936820''>change</span> <span m=''1937050''>that</span>
  <span m=''1937190''>we</span> <span m=''1937290''>made.</span> <span m=''1940670''>And</span>
  <span m=''1941820''>we</span> <span m=''1941990''>will</span> <span m=''1942710''>look</span>
  <span m=''1942940''>at</span> <span m=''1943070''>the</span> <span m=''1943460''>annotation</span>
  <span m=''1944060''>again,</span> <span m=''1945300''>just</span> <span m=''1945480''>to</span>
  <span m=''1945550''>make</span> <span m=''1945740''>sure</span> <span m=''1945910''>that</span>
  <span m=''1946070''>the</span> <span m=''1946140''>compiler</span> <span m=''1946650''>generated</span>
  <span m=''1947090''>different</span> <span m=''1947360''>code.</span> <span m=''1947770''>Rather,</span>
  <span m=''1948050''>we</span> <span m=''1948160''>were</span> <span m=''1948300''>curious</span>
  <span m=''1948740''>of what</span> <span m=''1948930''>the</span> <span m=''1949010''>compiler</span>
  <span m=''1949410''>generated</span> <span m=''1949850''>this</span> <span m=''1950050''>time.</span>
  <span m=''1952900''>So</span> <span m=''1953480''>it''s</span> <span m=''1954150''>roughly</span>
  <span m=''1954730''>this</span> <span m=''1955380''>section</span> <span m=''1955800''>of</span>
  <span m=''1955890''>code.</span> </p><p><span m=''1959680''>Now,</span> <span m=''1959900''>one</span>
  <span m=''1960090''>thing</span> <span m=''1960230''>you''ll</span> <span m=''1960380''>notice</span>
  <span m=''1960740''>is,</span> <span m=''1960880''>because</span> <span m=''1961200''>we''re</span>
  <span m=''1961360''>compiling</span> <span m=''1961950''>with--</span> <span m=''1962580''>this</span>
  <span m=''1962760''>is</span> <span m=''1962900''>already</span> <span m=''1963150''>compiling</span>
  <span m=''1963550''>with</span> <span m=''1963690''>GCC''s</span> <span m=''1964240''>maximum</span>
  <span m=''1964740''>optimization</span> <span m=''1965450''>level,</span> <span
  m=''1966050''>mind</span> <span m=''1966320''>you.</span> <span m=''1966690''>So</span>
  <span m=''1967270''>keep</span> <span m=''1967460''>that</span> <span m=''1967590''>in</span>
  <span m=''1967720''>mind</span> <span m=''1968070''>when</span> <span m=''1968220''>you</span>
  <span m=''1968540''>assume</span> <span m=''1968850''>that</span> <span m=''1968980''>the</span>
  <span m=''1969050''>compiler</span> <span m=''1969315''>is</span> <span m=''1969580''>going</span>
  <span m=''1969690''>to</span> <span m=''1969740''>help</span> <span m=''1969930''>you</span>
  <span m=''1970060''>out</span> <span m=''1970250''>and</span> <span m=''1970350''>do</span>
  <span m=''1970480''>smart</span> <span m=''1970810''>things.</span> <span m=''1972920''>So</span>
  <span m=''1973440''>the</span> <span m=''1973710''>instructions</span> <span m=''1974170''>are</span>
  <span m=''1974260''>a</span> <span m=''1974300''>little</span> <span m=''1974500''>bit</span>
  <span m=''1974660''>out</span> <span m=''1974830''>of</span> <span m=''1974930''>order</span>
  <span m=''1975240''>compared</span> <span m=''1975570''>to</span> <span m=''1975650''>what</span>
  <span m=''1975800''>you</span> <span m=''1975880''>might</span> <span m=''1976090''>expect.</span>
  <span m=''1982584''>All right,</span> <span m=''1983080''>so</span> <span m=''1983360''>I''ll</span>
  <span m=''1983510''>go</span> <span m=''1983670''>to</span> <span m=''1983800''>my</span>
  <span m=''1984160''>prepared</span> <span m=''1984610''>screen</span> <span m=''1984940''>shot</span>
  <span m=''1985420''>of</span> <span m=''1985640''>the</span> <span m=''1985750''>code.</span>
  </p><p><span m=''1987460''>So</span> <span m=''1988340''>what</span> <span m=''1988520''>did</span>
  <span m=''1988670''>it</span> <span m=''1988770''>generate</span> <span m=''1989130''>this</span>
  <span m=''1989310''>time?</span> <span m=''1990300''>All</span> <span m=''1990460''>right,</span>
  <span m=''1990750''>so</span> <span m=''1991050''>already,</span> <span m=''1991400''>this</span>
  <span m=''1991620''>code</span> <span m=''1991840''>looks</span> <span m=''1992050''>shorter</span>
  <span m=''1992430''>than</span> <span m=''1992560''>the</span> <span m=''1992640''>previous</span>
  <span m=''1993050''>one,</span> <span m=''1993550''>right?</span> <span m=''1997040''>A</span>
  <span m=''1997150''>little</span> <span m=''1997340''>bit</span> <span m=''1997480''>less</span>
  <span m=''1997680''>hairy</span> <span m=''1997940''>than</span> <span m=''1998110''>that.</span>
  <span m=''1999790''>So</span> <span m=''2000090''>what</span> <span m=''2000270''>did</span>
  <span m=''2000430''>it</span> <span m=''2000460''>do?</span> <span m=''2001050''>Well,</span>
  <span m=''2001760''>SIL,</span> <span m=''2002360''>once</span> <span m=''2002570''>again,</span>
  <span m=''2003440''>is</span> <span m=''2003680''>the</span> <span m=''2003850''>lower</span>
  <span m=''2004520''>byte</span> <span m=''2004800''>of</span> <span m=''2005130''>RSI.</span>
  <span m=''2005810''>So</span> <span m=''2005980''>it</span> <span m=''2006080''>does</span>
  <span m=''2006300''>the</span> <span m=''2006390''>compare</span> <span m=''2007360''>RCX</span>
  <span m=''2007890''>with</span> <span m=''2008010''>RDX,</span> <span m=''2008590''>which</span>
  <span m=''2008810''>is</span> <span m=''2008920''>actually</span> <span m=''2009270''>this</span>
  <span m=''2009530''>comparison.</span> <span m=''2010540''>And</span> <span m=''2010700''>then</span>
  <span m=''2010850''>it saves</span> <span m=''2011260''>that</span> <span m=''2011520''>into</span>
  <span m=''2011800''>SIL.</span> <span m=''2013110''>And</span> <span m=''2013280''>now,</span>
  <span m=''2013510''>later,</span> <span m=''2015390''>it</span> <span m=''2015540''>does</span>
  <span m=''2015740''>the</span> <span m=''2015870''>XOR.</span> <span m=''2018050''>So</span>
  <span m=''2018280''>this</span> <span m=''2018480''>was</span> <span m=''2018620''>the</span>
  <span m=''2018690''>code</span> <span m=''2018890''>from</span> <span m=''2019020''>before.</span>
  </p><p><span m=''2019810''>And</span> <span m=''2019980''>then</span> <span m=''2020270''>it</span>
  <span m=''2020420''>does</span> <span m=''2021280''>a</span> <span m=''2021410''>move</span>
  <span m=''2021820''>of</span> <span m=''2022210''>RSI,</span> <span m=''2022820''>which</span>
  <span m=''2023050''>contains</span> <span m=''2023410''>the</span> <span m=''2023490''>same</span>
  <span m=''2023700''>value</span> <span m=''2024060''>as</span> <span m=''2024330''>SIL,</span>
  <span m=''2024850''>which</span> <span m=''2025030''>is</span> <span m=''2025330''>CMP''s</span>
  <span m=''2025980''>either</span> <span m=''2026230''>1</span> <span m=''2026510''>or</span>
  <span m=''2026610''>0.</span> <span m=''2027380''>It</span> <span m=''2027520''>moves</span>
  <span m=''2027760''>that</span> <span m=''2028000''>into</span> <span m=''2028300''>RAX.</span>
  <span m=''2031830''>And</span> <span m=''2031980''>then,</span> <span m=''2032450''>later</span>
  <span m=''2033100''>on,</span> <span m=''2035230''>it</span> <span m=''2036930''>uses</span>
  <span m=''2037900''>RAX</span> <span m=''2038540''>for</span> <span m=''2038760''>one</span>
  <span m=''2039040''>calculation.</span> <span m=''2040680''>And</span> <span m=''2040860''>then</span>
  <span m=''2041050''>it</span> <span m=''2041160''>also</span> <span m=''2041850''>uses</span>
  <span m=''2042200''>the</span> <span m=''2042280''>value</span> <span m=''2042610''>that''s</span>
  <span m=''2042810''>already</span> <span m=''2043060''>in</span> <span m=''2043230''>RSI.</span>
  <span m=''2044130''>And it</span> <span m=''2044440''>subtracts</span> <span m=''2044990''>that</span>
  <span m=''2045250''>from</span> <span m=''2045670''>register</span> <span m=''2046080''>14,</span>
  <span m=''2046790''>which</span> <span m=''2047140''>is</span> <span m=''2047310''>where
  it</span> <span m=''2047580''>decided</span> <span m=''2048100''>to</span> <span
  m=''2048770''>store</span> <span m=''2049130''>the</span> <span m=''2049239''>value</span>
  <span m=''2049510''>of</span> <span m=''2049600''>B.</span> <span m=''2050230''>So</span>
  <span m=''2050370''>that''s</span> <span m=''2050610''>a</span> <span m=''2050650''>much</span>
  <span m=''2050860''>more</span> <span m=''2051020''>direct</span> <span m=''2051350''>way</span>
  <span m=''2051489''>to</span> <span m=''2051630''>either</span> <span m=''2051889''>subtract</span>
  <span m=''2052270''>0 or</span> <span m=''2052590''>1,</span> <span m=''2052840''>actually</span>
  <span m=''2053190''>get</span> <span m=''2053440''>just</span> <span m=''2053679''>0</span>
  <span m=''2053960''>or</span> <span m=''2054040''>1,</span> <span m=''2054280''>and</span>
  <span m=''2054530''>then</span> <span m=''2054780''>use</span> <span m=''2055010''>it</span>
  <span m=''2055130''>for</span> <span m=''2055300''>a</span> <span m=''2055350''>subtraction.</span>
  </p><p><span m=''2056690''>So</span> <span m=''2057270''>the</span> <span m=''2057409''>end</span>
  <span m=''2057560''>result,</span> <span m=''2057980''>and</span> <span m=''2058310''>something</span>
  <span m=''2058610''>else</span> <span m=''2058760''>to</span> <span m=''2058860''>point</span>
  <span m=''2059110''>out,</span> <span m=''2059679''>is</span> <span m=''2059850''>that</span>
  <span m=''2061120''>the</span> <span m=''2061239''>move</span> <span m=''2061590''>and</span>
  <span m=''2061800''>subtract</span> <span m=''2062250''>commands</span> <span m=''2063040''>have</span>
  <span m=''2063330''>a</span> <span m=''2063380''>little</span> <span m=''2063590''>bit</span>
  <span m=''2063719''>of</span> <span m=''2063810''>instruction</span> <span m=''2064250''>level</span>
  <span m=''2064480''>parallelism,</span> <span m=''2065489''>because</span> <span
  m=''2065980''>right</span> <span m=''2066199''>after</span> <span m=''2066520''>you</span>
  <span m=''2066830''>set</span> <span m=''2067290''>[? LE ?]</span> <span m=''2067800''>SIL,</span>
  <span m=''2068100''>as</span> <span m=''2068530''>soon as</span> <span m=''2068659''>that''s</span>
  <span m=''2068920''>done,</span> <span m=''2069120''>you</span> <span m=''2069260''>can</span>
  <span m=''2069389''>execute</span> <span m=''2069739''>both</span> <span m=''2070020''>the</span>
  <span m=''2070100''>move</span> <span m=''2070510''>and</span> <span m=''2070650''>the</span>
  <span m=''2070780''>subtract</span> <span m=''2071150''>at the</span> <span m=''2071290''>same</span>
  <span m=''2071510''>time,</span> <span m=''2072120''>since</span> <span m=''2072370''>they</span>
  <span m=''2072480''>use</span> <span m=''2072780''>the</span> <span m=''2072860''>same</span>
  <span m=''2073540''>source</span> <span m=''2073940''>register</span> <span m=''2074380''>and</span>
  <span m=''2074500''>put</span> <span m=''2074699''>in</span> <span m=''2074860''>different</span>
  <span m=''2075150''>destination</span> <span m=''2075679''>registers.</span> <span
  m=''2076960''>And</span> <span m=''2077300''>the</span> <span m=''2077440''>other</span>
  <span m=''2077639''>thing</span> <span m=''2077870''>to</span> <span m=''2077980''>notice</span>
  <span m=''2078510''>in</span> <span m=''2078810''>the</span> <span m=''2078900''>comparison</span>
  <span m=''2079909''>is</span> <span m=''2080130''>the</span> <span m=''2080219''>number</span>
  <span m=''2080550''>of</span> <span m=''2080659''>ALU</span> <span m=''2081120''>operations.</span>
  <span m=''2082320''>I''ll</span> <span m=''2082500''>go</span> <span m=''2082639''>back</span>
  <span m=''2082880''>to</span> <span m=''2082969''>the</span> <span m=''2083060''>original</span>
  <span m=''2083500''>one.</span> <span m=''2084449''>You</span> <span m=''2084580''>see</span>
  <span m=''2085280''>negate,</span> <span m=''2086060''>and,</span> <span m=''2086750''>XOR,</span>
  <span m=''2087969''>add.</span> <span m=''2088909''>So</span> <span m=''2089150''>move</span>
  <span m=''2089449''>is</span> <span m=''2089600''>not</span> <span m=''2089840''>an</span>
  <span m=''2090100''>ALU.</span> <span m=''2090580''>It''s</span> <span m=''2090699''>not
  an</span> <span m=''2090860''>arithmetic</span> <span m=''2091460''>operation.</span>
  <span m=''2092190''>But</span> <span m=''2092489''>everything</span> <span m=''2092940''>else</span>
  <span m=''2093440''>is</span> <span m=''2093670''>either</span> <span m=''2093940''>XOR,</span>
  <span m=''2094469''>and,</span> <span m=''2094850''>add,</span> <span m=''2095150''>or</span>
  <span m=''2095280''>subtract,</span> <span m=''2095810''>or</span> <span m=''2096100''>compare,</span>
  <span m=''2096739''>which</span> <span m=''2096989''>all</span> <span m=''2097170''>use</span>
  <span m=''2097390''>the</span> <span m=''2097580''>ALU.</span> </p><p><span m=''2099180''>Now,</span>
  <span m=''2099420''>if</span> <span m=''2099480''>you</span> <span m=''2099600''>look</span>
  <span m=''2099800''>at</span> <span m=''2100050''>the</span> <span m=''2100150''>code</span>
  <span m=''2100420''>over</span> <span m=''2100680''>here,</span> <span m=''2102270''>you</span>
  <span m=''2102510''>have</span> <span m=''2102750''>move,</span> <span m=''2103130''>move,</span>
  <span m=''2103890''>move,</span> <span m=''2104300''>which</span> <span m=''2104720''>don''t</span>
  <span m=''2104900''>need</span> <span m=''2105030''>the</span> <span m=''2105150''>ALU.</span>
  <span m=''2105740''>And</span> <span m=''2105890''>then</span> <span m=''2107000''>the</span>
  <span m=''2107150''>other</span> <span m=''2107490''>or</span> <span m=''2107630''>four</span>
  <span m=''2108620''>or</span> <span m=''2108810''>five</span> <span m=''2109300''>need</span>
  <span m=''2109500''>the</span> <span m=''2109690''>ALU.</span> <span m=''2110300''>But</span>
  <span m=''2111120''>having</span> <span m=''2111430''>fewer</span> <span m=''2111730''>ALU</span>
  <span m=''2111890''>op</span> <span m=''2112190''>is a</span> <span m=''2112600''>good</span>
  <span m=''2112800''>thing.</span> </p><p><span m=''2114010''>If</span> <span m=''2114160''>you</span>
  <span m=''2114280''>remember</span> <span m=''2114630''>from</span> <span m=''2114790''>the</span>
  <span m=''2114880''>previous</span> <span m=''2115340''>lecture</span> <span m=''2115730''>on</span>
  <span m=''2115980''>CPU</span> <span m=''2116440''>architecture,</span> <span m=''2117120''>the</span>
  <span m=''2117260''>Nehalem,</span> <span m=''2117770''>has</span> <span m=''2117980''>six</span>
  <span m=''2118350''>execution</span> <span m=''2118920''>ports.</span> <span m=''2119220''>So</span>
  <span m=''2119350''>it</span> <span m=''2119460''>can</span> <span m=''2119660''>execute</span>
  <span m=''2120080''>six</span> <span m=''2120750''>micro-ops</span> <span m=''2121580''>in</span>
  <span m=''2121850''>parallel</span> <span m=''2123140''>per</span> <span m=''2123390''>CPU</span>
  <span m=''2123770''>clock</span> <span m=''2124020''>cycle.</span> <span m=''2125000''>Actually,</span>
  <span m=''2125380''>only</span> <span m=''2125660''>three</span> <span m=''2126060''>of</span>
  <span m=''2126270''>those</span> <span m=''2126880''>execution</span> <span m=''2127350''>ports</span>
  <span m=''2127750''>have</span> <span m=''2127990''>ALUs</span> <span m=''2128470''>on</span>
  <span m=''2128620''>them,</span> <span m=''2128810''>so</span> <span m=''2128970''>that</span>
  <span m=''2129130''>they</span> <span m=''2129240''>can</span> <span m=''2129490''>actually</span>
  <span m=''2129800''>do</span> <span m=''2130660''>XOR,</span> <span m=''2131250''>at,</span>
  <span m=''2131640''>and,</span> <span m=''2132120''>subtract,</span> <span m=''2132640''>add,</span>
  <span m=''2132910''>and</span> <span m=''2133020''>so</span> <span m=''2133220''>on.</span>
  <span m=''2133730''>The</span> <span m=''2133840''>rest</span> <span m=''2134090''>of</span>
  <span m=''2134140''>them</span> <span m=''2134370''>can</span> <span m=''2134650''>do</span>
  <span m=''2134860''>register</span> <span m=''2135310''>moves</span> <span m=''2135740''>and</span>
  <span m=''2135940''>a</span> <span m=''2136130''>couple</span> <span m=''2136400''>of</span>
  <span m=''2136540''>other</span> <span m=''2136750''>things,</span> <span m=''2137100''>but</span>
  <span m=''2137430''>not</span> <span m=''2138610''>arithmetic</span> <span m=''2139140''>operations.</span>
  <span m=''2140760''>So</span> <span m=''2141120''>that''s</span> <span m=''2141330''>a</span>
  <span m=''2141360''>good</span> <span m=''2141540''>thing.</span> <span m=''2142200''>So</span>
  <span m=''2142440''>that''s</span> <span m=''2142660''>an</span> <span m=''2142870''>explanation</span>
  <span m=''2143560''>of</span> <span m=''2143680''>why</span> <span m=''2143930''>the</span>
  <span m=''2144040''>code</span> <span m=''2144270''>actually</span> <span m=''2144550''>sped</span>
  <span m=''2144860''>up.</span> </p><p><span m=''2145900''>Now,</span> <span m=''2146180''>just</span>
  <span m=''2146460''>as</span> <span m=''2146660''>an</span> <span m=''2147280''>overview</span>
  <span m=''2147820''>of</span> <span m=''2148980''>what</span> <span m=''2149250''>we</span>
  <span m=''2149390''>were</span> <span m=''2149470''>able</span> <span m=''2149670''>to</span>
  <span m=''2149760''>do,</span> <span m=''2150420''>we</span> <span m=''2151040''>ran</span>
  <span m=''2151490''>perf stat,</span> <span m=''2152730''>the</span> <span m=''2152840''>same</span>
  <span m=''2153080''>thing</span> <span m=''2153250''>that</span> <span m=''2153370''>we</span>
  <span m=''2153470''>did</span> <span m=''2153660''>for</span> <span m=''2153870''>mergesort,</span>
  <span m=''2154850''>or</span> <span m=''2155270''>for</span> <span m=''2155400''>the</span>
  <span m=''2155530''>original two</span> <span m=''2155880''>mergesorts.</span> <span
  m=''2157050''>And</span> <span m=''2157370''>we</span> <span m=''2158010''>made</span>
  <span m=''2158330''>a</span> <span m=''2158400''>table</span> <span m=''2158790''>of</span>
  <span m=''2158870''>the</span> <span m=''2158970''>improvements</span> <span m=''2159440''>that</span>
  <span m=''2159550''>we</span> <span m=''2159640''>made.</span> <span m=''2159900''>So</span>
  <span m=''2160180''>originally,</span> <span m=''2160840''>quicksort</span> <span
  m=''2161490''>ran</span> <span m=''2161750''>in</span> <span m=''2161890''>four</span>
  <span m=''2162240''>seconds.</span> <span m=''2163240''>And</span> <span m=''2163580''>it</span>
  <span m=''2163810''>had</span> <span m=''2164060''>an</span> <span m=''2164160''>IPC</span>
  <span m=''2164490''>of</span> <span m=''2164780''>0.8</span> <span m=''2165380''>and</span>
  <span m=''2166680''>11%</span> <span m=''2167250''>branch</span> <span m=''2167550''>missing.</span>
  <span m=''2168420''>So</span> <span m=''2168620''>when</span> <span m=''2168760''>we</span>
  <span m=''2168860''>switched</span> <span m=''2169230''>from</span> <span m=''2169480''>quicksort</span>
  <span m=''2170110''>to</span> <span m=''2170320''>standard</span> <span m=''2170790''>mergesort,</span>
  <span m=''2171690''>we</span> <span m=''2172640''>increased</span> <span m=''2173180''>execution</span>
  <span m=''2173720''>time</span> <span m=''2173920''>by</span> <span m=''2174050''>20%,</span>
  <span m=''2175140''>which</span> <span m=''2175610''>is</span> <span m=''2175940''>not</span>
  <span m=''2176200''>good.</span> <span m=''2177420''>But</span> <span m=''2177580''>the</span>
  <span m=''2177720''>instructions</span> <span m=''2178770''>per</span> <span m=''2178990''>clock</span>
  <span m=''2179390''>jumped</span> <span m=''2179640''>up</span> <span m=''2179770''>a</span>
  <span m=''2179840''>little</span> <span m=''2180090''>bit.</span> <span m=''2180810''>Branch
  miss</span> <span m=''2181290''>rate</span> <span m=''2181510''>is</span> <span
  m=''2181650''>still</span> <span m=''2181870''>pretty</span> <span m=''2182060''>bad.</span>
  </p><p><span m=''2183230''>Now,</span> <span m=''2183440''>as</span> <span m=''2183520''>soon</span>
  <span m=''2183670''>as</span> <span m=''2183840''>we</span> <span m=''2183940''>switched</span>
  <span m=''2184300''>it</span> <span m=''2184380''>to</span> <span m=''2184460''>branchless,</span>
  <span m=''2185700''>we</span> <span m=''2185980''>got</span> <span m=''2186240''>an</span>
  <span m=''2186420''>8%</span> <span m=''2186980''>improvement</span> <span m=''2187600''>over</span>
  <span m=''2187790''>the</span> <span m=''2187970''>previous</span> <span m=''2188500''>runtime.</span>
  <span m=''2189190''>But</span> <span m=''2189380''>note</span> <span m=''2189540''>that</span>
  <span m=''2189740''>we</span> <span m=''2189870''>were</span> <span m=''2190020''>still</span>
  <span m=''2190480''>worse</span> <span m=''2190740''>off than</span> <span m=''2191150''>quicksort</span>
  <span m=''2191980''>at</span> <span m=''2192120''>that</span> <span m=''2192300''>point.</span>
  <span m=''2195210''>But</span> <span m=''2195380''>the</span> <span m=''2195610''>instructions</span>
  <span m=''2196410''>per</span> <span m=''2196580''>clock</span> <span m=''2197070''>jumped</span>
  <span m=''2197580''>quite</span> <span m=''2197930''>a</span> <span m=''2197970''>bit</span>
  <span m=''2198240''>from</span> <span m=''2198420''>last</span> <span m=''2198710''>time,</span>
  <span m=''2198900''>which</span> <span m=''2199080''>is</span> <span m=''2199560''>kind</span>
  <span m=''2199720''>of</span> <span m=''2199870''>what</span> <span m=''2200010''>you</span>
  <span m=''2200090''>would</span> <span m=''2200230''>expect</span> <span m=''2201290''>with</span>
  <span m=''2201680''>reducing</span> <span m=''2202360''>the</span> <span m=''2202470''>branch</span>
  <span m=''2202790''>misses</span> <span m=''2203210''>by</span> <span m=''2203360''>a</span>
  <span m=''2203430''>factor</span> <span m=''2203820''>of</span> <span m=''2203890''>10.</span>
  <span m=''2204230''>So</span> <span m=''2204690''>the</span> <span m=''2205280''>CPU</span>
  <span m=''2205380''>isn''t</span> <span m=''2205500''>spending</span> <span m=''2206550''>extra</span>
  <span m=''2206850''>time</span> <span m=''2207420''>stalling</span> <span m=''2207620''>the</span>
  <span m=''2207700''>pipeline,</span> <span m=''2208180''>trying</span> <span m=''2208470''>to</span>
  <span m=''2209090''>backtrack</span> <span m=''2209600''>on</span> <span m=''2209750''>its</span>
  <span m=''2210120''>branch</span> <span m=''2210650''>mispredicts.</span> </p><p><span
  m=''2211880''>And</span> <span m=''2212080''>now</span> <span m=''2212480''>the</span>
  <span m=''2212670''>more</span> <span m=''2212950''>interesting</span> <span m=''2213450''>thing</span>
  <span m=''2213640''>to</span> <span m=''2213770''>me</span> <span m=''2214460''>is,</span>
  <span m=''2215750''>if</span> <span m=''2215900''>you</span> <span m=''2216010''>look</span>
  <span m=''2216210''>at</span> <span m=''2216890''>the</span> <span m=''2217250''>two</span>
  <span m=''2217600''>silly</span> <span m=''2218360''>little</span> <span m=''2218570''>compiler</span>
  <span m=''2219080''>optimizations</span> <span m=''2219810''>we</span> <span m=''2219930''>made,</span>
  <span m=''2221150''>switching</span> <span m=''2221540''>from</span> <span m=''2221760''>int
  to</span> <span m=''2222070''>long</span> <span m=''2222520''>reduced</span> <span
  m=''2223410''>the</span> <span m=''2223550''>runtime</span> <span m=''2224000''>by</span>
  <span m=''2224370''>11%</span> <span m=''2225930''>over</span> <span m=''2226690''>the</span>
  <span m=''2226850''>previous</span> <span m=''2227240''>branchless</span> <span
  m=''2227710''>implementation.</span> <span m=''2229510''>And</span> <span m=''2229700''>then</span>
  <span m=''2230880''>instructions</span> <span m=''2231460''>per</span> <span m=''2231600''>clock</span>
  <span m=''2231940''>and</span> <span m=''2232240''>branch</span> <span m=''2232530''>miss</span>
  <span m=''2232810''>both</span> <span m=''2233090''>didn''t</span> <span m=''2233310''>change</span>
  <span m=''2233560''>at</span> <span m=''2233640''>this</span> <span m=''2233820''>point.</span>
  <span m=''2234020''>At</span> <span m=''2234130''>this</span> <span m=''2234280''>point,</span>
  <span m=''2234460''>we were</span> <span m=''2234630''>just</span> <span m=''2234880''>reducing</span>
  <span m=''2235310''>the</span> <span m=''2235420''>number</span> <span m=''2235710''>of</span>
  <span m=''2235790''>instructions.</span> <span m=''2237210''>And</span> <span m=''2237630''>then</span>
  <span m=''2239230''>going</span> <span m=''2239540''>from</span> <span m=''2239820''>there</span>
  <span m=''2240500''>to</span> <span m=''2241000''>changing</span> <span m=''2241540''>not</span>
  <span m=''2241860''>CMP</span> <span m=''2242450''>to</span> <span m=''2242650''>1</span>
  <span m=''2242970''>minus</span> <span m=''2243340''>CMP</span> <span m=''2244820''>reduced</span>
  <span m=''2245220''>our</span> <span m=''2245330''>runtime</span> <span m=''2245760''>by</span>
  <span m=''2245930''>another</span> <span m=''2246620''>7%</span> <span m=''2248020''>from</span>
  <span m=''2248170''>before.</span> </p><p><span m=''2249020''>So</span> <span m=''2249260''>overall,</span>
  <span m=''2250130''>branchless</span> <span m=''2251020''>mergesorting</span> <span
  m=''2251990''>is</span> <span m=''2252460''>10.8%</span> <span m=''2253340''>faster</span>
  <span m=''2253860''>than</span> <span m=''2254040''>quicksorting</span> <span m=''2254940''>by</span>
  <span m=''2255080''>the</span> <span m=''2255150''>time</span> <span m=''2255350''>we
  were</span> <span m=''2255540''>done</span> <span m=''2255760''>optimizing,</span>
  <span m=''2256690''>which</span> <span m=''2257010''>is</span> <span m=''2257380''>a</span>
  <span m=''2257500''>lot</span> <span m=''2257720''>better</span> <span m=''2258700''>than</span>
  <span m=''2259850''>negative.</span> <span m=''2260770''>At</span> <span m=''2260970''>this</span>
  <span m=''2261150''>point,</span> <span m=''2261320''>we were</span> <span m=''2261500''>still</span>
  <span m=''2261730''>behind.</span> <span m=''2262550''>And</span> <span m=''2263060''>at</span>
  <span m=''2263220''>the</span> <span m=''2263400''>end,</span> <span m=''2263580''>we</span>
  <span m=''2263700''>ended</span> <span m=''2263930''>up</span> <span m=''2264050''>ahead</span>
  <span m=''2264360''>of</span> <span m=''2264460''>quicksort.</span> <span m=''2265560''>And</span>
  <span m=''2265710''>then,</span> <span m=''2266410''>overall,</span> <span m=''2267370''>switching</span>
  <span m=''2267850''>to</span> <span m=''2267940''>branchless,</span> <span m=''2268540''>with</span>
  <span m=''2268670''>all</span> <span m=''2268950''>the</span> <span m=''2269300''>performance</span>
  <span m=''2270280''>tweaks</span> <span m=''2270570''>that</span> <span m=''2270680''>we</span>
  <span m=''2270780''>made,</span> <span m=''2271410''>was</span> <span m=''2271650''>33.6%</span>
  <span m=''2273230''>better</span> <span m=''2273600''>over</span> <span m=''2273890''>the</span>
  <span m=''2274180''>branching</span> <span m=''2274730''>version.</span> <span m=''2275170''>So</span>
  <span m=''2275220''>the</span> <span m=''2275320''>non-branching</span> <span m=''2276740''>ran</span>
  <span m=''2277140''>a third</span> <span m=''2277430''>faster</span> <span m=''2278350''>than</span>
  <span m=''2278530''>the</span> <span m=''2278960''>branching</span> <span m=''2279340''>version,</span>
  <span m=''2280260''>which</span> <span m=''2280550''>is</span> <span m=''2280770''>pretty</span>
  <span m=''2281080''>cool.</span> <span m=''2281870''>And</span> <span m=''2282210''>that''s</span>
  <span m=''2282470''>something</span> <span m=''2282740''>that</span> <span m=''2282880''>we</span>
  <span m=''2282980''>learned</span> <span m=''2283280''>at</span> <span m=''2283350''>the</span>
  <span m=''2283450''>end</span> <span m=''2283640''>of the</span> <span m=''2283750''>day</span>
  <span m=''2283980''>yesterday.</span> </p><p><span m=''2285750''>So</span> <span
  m=''2287080''>to</span> <span m=''2287230''>conclude,</span> <span m=''2287860''>what</span>
  <span m=''2288350''>did</span> <span m=''2288470''>we</span> <span m=''2288600''>learn</span>
  <span m=''2289700''>when</span> <span m=''2289980''>we</span> <span m=''2290020''>were</span>
  <span m=''2290170''>doing</span> <span m=''2290410''>this?</span> <span m=''2290630''>Well,</span>
  <span m=''2291160''>I</span> <span m=''2291290''>think</span> <span m=''2291530''>a</span>
  <span m=''2291620''>lot</span> <span m=''2291840''>of</span> <span m=''2291920''>that</span>
  <span m=''2292160''>applies</span> <span m=''2292580''>to</span> <span m=''2293040''>the</span>
  <span m=''2293130''>PSETS</span> <span m=''2293590''>that</span> <span m=''2293720''>you''re</span>
  <span m=''2293840''>doing</span> <span m=''2294240''>and</span> <span m=''2294500''>how</span>
  <span m=''2294730''>you</span> <span m=''2294850''>should</span> <span m=''2294980''>go</span>
  <span m=''2295170''>about</span> <span m=''2296130''>optimizing</span> <span m=''2296720''>performance</span>
  <span m=''2297390''>on</span> <span m=''2297670''>the</span> <span m=''2297800''>code</span>
  <span m=''2298050''>that</span> <span m=''2298210''>we</span> <span m=''2298500''>give</span>
  <span m=''2298700''>you.</span> <span m=''2299420''>And</span> <span m=''2299820''>it''s</span>
  <span m=''2300520''>profile</span> <span m=''2301150''>before</span> <span m=''2301530''>you</span>
  <span m=''2301620''>optimize.</span> <span m=''2302190''>So</span> <span m=''2302280''>before</span>
  <span m=''2302660''>you</span> <span m=''2303740''>spend</span> <span m=''2304080''>too</span>
  <span m=''2304200''>much</span> <span m=''2304450''>time</span> <span m=''2304820''>just</span>
  <span m=''2305080''>reading</span> <span m=''2305530''>through</span> <span m=''2305710''>source</span>
  <span m=''2306070''>code</span> <span m=''2306400''>and</span> <span m=''2306650''>making</span>
  <span m=''2306970''>wild</span> <span m=''2307290''>guesses</span> <span m=''2307710''>as</span>
  <span m=''2307880''>to</span> <span m=''2308000''>why</span> <span m=''2308340''>the</span>
  <span m=''2308480''>code</span> <span m=''2308730''>is</span> <span m=''2308930''>slow,</span>
  <span m=''2310090''>profile</span> <span m=''2310530''>the</span> <span m=''2310630''>code.</span>
  <span m=''2310920''>See</span> <span m=''2311200''>why</span> <span m=''2311520''>it''s</span>
  <span m=''2311660''>actually</span> <span m=''2311930''>slow.</span> <span m=''2312250''>Get</span>
  <span m=''2312400''>some</span> <span m=''2312530''>performance</span> <span m=''2313010''>counter</span>
  <span m=''2313320''>data.</span> <span m=''2315280''>Do</span> <span m=''2315410''>some</span>
  <span m=''2316030''>perf</span> <span m=''2316410''>annotate,</span> <span m=''2317280''>so</span>
  <span m=''2317570''>that it</span> <span m=''2317830''>tells</span> <span m=''2318040''>you</span>
  <span m=''2318620''>what</span> <span m=''2318850''>assembly</span> <span m=''2319270''>or</span>
  <span m=''2319470''>what</span> <span m=''2319670''>line</span> <span m=''2319890''>of</span>
  <span m=''2319950''>code</span> <span m=''2320250''>that</span> <span m=''2320390''>it''s</span>
  <span m=''2320550''>actually</span> <span m=''2321060''>spending</span> <span m=''2321400''>the</span>
  <span m=''2321540''>most</span> <span m=''2321680''>time</span> <span m=''2321990''>on.</span>
  </p><p><span m=''2322710''>And</span> <span m=''2322860''>then,</span> <span m=''2323210''>optimize</span>
  <span m=''2323780''>iteratively.</span> <span m=''2324270''>Don''t</span> <span
  m=''2324500''>try</span> <span m=''2324650''>to</span> <span m=''2324750''>do</span>
  <span m=''2324990''>everything</span> <span m=''2325420''>at</span> <span m=''2325530''>once.</span>
  <span m=''2326000''>Do</span> <span m=''2326140''>things</span> <span m=''2326440''>one</span>
  <span m=''2326760''>at</span> <span m=''2326890''>a</span> <span m=''2326950''>time</span>
  <span m=''2327370''>to</span> <span m=''2327530''>see</span> <span m=''2327740''>whether</span>
  <span m=''2327900''>or</span> <span m=''2327990''>not</span> <span m=''2328160''>they</span>
  <span m=''2328230''>make</span> <span m=''2328450''>a</span> <span m=''2328480''>difference.</span>
  <span m=''2329500''>Now,</span> <span m=''2329680''>before</span> <span m=''2330030''>we</span>
  <span m=''2330190''>arrived</span> <span m=''2330540''>at</span> <span m=''2331670''>the</span>
  <span m=''2331980''>not,</span> <span m=''2332660''>there are</span> <span m=''2332890''>so</span>
  <span m=''2333040''>many</span> <span m=''2333240''>different</span> <span m=''2333500''>ways</span>
  <span m=''2333700''>that</span> <span m=''2333800''>you</span> <span m=''2333900''>could</span>
  <span m=''2334060''>have</span> <span m=''2334210''>expressed</span> <span m=''2334970''>not</span>
  <span m=''2335410''>and</span> <span m=''2335530''>1</span> <span m=''2335730''>minus</span>
  <span m=''2336200''>and</span> <span m=''2336500''>negative</span> <span m=''2336980''>and</span>
  <span m=''2337100''>so</span> <span m=''2337290''>on.</span> <span m=''2337790''>So</span>
  <span m=''2338010''>if</span> <span m=''2338100''>you</span> <span m=''2338200''>try</span>
  <span m=''2338410''>them</span> <span m=''2338590''>all</span> <span m=''2338740''>at</span>
  <span m=''2338840''>once,</span> <span m=''2339090''>you</span> <span m=''2339210''>really</span>
  <span m=''2339460''>don''t</span> <span m=''2339690''>know</span> <span m=''2339880''>what</span>
  <span m=''2340350''>made the</span> <span m=''2340670''>improvement.</span> <span
  m=''2341260''>So</span> <span m=''2341310''>you''ve</span> <span m=''2341410''>got</span>
  <span m=''2341560''>to</span> <span m=''2341600''>try</span> <span m=''2341810''>things</span>
  <span m=''2342060''>one</span> <span m=''2342280''>at a</span> <span m=''2342490''>time</span>
  <span m=''2342770''>and</span> <span m=''2342930''>see</span> <span m=''2343100''>what</span>
  <span m=''2343320''>it</span> <span m=''2343400''>causes</span> <span m=''2343810''>the</span>
  <span m=''2343890''>compiler</span> <span m=''2344320''>to</span> <span m=''2344410''>do,</span>
  <span m=''2345100''>because</span> <span m=''2348080''>you</span> <span m=''2348200''>can</span>
  <span m=''2348340''>see</span> <span m=''2348490''>in</span> <span m=''2348560''>the</span>
  <span m=''2348640''>previous</span> <span m=''2349030''>two</span> <span m=''2349180''>examples,</span>
  <span m=''2349880''>by</span> <span m=''2350140''>the</span> <span m=''2350200''>time</span>
  <span m=''2350370''>we</span> <span m=''2350480''>made</span> <span m=''2350650''>that</span>
  <span m=''2350790''>one</span> <span m=''2350990''>optimization,</span> <span m=''2351720''>it</span>
  <span m=''2351770''>wasn''t</span> <span m=''2352190''>just</span> <span m=''2352380''>that</span>
  <span m=''2352580''>one</span> <span m=''2352860''>assembly</span> <span m=''2353280''>instruction</span>
  <span m=''2353740''>that</span> <span m=''2353910''>the</span> <span m=''2354040''>compiler</span>
  <span m=''2354560''>ended</span> <span m=''2354810''>up</span> <span m=''2354940''>changing.</span>
  <span m=''2355700''>The</span> <span m=''2355810''>compiler,</span> <span m=''2356420''>in</span>
  <span m=''2356590''>fact,</span> <span m=''2357130''>realized</span> <span m=''2357550''>that</span>
  <span m=''2357660''>it</span> <span m=''2357730''>could</span> <span m=''2357860''>do</span>
  <span m=''2357980''>additional</span> <span m=''2358360''>optimizations</span> <span
  m=''2359220''>on</span> <span m=''2359450''>top</span> <span m=''2359720''>of</span>
  <span m=''2359840''>what</span> <span m=''2360020''>we</span> <span m=''2360140''>hinted</span>
  <span m=''2360620''>to</span> <span m=''2360840''>it.</span> <span m=''2361250''>So</span>
  <span m=''2361500''>it</span> <span m=''2361600''>did</span> <span m=''2361790''>even</span>
  <span m=''2362020''>more</span> <span m=''2362260''>optimizations.</span> <span
  m=''2363280''>But</span> <span m=''2363480''>the</span> <span m=''2363550''>bottom</span>
  <span m=''2363910''>line</span> <span m=''2364190''>is,</span> <span m=''2365110''>you</span>
  <span m=''2365300''>should</span> <span m=''2365600''>optimize</span> <span m=''2366060''>iteratively.</span>
  <span m=''2366550''>Try</span> <span m=''2366800''>something,</span> <span m=''2367230''>and</span>
  <span m=''2367380''>see</span> <span m=''2367510''>what</span> <span m=''2367710''>effect</span>
  <span m=''2368080''>it</span> <span m=''2368130''>has</span> <span m=''2368430''>before</span>
  <span m=''2369070''>moving</span> <span m=''2369400''>on and</span> <span m=''2369620''>trying</span>
  <span m=''2369930''>something</span> <span m=''2370280''>else.</span> </p><p><span
  m=''2371130''>And</span> <span m=''2371310''>then,</span> <span m=''2372640''>as</span>
  <span m=''2372840''>much</span> <span m=''2373120''>as</span> <span m=''2373480''>I</span>
  <span m=''2373680''>don''t</span> <span m=''2373880''>like</span> <span m=''2374190''>coding</span>
  <span m=''2374550''>assembly,</span> <span m=''2374980''>and</span> <span m=''2375120''>I</span>
  <span m=''2375250''>don''t</span> <span m=''2375570''>expect</span> <span m=''2376000''>that</span>
  <span m=''2376200''>anybody</span> <span m=''2376630''>here</span> <span m=''2376860''>codes</span>
  <span m=''2377170''>assembly</span> <span m=''2377550''>for</span> <span m=''2377680''>the</span>
  <span m=''2377770''>class,</span> <span m=''2378500''>looking</span> <span m=''2378890''>at</span>
  <span m=''2379000''>the</span> <span m=''2379090''>assembly</span> <span m=''2379520''>is</span>
  <span m=''2379670''>always</span> <span m=''2379980''>a</span> <span m=''2380010''>good</span>
  <span m=''2380240''>thing.</span> <span m=''2381160''>Just</span> <span m=''2381560''>skim</span>
  <span m=''2381930''>through</span> <span m=''2382180''>it</span> <span m=''2383370''>for</span>
  <span m=''2383510''>your</span> <span m=''2383610''>performance</span> <span m=''2384060''>bottlenecks.</span>
  <span m=''2384530''>And</span> <span m=''2384660''>try</span> <span m=''2384890''>to</span>
  <span m=''2384950''>get</span> <span m=''2385120''>an</span> <span m=''2385260''>idea</span>
  <span m=''2385560''>of</span> <span m=''2385660''>what</span> <span m=''2385840''>the</span>
  <span m=''2385920''>compiler</span> <span m=''2386890''>is</span> <span m=''2387070''>asking</span>
  <span m=''2387420''>the</span> <span m=''2387500''>CPU</span> <span m=''2387870''>to</span>
  <span m=''2387970''>do.</span> <span m=''2388520''>And</span> <span m=''2388730''>see</span>
  <span m=''2388900''>if</span> <span m=''2389020''>there''s</span> <span m=''2389250''>a</span>
  <span m=''2389320''>way</span> <span m=''2389990''>that</span> <span m=''2390270''>you</span>
  <span m=''2390400''>can</span> <span m=''2390620''>nudge</span> <span m=''2391220''>the</span>
  <span m=''2391380''>compiler</span> <span m=''2391860''>to</span> <span m=''2391960''>do</span>
  <span m=''2392120''>the</span> <span m=''2392230''>right</span> <span m=''2392490''>thing.</span>
  </p><p><span m=''2393240''>Sometimes</span> <span m=''2393640''>we</span> <span
  m=''2393740''>tell</span> <span m=''2393910''>you</span> <span m=''2394030''>the</span>
  <span m=''2394140''>compiler</span> <span m=''2394580''>will</span> <span m=''2394830''>optimize</span>
  <span m=''2395770''>certain</span> <span m=''2396110''>things,</span> <span m=''2396380''>will</span>
  <span m=''2396530''>get</span> <span m=''2396700''>rid</span> <span m=''2396870''>of</span>
  <span m=''2397010''>dead</span> <span m=''2397230''>code,</span> <span m=''2397560''>and</span>
  <span m=''2397690''>so</span> <span m=''2397870''>on.</span> <span m=''2398320''>And</span>
  <span m=''2398470''>most</span> <span m=''2398630''>of the</span> <span m=''2398780''>time,</span>
  <span m=''2398970''>that''s</span> <span m=''2399190''>actually</span> <span m=''2399490''>true.</span>
  <span m=''2399820''>But</span> <span m=''2400130''>it</span> <span m=''2400360''>doesn''t</span>
  <span m=''2400720''>hurt</span> <span m=''2401010''>to</span> <span m=''2401500''>double-check</span>
  <span m=''2402150''>in</span> <span m=''2402230''>the</span> <span m=''2402620''>assembly</span>
  <span m=''2403080''>and</span> <span m=''2403160''>make</span> <span m=''2403310''>sure</span>
  <span m=''2403450''>that</span> <span m=''2403590''>it''s</span> <span m=''2403730''>actually</span>
  <span m=''2404000''>doing</span> <span m=''2404250''>that.</span> <span m=''2404930''>And</span>
  <span m=''2405110''>the</span> <span m=''2405230''>output</span> <span m=''2405600''>from</span>
  <span m=''2405860''>perf</span> <span m=''2407390''>is</span> <span m=''2407660''>pretty</span>
  <span m=''2407910''>helpful</span> <span m=''2408340''>to</span> <span m=''2408550''>doing</span>
  <span m=''2408860''>this.</span> <span m=''2409150''>It''s</span> <span m=''2409530''>not</span>
  <span m=''2409740''>a</span> <span m=''2409790''>monumental</span> <span m=''2410410''>task</span>
  <span m=''2410750''>of</span> <span m=''2410980''>disassembling.</span> <span m=''2411800''>It</span>
  <span m=''2412220''>does</span> <span m=''2412450''>all</span> <span m=''2412580''>of</span>
  <span m=''2412660''>the</span> <span m=''2412860''>annotation</span> <span m=''2413400''>and</span>
  <span m=''2413500''>interleaving</span> <span m=''2414010''>for</span> <span m=''2414250''>you.</span>
  </p><p><span m=''2415000''>And</span> <span m=''2415240''>finally,</span> <span
  m=''2416890''>learn</span> <span m=''2417160''>through</span> <span m=''2417300''>practice.</span>
  <span m=''2418210''>That''s</span> <span m=''2418500''>the</span> <span m=''2418670''>only</span>
  <span m=''2418840''>way</span> <span m=''2419940''>to</span> <span m=''2420230''>learn</span>
  <span m=''2420450''>how</span> <span m=''2420560''>to</span> <span m=''2420680''>do</span>
  <span m=''2420850''>this</span> <span m=''2421390''>performance</span> <span m=''2421830''>optimization.</span>
  <span m=''2422470''>You</span> <span m=''2422580''>gain</span> <span m=''2422800''>a</span>
  <span m=''2422870''>lot</span> <span m=''2423110''>of</span> <span m=''2423230''>experience</span>
  <span m=''2423565''>from</span> <span m=''2423900''>just</span> <span m=''2424170''>going</span>
  <span m=''2424450''>out</span> <span m=''2424580''>and</span> <span m=''2424680''>trying</span>
  <span m=''2424880''>the</span> <span m=''2425080''>tools.</span> <span m=''2425900''>And</span>
  <span m=''2426200''>Project 2</span> <span m=''2426880''>will</span> <span m=''2427080''>have</span>
  <span m=''2427250''>you</span> <span m=''2427410''>working</span> <span m=''2427700''>with</span>
  <span m=''2427830''>these</span> <span m=''2428440''>tools.</span> <span m=''2429450''>Project</span>
  <span m=''2429770''>2.1</span> <span m=''2430550''>does</span> <span m=''2430740''>not</span>
  <span m=''2430950''>have</span> <span m=''2431210''>a</span> <span m=''2431570''>code</span>
  <span m=''2431980''>submission.</span> <span m=''2432500''>It''s</span> <span m=''2432800''>just</span>
  <span m=''2433070''>a</span> <span m=''2433280''>write-up,</span> <span m=''2434020''>where</span>
  <span m=''2434270''>you</span> <span m=''2434390''>get</span> <span m=''2434600''>to</span>
  <span m=''2434730''>just</span> <span m=''2435000''>play</span> <span m=''2435170''>around</span>
  <span m=''2435490''>with the</span> <span m=''2435590''>tools</span> <span m=''2436270''>on</span>
  <span m=''2436470''>code</span> <span m=''2436710''>that</span> <span m=''2436840''>we</span>
  <span m=''2436980''>give</span> <span m=''2437220''>you,</span> <span m=''2437410''>so</span>
  <span m=''2437540''>you</span> <span m=''2437730''>can</span> <span m=''2437910''>see</span>
  <span m=''2438230''>how</span> <span m=''2438430''>to</span> <span m=''2438500''>use</span>
  <span m=''2438810''>the</span> <span m=''2438890''>tools.</span> <span m=''2439600''>And</span>
  <span m=''2439750''>then</span> <span m=''2439930''>Project</span> <span m=''2440430''>2.2,</span>
  <span m=''2441900''>which</span> <span m=''2442260''>is</span> <span m=''2442460''>going</span>
  <span m=''2442710''>out</span> <span m=''2442860''>next</span> <span m=''2443150''>week,</span>
  <span m=''2443370''>will</span> <span m=''2443550''>actually</span> <span m=''2443950''>give</span>
  <span m=''2444150''>you</span> <span m=''2444310''>a</span> <span m=''2444380''>chance</span>
  <span m=''2444750''>to</span> <span m=''2445000''>try</span> <span m=''2445380''>to</span>
  <span m=''2445700''>optimize</span> <span m=''2446300''>code</span> <span m=''2446540''>that</span>
  <span m=''2446650''>we</span> <span m=''2446750''>give</span> <span m=''2446960''>you,</span>
  <span m=''2447760''>using</span> <span m=''2448070''>these</span> <span m=''2448260''>tools</span>
  <span m=''2448590''>to</span> <span m=''2448680''>help</span> <span m=''2448890''>you
  out</span> <span m=''2449150''>along</span> <span m=''2449390''>the</span> <span
  m=''2449470''>way.</span> <span m=''2450760''>So</span> <span m=''2451150''>with</span>
  <span m=''2451340''>that</span> <span m=''2451530''>said,</span> <span m=''2451810''>any</span>
  <span m=''2452190''>questions</span> <span m=''2452890''>about--</span> </p><p><span
  m=''2454719''>AUDIENCE: [INAUDIBLE]</span> <span m=''2455182''>a</span> <span m=''2455645''>write-up.</span>
  <span m=''2456571''>how do</span> <span m=''2457034''>you submit</span> <span m=''2457497''>write-ups</span>
  <span m=''2457960''>for</span> <span m=''2458423''>projects?</span> </p><p><span
  m=''2459890''>GUEST SPEAKER 2: On</span> <span m=''2460170''>Stellar.</span> <span
  m=''2461050''>So</span> <span m=''2462130''>the</span> <span m=''2462200''>handouts</span>
  <span m=''2462990''>for</span> <span m=''2463240''>the</span> <span m=''2463400''>write-ups</span>
  <span m=''2463820''>are</span> <span m=''2464330''>Stellar</span> <span m=''2464620''>homework</span>
  <span m=''2465000''>assignments.</span> <span m=''2465480''>Just</span> <span m=''2465670''>upload</span>
  <span m=''2465980''>a</span> <span m=''2466030''>PDF</span> <span m=''2466490''>to</span>
  <span m=''2466700''>Stellar.</span> </p><p><span m=''2467568''>AUDIENCE: OK.</span>
  </p><p><span m=''2470320''>GUEST SPEAKER 2: Yes?</span> </p><p><span m=''2471752''>AUDIENCE:
  [INAUDIBLE PHRASE]</span> </p><p><span m=''2479850''>GUEST SPEAKER 1: Yeah,</span>
  <span m=''2480260''>you</span> <span m=''2480670''>just</span> <span m=''2480880''>have
  to</span> <span m=''2481010''>build</span> <span m=''2481370''>the</span> <span
  m=''2481490''>binary</span> <span m=''2481690''>with</span> <span m=''2481890''>debug</span>
  <span m=''2482300''>info.</span> </p><p><span m=''2482610''>GUEST SPEAKER 2: Yeah,</span>
  <span m=''2483340''>minus</span> <span m=''2483710''>G</span> <span m=''2483870''>is</span>
  <span m=''2484020''>enough.</span> <span m=''2484340''>As</span> <span m=''2484520''>long</span>
  <span m=''2484760''>as</span> <span m=''2485605''>GDB''s</span> <span m=''2486570''>break</span>
  <span m=''2486840''>points</span> <span m=''2487160''>can see</span> <span m=''2487660''>your</span>
  <span m=''2487860''>code,</span> <span m=''2489100''>then</span> <span m=''2489680''>perf</span>
  <span m=''2489940''>can</span> <span m=''2490090''>do</span> <span m=''2490260''>it.</span>
  <span m=''2494420''>And</span> <span m=''2494690''>it''s</span> <span m=''2494830''>actually</span>
  <span m=''2495210''>pretty</span> <span m=''2495530''>nice</span> <span m=''2495920''>in</span>
  <span m=''2496060''>that,</span> <span m=''2496380''>even</span> <span m=''2496610''>if</span>
  <span m=''2496710''>your</span> <span m=''2496820''>code</span> <span m=''2497070''>is</span>
  <span m=''2497230''>inlined,</span> <span m=''2497640''>it</span> <span m=''2497740''>can</span>
  <span m=''2498140''>identify</span> <span m=''2498890''>where</span> <span m=''2499240''>the</span>
  <span m=''2499370''>inlined</span> <span m=''2499730''>portions</span> <span m=''2500150''>came</span>
  <span m=''2500400''>from</span> <span m=''2500840''>and</span> <span m=''2501230''>pull</span>
  <span m=''2501350''>in</span> <span m=''2501420''>the</span> <span m=''2501500''>proper</span>
  <span m=''2501820''>lines</span> <span m=''2502070''>of</span> <span m=''2502130''>code</span>
  <span m=''2502370''>for</span> <span m=''2502480''>that.</span> </p><p><span m=''2504390''>SAMAN
  AMARASINGHE: I</span> <span m=''2504550''>think</span> <span m=''2504700''>what''s</span>
  <span m=''2504950''>really</span> <span m=''2505150''>interesting</span> <span m=''2505650''>and</span>
  <span m=''2505850''>important</span> <span m=''2506410''>here</span> <span m=''2506660''>is</span>
  <span m=''2507720''>not</span> <span m=''2507990''>that</span> <span m=''2508150''>they</span>
  <span m=''2508280''>found</span> <span m=''2508560''>this</span> <span m=''2508690''>interesting</span>
  <span m=''2509110''>thing,</span> <span m=''2509280''>but</span> <span m=''2509410''>the</span>
  <span m=''2509500''>process</span> <span m=''2510070''>they</span> <span m=''2510240''>went</span>
  <span m=''2510490''>about.</span> <span m=''2510940''>A</span> <span m=''2511370''>lot
  of</span> <span m=''2511830''>times,</span> <span m=''2512060''>when you</span>
  <span m=''2512290''>are coding,</span> <span m=''2512800''>you</span> <span m=''2512970''>are
  in</span> <span m=''2513250''>control.</span> <span m=''2514110''>You</span> <span
  m=''2514300''>have</span> <span m=''2515110''>very</span> <span m=''2515410''>planned</span>
  <span m=''2515970''>structure</span> <span m=''2516180''>how</span> <span m=''2516380''>you''re</span>
  <span m=''2516630''>going</span> <span m=''2516920''>about</span> <span m=''2517230''>doing</span>
  <span m=''2517440''>that.</span> <span m=''2517720''>And</span> <span m=''2517870''>you</span>
  <span m=''2517990''>follow</span> <span m=''2518330''>these</span> <span m=''2518520''>through</span>
  <span m=''2518760''>and</span> <span m=''2519480''>produce</span> <span m=''2519780''>the</span>
  <span m=''2519870''>code</span> <span m=''2520080''>you</span> <span m=''2520260''>want.</span>
  <span m=''2520800''>And</span> <span m=''2520970''>sometimes,</span> <span m=''2521380''>some</span>
  <span m=''2521530''>pesky</span> <span m=''2521860''>bugs</span> <span m=''2522080''>show</span>
  <span m=''2522300''>up.</span> <span m=''2522440''>You</span> <span m=''2522900''>go</span>
  <span m=''2523060''>through</span> <span m=''2523210''>that.</span> </p><p><span
  m=''2524120''>Here</span> <span m=''2524350''>is,</span> <span m=''2524540''>basically,</span>
  <span m=''2525520''>you</span> <span m=''2526660''>basically</span> <span m=''2527290''>let</span>
  <span m=''2527570''>the</span> <span m=''2527660''>system</span> <span m=''2528260''>and</span>
  <span m=''2528470''>data</span> <span m=''2528840''>drive</span> <span m=''2529240''>what</span>
  <span m=''2529490''>you are</span> <span m=''2529660''>doing.</span> <span m=''2530700''>And</span>
  <span m=''2531770''>when</span> <span m=''2531920''>you</span> <span m=''2532020''>start,</span>
  <span m=''2533280''>there''s</span> <span m=''2533560''>no</span> <span m=''2533750''>planned</span>
  <span m=''2534130''>part,</span> <span m=''2534340''>saying,</span> <span m=''2534550''>I''m</span>
  <span m=''2534670''>going</span> <span m=''2534810''>to do</span> <span m=''2535010''>A,
  B,</span> <span m=''2535260''>C, D.</span> <span m=''2536285''>Basically,</span>
  <span m=''2537460''>you</span> <span m=''2537580''>look</span> <span m=''2537730''>at</span>
  <span m=''2537840''>the</span> <span m=''2537930''>results,</span> <span m=''2538420''>and</span>
  <span m=''2538580''>you</span> <span m=''2538740''>figure</span> <span m=''2539230''>out</span>
  <span m=''2539370''>what</span> <span m=''2539600''>might</span> <span m=''2539850''>change.</span>
  <span m=''2540180''>And</span> <span m=''2540320''>you</span> <span m=''2540420''>can</span>
  <span m=''2540620''>go</span> <span m=''2540800''>through</span> <span m=''2540980''>that.</span>
  </p><p><span m=''2541640''>And</span> <span m=''2543000''>I</span> <span m=''2543140''>was</span>
  <span m=''2543280''>actually</span> <span m=''2543720''>talking</span> <span m=''2544000''>with</span>
  <span m=''2544270''>Charles,</span> <span m=''2544550''>saying,</span> <span m=''2545140''>in</span>
  <span m=''2545250''>my</span> <span m=''2545390''>first</span> <span m=''2545710''>lecture,</span>
  <span m=''2546050''>I</span> <span m=''2546110''>talked about</span> <span m=''2546350''>Matrix</span>
  <span m=''2546700''>Multiply.</span> <span m=''2548130''>It</span> <span m=''2548270''>looks</span>
  <span m=''2548575''>really</span> <span m=''2548880''>cool.</span> <span m=''2549050''>Every</span>
  <span m=''2549180''>time</span> <span m=''2549300''>I</span> <span m=''2549520''>do</span>
  <span m=''2549650''>something,</span> <span m=''2550130''>it</span> <span m=''2550340''>improved</span>
  <span m=''2550940''>by a</span> <span m=''2551200''>factor</span> <span m=''2551540''>of</span>
  <span m=''2551680''>2,</span> <span m=''2552080''>50%,</span> <span m=''2552890''>stuff</span>
  <span m=''2553170''>like</span> <span m=''2553390''>that.</span> <span m=''2553930''>What</span>
  <span m=''2554150''>you</span> <span m=''2554280''>didn''t</span> <span m=''2554800''>see</span>
  <span m=''2555300''>is</span> <span m=''2555550''>all</span> <span m=''2555900''>the</span>
  <span m=''2556020''>things</span> <span m=''2556310''>I</span> <span m=''2556420''>did</span>
  <span m=''2557100''>that</span> <span m=''2557350''>didn''t</span> <span m=''2557540''>have</span>
  <span m=''2557670''>any</span> <span m=''2557930''>impact</span> <span m=''2558250''>on</span>
  <span m=''2558340''>the</span> <span m=''2558420''>program.</span> <span m=''2560130''>You</span>
  <span m=''2560310''>saw</span> <span m=''2560500''>this</span> <span m=''2560730''>nice</span>
  <span m=''2561070''>tree</span> <span m=''2561355''>going</span> <span m=''2561640''>down</span>
  <span m=''2561840''>there,</span> <span m=''2562270''>all</span> <span m=''2562630''>these</span>
  <span m=''2562850''>leaves</span> <span m=''2563240''>that</span> <span m=''2564480''>end</span>
  <span m=''2564680''>up</span> <span m=''2564810''>in</span> <span m=''2564920''>dead</span>
  <span m=''2565200''>ends,</span> <span m=''2565520''>that had</span> <span m=''2565940''>nothing</span>
  <span m=''2566300''>happened.</span> </p><p><span m=''2566890''>So</span> <span
  m=''2567340''>if</span> <span m=''2567580''>you</span> <span m=''2567750''>feel</span>
  <span m=''2568070''>like</span> <span m=''2568320''>when you</span> <span m=''2568340''>go</span>
  <span m=''2568710''>there,</span> <span m=''2568890''>you</span> <span m=''2569010''>do</span>
  <span m=''2569260''>a</span> <span m=''2569360''>bunch</span> <span m=''2569620''>of</span>
  <span m=''2569700''>things,</span> <span m=''2569870''>nothing</span> <span m=''2570160''>happens,</span>
  <span m=''2570760''>that''s</span> <span m=''2570940''>normal.</span> <span m=''2571830''>Of</span>
  <span m=''2571940''>course,</span> <span m=''2572140''>when</span> <span m=''2572280''>you</span>
  <span m=''2572380''>tell</span> <span m=''2572550''>somebody,</span> <span m=''2573270''>you''re</span>
  <span m=''2573490''>not</span> <span m=''2573700''>going</span> <span m=''2573840''>to</span>
  <span m=''2573890''>say,</span> <span m=''2574110''>oh,</span> <span m=''2574720''>that</span>
  <span m=''2574920''>[UNINTELLIGIBLE].</span> <span m=''2575540''>Say,</span> <span
  m=''2575730''>I</span> <span m=''2575890''>did</span> <span m=''2576170''>this</span>
  <span m=''2576370''>[UNINTELLIGIBLE],</span> <span m=''2576580''>and</span> <span
  m=''2576730''>I</span> <span m=''2576780''>did</span> <span m=''2577000''>that.</span>
  <span m=''2577620''>And</span> <span m=''2578020''>at the end,</span> <span m=''2578250''>it</span>
  <span m=''2578590''>looks</span> <span m=''2578810''>like</span> <span m=''2579190''>these</span>
  <span m=''2579420''>other</span> <span m=''2579610''>people</span> <span m=''2579870''>are</span>
  <span m=''2579950''>very</span> <span m=''2580240''>smart,</span> <span m=''2580570''>and</span>
  <span m=''2580680''>they''re</span> <span m=''2581070''>getting through</span> <span
  m=''2581260''>all</span> <span m=''2581400''>these</span> <span m=''2581570''>optimizations.</span>
  <span m=''2582450''>No,</span> <span m=''2582750''>they</span> <span m=''2582900''>spend</span>
  <span m=''2583210''>a lot</span> <span m=''2583565''>of time</span> <span m=''2584190''>going</span>
  <span m=''2584430''>through</span> <span m=''2584590''>these</span> <span m=''2585070''>dead</span>
  <span m=''2585250''>end</span> <span m=''2585390''>parts.</span> <span m=''2585930''>And</span>
  <span m=''2586720''>the</span> <span m=''2586770''>interesting</span> <span m=''2587140''>thing</span>
  <span m=''2588130''>in</span> <span m=''2588290''>here</span> <span m=''2588870''>is,</span>
  <span m=''2589650''>one</span> <span m=''2589880''>thing</span> <span m=''2590040''>is,</span>
  <span m=''2590240''>don''t</span> <span m=''2590560''>trust</span> <span m=''2590800''>anything.</span>
  <span m=''2592560''>[UNINTELLIGIBLE PHRASE]</span> <span m=''2594350''>Intel,</span>
  <span m=''2594630''>they</span> <span m=''2594770''>have</span> <span m=''2594910''>hundreds</span>
  <span m=''2595380''>of</span> <span m=''2595630''>engineers</span> <span m=''2596150''>working</span>
  <span m=''2596490''>at</span> <span m=''2596560''>it</span> <span m=''2596700''>for</span>
  <span m=''2596860''>years.</span> <span m=''2597350''>And</span> <span m=''2597500''>OK,</span>
  <span m=''2597830''>that should be good.</span> <span m=''2600425''>Not</span> <span
  m=''2600920''>really.</span> </p><p><span m=''2602210''>So</span> <span m=''2602780''>a</span>
  <span m=''2602830''>lot</span> <span m=''2603090''>of</span> <span m=''2603180''>times,</span>
  <span m=''2603440''>it''s an</span> <span m=''2603630''>end-to-end</span> <span
  m=''2603966''>thing.</span> <span m=''2605030''>With</span> <span m=''2605210''>performance,</span>
  <span m=''2605560''>it''s</span> <span m=''2605910''>end to</span> <span m=''2606080''>end.</span>
  <span m=''2606670''>So</span> <span m=''2606890''>the</span> <span m=''2606990''>problem</span>
  <span m=''2607480''>can</span> <span m=''2607730''>be at</span> <span m=''2607980''>any</span>
  <span m=''2608240''>level.</span> <span m=''2609030''>So</span> <span m=''2609160''>it</span>
  <span m=''2609260''>could</span> <span m=''2609460''>become</span> <span m=''2609830''>a</span>
  <span m=''2610130''>compiler,</span> <span m=''2610460''>it could</span> <span m=''2610610''>be</span>
  <span m=''2610870''>[UNINTELLIGIBLE]</span> <span m=''2611210''>network,</span>
  <span m=''2611370''>it can</span> <span m=''2611530''>be</span> <span m=''2612020''>network,</span>
  <span m=''2612060''>it can</span> <span m=''2612330''>be an</span> <span m=''2612540''>operating</span>
  <span m=''2612900''>system,</span> <span m=''2613510''>it</span> <span m=''2613620''>can</span>
  <span m=''2613860''>be in</span> <span m=''2614260''>the memory</span> <span m=''2614350''>system,</span>
  <span m=''2614630''>it</span> <span m=''2614910''>can be</span> <span m=''2615040''>in
  the</span> <span m=''2615200''>processor,</span> <span m=''2615640''>it can</span>
  <span m=''2615950''>be anything.</span> <span m=''2616870''>So</span> <span m=''2617020''>if</span>
  <span m=''2617120''>you</span> <span m=''2617220''>say,</span> <span m=''2617370''>oh,</span>
  <span m=''2617530''>yeah,</span> <span m=''2617800''>that shouldn''t</span> <span
  m=''2618030''>be</span> <span m=''2618190''>the</span> <span m=''2618480''>case,</span>
  <span m=''2618740''>probably</span> <span m=''2619230''>that''s</span> <span m=''2619440''>where</span>
  <span m=''2619540''>it</span> <span m=''2619790''>is.</span> <span m=''2620320''>So</span>
  <span m=''2620900''>all</span> <span m=''2621190''>the</span> <span m=''2621280''>time,</span>
  <span m=''2621500''>basically,</span> <span m=''2621740''>it''s</span> <span m=''2621910''>interesting.</span>
  </p><p><span m=''2622350''>The</span> <span m=''2622470''>nice</span> <span m=''2622730''>thing</span>
  <span m=''2622900''>about</span> <span m=''2623600''>these</span> <span m=''2623840''>kind</span>
  <span m=''2623990''>of</span> <span m=''2624100''>tools</span> <span m=''2624660''>is
  that</span> <span m=''2625070''>sometimes</span> <span m=''2626020''>even</span>
  <span m=''2626110''>the</span> <span m=''2626200''>tools</span> <span m=''2626490''>might</span>
  <span m=''2626630''>be</span> <span m=''2626770''>wrong.</span> <span m=''2628080''>So</span>
  <span m=''2628140''>sometimes</span> <span m=''2628580''>I</span> <span m=''2628640''>have</span>
  <span m=''2628910''>been in</span> <span m=''2629090''>situations</span> <span m=''2629500''>where</span>
  <span m=''2629630''>you</span> <span m=''2629700''>look</span> <span m=''2629870''>have
  to</span> <span m=''2629960''>look at</span> <span m=''2630040''>the</span> <span
  m=''2630295''>wall clock,</span> <span m=''2630550''>OK,</span> <span m=''2630700''>wait
  a minute,</span> <span m=''2630890''>does</span> <span m=''2631380''>the</span>
  <span m=''2631450''>tool</span> <span m=''2631900''>say</span> <span m=''2632050''>what</span>
  <span m=''2632220''>I</span> <span m=''2632460''>actually</span> <span m=''2632650''>see</span>
  <span m=''2632920''>what''s</span> <span m=''2633080''>happening?</span> <span m=''2633840''>Because</span>
  <span m=''2635060''>you</span> <span m=''2635700''>get</span> <span m=''2635900''>into</span>
  <span m=''2636230''>very</span> <span m=''2636510''>skeptical</span> <span m=''2636920''>situations.</span>
  <span m=''2637450''>Because</span> <span m=''2637890''>a</span> <span m=''2638230''>lot</span>
  <span m=''2638400''>of</span> <span m=''2638520''>times,</span> <span m=''2638850''>in</span>
  <span m=''2638960''>these</span> <span m=''2639180''>kind</span> <span m=''2639290''>of</span>
  <span m=''2639400''>situations,</span> <span m=''2640870''>the</span> <span m=''2640960''>problem</span>
  <span m=''2641450''>can</span> <span m=''2641710''>be</span> <span m=''2641830''>hidden</span>
  <span m=''2642250''>in</span> <span m=''2642410''>many</span> <span m=''2642620''>different</span>
  <span m=''2642970''>things.</span> <span m=''2643140''>So</span> <span m=''2643260''>that''s</span>
  <span m=''2643640''>a</span> <span m=''2644140''>very</span> <span m=''2644390''>good</span>
  <span m=''2644680''>way</span> <span m=''2645060''>of</span> <span m=''2645670''>going</span>
  <span m=''2645800''>through</span> <span m=''2646090''>this.</span> <span m=''2646500''>Of</span>
  <span m=''2646620''>course,</span> <span m=''2647260''>what</span> <span m=''2647420''>you</span>
  <span m=''2647580''>get</span> <span m=''2648100''>handed</span> <span m=''2648480''>to</span>
  <span m=''2648760''>you,</span> <span m=''2649040''>we</span> <span m=''2649260''>have</span>
  <span m=''2649920''>set</span> <span m=''2650130''>it</span> <span m=''2650240''>up</span>
  <span m=''2650360''>in</span> <span m=''2650520''>a</span> <span m=''2650550''>way</span>
  <span m=''2650690''>that</span> <span m=''2651010''>there</span> <span m=''2651130''>cannot
  be</span> <span m=''2651610''>too many</span> <span m=''2651860''>surprises.</span>
  </p><p><span m=''2652660''>But</span> <span m=''2653350''>when</span> <span m=''2653500''>you''re</span>
  <span m=''2653620''>going</span> <span m=''2653770''>through</span> <span m=''2654190''>a</span>
  <span m=''2654240''>system</span> <span m=''2654670''>and try to</span> <span m=''2654950''>optimize</span>
  <span m=''2655530''>and</span> <span m=''2656070''>look</span> <span m=''2656270''>at</span>
  <span m=''2656380''>performance,</span> <span m=''2657340''>this</span> <span m=''2657550''>is</span>
  <span m=''2657680''>a</span> <span m=''2657730''>really</span> <span m=''2657940''>good</span>
  <span m=''2658120''>way</span> <span m=''2658200''>of</span> <span m=''2658340''>doing</span>
  <span m=''2658590''>it,</span> <span m=''2658660''>because</span> <span m=''2658950''>I</span>
  <span m=''2659050''>don''t</span> <span m=''2659250''>think</span> <span m=''2659640''>these</span>
  <span m=''2659960''>guys</span> <span m=''2660450''>thought,</span> <span m=''2660940''>when</span>
  <span m=''2661080''>they</span> <span m=''2661190''>started,</span> <span m=''2661750''>they''d</span>
  <span m=''2661910''>be</span> <span m=''2662030''>looking</span> <span m=''2662350''>at</span>
  <span m=''2662470''>compiled</span> <span m=''2662800''>bugs</span> <span m=''2663310''>or</span>
  <span m=''2663580''>compiler</span> <span m=''2663810''>problems.</span> <span m=''2665750''>They</span>
  <span m=''2665870''>were</span> <span m=''2665970''>thinking</span> <span m=''2666310''>about,</span>
  <span m=''2666760''>OK,</span> <span m=''2667080''>I''m</span> <span m=''2667210''>going</span>
  <span m=''2667360''>to do</span> <span m=''2668170''>a</span> <span m=''2668380''>little
  bit of</span> <span m=''2668600''>code</span> <span m=''2668860''>rewriting</span>
  <span m=''2669270''>and</span> <span m=''2669420''>get</span> <span m=''2669620''>there.</span>
  <span m=''2669770''>But</span> <span m=''2669940''>at</span> <span m=''2670070''>the</span>
  <span m=''2670160''>end</span> <span m=''2670250''>of</span> <span m=''2670340''>the</span>
  <span m=''2670430''>day,</span> <span m=''2670890''>what</span> <span m=''2671160''>they</span>
  <span m=''2671260''>disclosed</span> <span m=''2671575''>was</span> <span m=''2671890''>very</span>
  <span m=''2672080''>surprising</span> <span m=''2672480''>to</span> <span m=''2672710''>them.</span>
  <span m=''2672930''>And</span> <span m=''2672980''>it</span> <span m=''2673300''>even</span>
  <span m=''2673440''>surprised</span> <span m=''2673620''>me</span> <span m=''2673960''>today.</span>
  </p><p><span m=''2674470''>GUEST SPEAKER 2: Our</span> <span m=''2674580''>plan</span>
  <span m=''2674940''>basically</span> <span m=''2675400''>ended</span> <span m=''2675700''>at</span>
  <span m=''2675870''>row</span> <span m=''2676120''>three,</span> <span m=''2676500''>as</span>
  <span m=''2676660''>far</span> <span m=''2676860''>as</span> <span m=''2676950''>when</span>
  <span m=''2677070''>we</span> <span m=''2677190''>first</span> <span m=''2677480''>set</span>
  <span m=''2677670''>out.</span> <span m=''2678110''>We</span> <span m=''2678290''>had</span>
  <span m=''2678470''>no</span> <span m=''2678630''>idea</span> <span m=''2679000''>was</span>
  <span m=''2679200''>to</span> <span m=''2679320''>follow</span> <span m=''2679670''>after</span>
  <span m=''2679930''>that.</span> <span m=''2680690''>So</span> <span m=''2681190''>one</span>
  <span m=''2681390''>thing</span> <span m=''2681560''>that</span> <span m=''2681680''>I</span>
  <span m=''2681750''>remember</span> <span m=''2682300''>is</span> <span m=''2682540''>that</span>
  <span m=''2683140''>some</span> <span m=''2683430''>students</span> <span m=''2684160''>came</span>
  <span m=''2684420''>to</span> <span m=''2684600''>us</span> <span m=''2684840''>and</span>
  <span m=''2684990''>asked</span> <span m=''2685220''>questions,</span> <span m=''2685950''>like,</span>
  <span m=''2686090''>yeah,</span> <span m=''2686300''>I</span> <span m=''2686400''>tried</span>
  <span m=''2686630''>to</span> <span m=''2686740''>implement</span> <span m=''2687150''>this</span>
  <span m=''2687520''>bit</span> <span m=''2687860''>hack here,</span> <span m=''2688120''>and</span>
  <span m=''2688270''>it</span> <span m=''2688410''>actually</span> <span m=''2688710''>slowed</span>
  <span m=''2689030''>the</span> <span m=''2689100''>program</span> <span m=''2689510''>down.</span>
  <span m=''2690580''>Or</span> <span m=''2692460''>I</span> <span m=''2693400''>changed</span>
  <span m=''2693830''>my</span> <span m=''2693970''>pentomino</span> <span m=''2694340''>board</span>
  <span m=''2694590''>representation</span> <span m=''2695330''>to</span> <span m=''2695430''>this</span>
  <span m=''2695730''>also.</span> <span m=''2696440''>But</span> <span m=''2696660''>it</span>
  <span m=''2696760''>didn''t</span> <span m=''2697010''>seem</span> <span m=''2697140''>to</span>
  <span m=''2697250''>speed</span> <span m=''2697500''>anything</span> <span m=''2697900''>up.</span>
  <span m=''2698690''>Well,</span> <span m=''2699120''>in</span> <span m=''2699320''>those</span>
  <span m=''2699530''>cases,</span> <span m=''2699785''>yeah,</span> <span m=''2700040''>you</span>
  <span m=''2700410''>need</span> <span m=''2700590''>to</span> <span m=''2700690''>do</span>
  <span m=''2700880''>more</span> <span m=''2701090''>detective</span> <span m=''2701540''>work</span>
  <span m=''2701790''>to</span> <span m=''2702040''>figure</span> <span m=''2702300''>out</span>
  <span m=''2702450''>what</span> <span m=''2702620''>happened.</span> </p><p><span
  m=''2703930''>SAMAN AMARASINGHE: So</span> <span m=''2704110''>a</span> <span m=''2704370''>lot
  of</span> <span m=''2704870''>times,</span> <span m=''2705140''>the</span> <span
  m=''2705220''>performance</span> <span m=''2705890''>is</span> <span m=''2705990''>something</span>
  <span m=''2706480''>like</span> <span m=''2707155''>a</span> <span m=''2707410''>max</span>
  <span m=''2707695''>of</span> <span m=''2707980''>a</span> <span m=''2708090''>bunch</span>
  <span m=''2708610''>of</span> <span m=''2708730''>different</span> <span m=''2709120''>things.</span>
  <span m=''2709790''>So</span> <span m=''2709900''>you</span> <span m=''2709990''>have</span>
  <span m=''2710200''>done</span> <span m=''2710420''>something,</span> <span m=''2710740''>that''s</span>
  <span m=''2711010''>great.</span> <span m=''2711930''>It</span> <span m=''2712180''>should</span>
  <span m=''2712410''>give</span> <span m=''2712550''>you a huge</span> <span m=''2712900''>performance</span>
  <span m=''2713400''>improvement.</span> <span m=''2713880''>But</span> <span m=''2714050''>something</span>
  <span m=''2714460''>is</span> <span m=''2714590''>holding.</span> <span m=''2715380''>And</span>
  <span m=''2715550''>a lot</span> <span m=''2715730''>of times,</span> <span m=''2715880''>you</span>
  <span m=''2716020''>have to do</span> <span m=''2716380''>three</span> <span m=''2716570''>or</span>
  <span m=''2716930''>four</span> <span m=''2717200''>things.</span> <span m=''2717590''>And</span>
  <span m=''2717740''>once</span> <span m=''2718070''>you</span> <span m=''2718240''>do</span>
  <span m=''2718400''>three</span> <span m=''2718720''>or four</span> <span m=''2718870''>things,</span>
  <span m=''2719100''>suddenly</span> <span m=''2719520''>everything</span> <span
  m=''2720130''>starts</span> <span m=''2720440''>kicking</span> <span m=''2720770''>off.</span>
  </p><p><span m=''2723430''>A</span> <span m=''2723750''>good</span> <span m=''2723960''>example</span>
  <span m=''2724220''>is</span> <span m=''2724480''>loop</span> <span m=''2724850''>unroll.</span>
  <span m=''2724970''>You</span> <span m=''2725120''>unroll</span> <span m=''2725340''>a</span>
  <span m=''2725370''>loop</span> <span m=''2725610''>and say,</span> <span m=''2725905''>ha,</span>
  <span m=''2726200''>I should</span> <span m=''2726280''>get</span> <span m=''2726480''>all</span>
  <span m=''2726640''>this</span> <span m=''2726830''>parallelism.</span> <span m=''2726990''>No,</span>
  <span m=''2727800''>because</span> <span m=''2728240''>you have some</span> <span
  m=''2728470''>dependence.</span> <span m=''2729290''>So</span> <span m=''2729550''>you</span>
  <span m=''2729680''>have to</span> <span m=''2729800''>fix</span> <span m=''2730050''>that</span>
  <span m=''2730220''>dependence,</span> <span m=''2730495''>fix</span> <span m=''2730770''>that</span>
  <span m=''2730990''>dependence.</span> <span m=''2731320''>Suddenly,</span> <span
  m=''2731950''>you</span> <span m=''2732225''>remove</span> <span m=''2732500''>everything.</span>
  <span m=''2733470''>Then</span> <span m=''2733830''>you</span> <span m=''2733930''>get</span>
  <span m=''2734090''>all</span> <span m=''2734210''>the</span> <span m=''2734330''>parallelism</span>
  <span m=''2734730''>and</span> <span m=''2734930''>start</span> <span m=''2735190''>running</span>
  <span m=''2735450''>fast.</span> <span m=''2736050''>So</span> <span m=''2736260''>a</span>
  <span m=''2736450''>lot</span> <span m=''2736690''>of</span> <span m=''2736790''>these</span>
  <span m=''2737020''>things,</span> <span m=''2737300''>it''s</span> <span m=''2737460''>basically</span>
  <span m=''2738060''>max.</span> <span m=''2738400''>You have</span> <span m=''2738560''>to</span>
  <span m=''2738610''>get</span> <span m=''2738790''>all</span> <span m=''2739100''>the</span>
  <span m=''2739200''>things</span> <span m=''2739530''>right.</span> <span m=''2740200''>And</span>
  <span m=''2740520''>so</span> <span m=''2740680''>if</span> <span m=''2740820''>you</span>
  <span m=''2740950''>stop</span> <span m=''2741360''>halfway</span> <span m=''2741790''>through,</span>
  <span m=''2742410''>that</span> <span m=''2742530''>means</span> <span m=''2742730''>you</span>
  <span m=''2742820''>might</span> <span m=''2742970''>be</span> <span m=''2743040''>almost</span>
  <span m=''2743470''>there,</span> <span m=''2743960''>and</span> <span m=''2744600''>you
  are</span> <span m=''2744830''>not</span> <span m=''2745110''>up</span> <span m=''2745300''>to</span>
  <span m=''2745420''>that.</span> <span m=''2745540''>So</span> <span m=''2745630''>that''s</span>
  <span m=''2745880''>why</span> <span m=''2746560''>it</span> <span m=''2746910''>just</span>
  <span m=''2747740''>can</span> <span m=''2747980''>be a really</span> <span m=''2748210''>frustrating</span>
  <span m=''2748700''>process.</span> <span m=''2749760''>But</span> <span m=''2750270''>it''s</span>
  <span m=''2750480''>kind of</span> <span m=''2750620''>fun, too,</span> <span m=''2750830''>when
  you</span> <span m=''2751030''>get</span> <span m=''2751330''>there.</span> </p>'
uid: 84db1d9f-869f-26cc-f9f2-5c7528d921d4
---
